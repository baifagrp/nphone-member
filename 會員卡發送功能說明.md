# 📤 會員卡發送功能說明

## ✨ 功能概述

會員可以一鍵將自己的會員卡（包含條碼、儲值金、積分）以 Flex Message 形式發送到 LINE 聊天室，方便隨時查看和使用。

---

## 🎯 功能特色

### 1. **一鍵發送** ✅
- 點擊按鈕自動發送
- 無需手動輸入資料
- 即時生成會員卡

### 2. **精美的 Flex Message 卡片** ✨
```
┌─────────────────────────────┐
│      NPHONE  會員卡          │ ← 紫色標題
├─────────────────────────────┤
│  會員姓名     葉瑞恩          │
│  會員編號     M12345          │
├─────────────────────────────┤
│      會員條碼                │
│  ┃┃┃ ┃┃ ┃┃┃ ┃┃ ┃┃┃        │ ← 條碼圖片
│  請在結帳時出示此條碼          │
├─────────────────────────────┤
│  💰 儲值金    NT$ 1,250      │
│  ⭐ 積分      580 點          │
├─────────────────────────────┤
│      感謝您的支持！           │
│      NPHONE ❤️               │
└─────────────────────────────┘
```

### 3. **包含完整資訊** 📊
- ✅ 會員姓名
- ✅ 會員編號
- ✅ 會員條碼（可掃描）
- ✅ 儲值金餘額
- ✅ 積分餘額

### 4. **自動關閉視窗** 🔄
- 發送成功後自動關閉
- 流暢的用戶體驗

---

## 🔄 使用流程

### 會員端操作

```
1. 登入會員專區
   ↓
2. 在個人資料頁面
   ↓
3. 找到「會員條碼」區塊
   ↓
4. 點擊「📤 發送會員卡到 LINE」按鈕
   ↓
5. 系統自動跳轉到 LIFF 頁面
   ↓
6. 自動載入會員資訊
   ↓
7. 生成會員條碼
   ↓
8. 創建 Flex Message
   ↓
9. 發送到 LINE 聊天室
   ↓
10. 顯示成功訊息
   ↓
11. 自動關閉視窗
   ↓
12. 在 LINE 聊天室查看會員卡 ✅
```

---

## 🛠️ 技術實作

### 1. **LIFF 頁面** (`member/send-member-card.html`)

#### 核心功能：
```javascript
// 1. 初始化 LIFF
await liff.init({ liffId: CONFIG.LIFF_ID });

// 2. 取得用戶 Profile
const profile = await liff.getProfile();
const lineUserId = profile.userId;

// 3. 從資料庫取得完整會員資訊
const { data: memberData } = await getSupabase()
    .from('members')
    .select('*')
    .eq('line_user_id', lineUserId)
    .single();

// 4. 取得儲值金和積分
const { data: walletData } = await getSupabase()
    .from('wallets')
    .select('balance')
    .eq('member_id', memberData.id)
    .single();

const { data: pointsData } = await getSupabase()
    .from('points')
    .select('balance')
    .eq('member_id', memberData.id)
    .single();

// 5. 生成條碼圖片
const barcodeImageUrl = generateBarcodeSVG(memberData.member_code);

// 6. 創建 Flex Message
const flexMessage = createMemberCardFlexMessage(memberData, barcodeImageUrl);

// 7. 發送訊息
await liff.sendMessages([flexMessage]);

// 8. 關閉視窗
liff.closeWindow();
```

---

### 2. **條碼生成**

使用 JsBarcode 生成 CODE128 條碼：

```javascript
function generateBarcodeSVG(memberCode) {
    const canvas = document.createElement('canvas');
    
    JsBarcode(canvas, memberCode, {
        format: "CODE128",
        width: 3,
        height: 80,
        displayValue: true,
        fontSize: 16,
        margin: 10
    });
    
    // 轉換為 Base64 URL
    return canvas.toDataURL('image/png');
}
```

**注意事項：**
- ✅ 條碼必須是 Base64 格式的圖片 URL
- ✅ LINE Flex Message 支援 `data:image/png;base64,...` 格式
- ✅ 條碼需要足夠清晰以便掃描

---

### 3. **Flex Message 結構**

```json
{
  "type": "flex",
  "altText": "🎫 我的 NPHONE 會員卡",
  "contents": {
    "type": "bubble",
    "size": "mega",
    "header": {
      // 紫色標題區
      "backgroundColor": "#667eea"
    },
    "body": {
      // 主要內容
      // - 會員資訊
      // - 條碼圖片
      // - 餘額資訊
    },
    "footer": {
      // 底部訊息
    }
  }
}
```

---

### 4. **觸發按鈕** (`member/profile.html`)

```javascript
document.getElementById('btn-send-card').addEventListener('click', () => {
    const liffUrl = `https://liff.line.me/${CONFIG.LIFF_ID}/member/send-member-card.html`;
    
    if (typeof liff !== 'undefined' && liff.isInClient()) {
        // 在 LINE 內，直接開啟
        window.location.href = liffUrl;
    } else {
        // 在外部瀏覽器，提示用戶
        UI.info('請在 LINE 中開啟此功能');
    }
});
```

---

## 📱 LIFF 設置

### 在 LINE Developers Console 中設置

1. **登入 LINE Developers Console**
   - https://developers.line.biz/console/

2. **選擇您的 Channel**
   - Messaging API Channel

3. **進入 LIFF 設置**
   - LIFF → Add

4. **新增 LIFF App**
   ```
   LIFF app name: 發送會員卡
   Size: Full
   Endpoint URL: https://your-domain.com/member/send-member-card.html
   Scope: profile, openid
   ```

5. **取得 LIFF ID**
   - 格式：`1234567890-abcdefgh`
   - 更新到 `js/config.js` 的 `LIFF_ID`

---

## 🎨 Flex Message 設計特色

### 視覺層次
- 🎨 **紫色漸層標題**（#667eea）
- 📊 **清晰的資訊區塊**
- 🎯 **重要資訊加粗**

### 資訊對齊
- 📋 欄位名稱靠左
- 📌 數值靠右
- 🎨 統一間距

### 條碼顯示
- 🖼️ 高品質圖片
- 📏 適當的大小比例（3:1）
- 💡 清楚的使用說明

### 餘額展示
- 💰 儲值金（紅色，#ff6b6b）
- ⭐ 積分（金色，#ffd93d）
- 📊 即時數據

---

## 🔒 安全性

### 權限檢查
- ✅ 必須在 LIFF 環境中執行
- ✅ 需要 LINE 登入
- ✅ 只能發送自己的會員卡
- ✅ 使用 `line_user_id` 驗證身份

### 資料保護
- ✅ 不儲存敏感資料
- ✅ 即時從資料庫取得最新資訊
- ✅ 條碼圖片不上傳伺服器（客戶端生成）

---

## 📊 狀態顯示

發送過程中會顯示不同的狀態：

### 1. 初始化中 🔄
```
🔄 初始化中...
正在連接 LINE
```

### 2. 載入會員資訊 👤
```
👤 載入會員資訊...
正在取得您的資料
```

### 3. 載入餘額 💰
```
💰 載入餘額資訊...
正在取得儲值金與積分
```

### 4. 生成條碼 📊
```
📊 生成條碼...
正在製作您的會員卡
```

### 5. 發送中 📤
```
📤 發送會員卡...
正在發送到聊天室
```

### 6. 成功 ✅
```
✅ 會員卡已發送！
視窗即將關閉...
```

### 7. 失敗 ❌
```
❌ 發送失敗
[錯誤訊息]
```

---

## 🧪 測試步驟

### 測試 1：基本發送功能

1. 會員登入系統
2. 進入個人資料頁面
3. 確認有會員編號和條碼
4. 點擊「📤 發送會員卡到 LINE」
5. ✅ 跳轉到 LIFF 頁面
6. ✅ 顯示載入狀態
7. ✅ 會員卡發送到 LINE
8. ✅ 視窗自動關閉
9. ✅ 在 LINE 聊天室看到會員卡

---

### 測試 2：會員卡內容正確性

檢查 Flex Message 中的資訊：
- ✅ 會員姓名正確
- ✅ 會員編號正確
- ✅ 條碼可掃描
- ✅ 儲值金餘額正確
- ✅ 積分餘額正確

---

### 測試 3：沒有會員編號

1. 使用沒有會員編號的帳號
2. 點擊發送按鈕
3. ✅ 顯示錯誤訊息：「您還沒有會員編號，請聯繫商家設定」

---

### 測試 4：在外部瀏覽器

1. 在 Chrome/Safari 開啟個人資料頁面
2. 點擊發送按鈕
3. ✅ 顯示提示：「請在 LINE 中開啟此功能」

---

## 🐛 常見問題

### Q1: 點擊按鈕沒有反應？

**可能原因：**
- LIFF ID 未設定或錯誤
- 不在 LINE 環境中

**解決方法：**
1. 檢查 `js/config.js` 中的 `LIFF_ID`
2. 確認在 LINE 中開啟

---

### Q2: 發送失敗？

**可能原因：**
- 沒有會員編號
- 網路連線問題
- LIFF 權限不足

**解決方法：**
1. 確認會員編號已設定
2. 檢查網路連線
3. 重新授權 LIFF

---

### Q3: 條碼無法掃描？

**可能原因：**
- 條碼生成失敗
- 圖片解析度不足

**解決方法：**
1. 檢查 JsBarcode 參數
2. 增加條碼寬度和高度
3. 確保圖片清晰

---

### Q4: 餘額顯示 0？

**可能原因：**
- 資料庫中無儲值金或積分記錄

**解決方法：**
1. 檢查 `wallets` 和 `points` 表
2. 確認 `member_id` 關聯正確

---

## 📝 檔案清單

### 新增檔案
- ✅ `member/send-member-card.html` - LIFF 發送頁面
- ✅ `會員卡發送功能說明.md` - 功能說明

### 修改檔案
- ✅ `member/profile.html` - 新增發送按鈕

---

## 🎯 未來增強

### 可能的改進

1. **分享功能** 📤
   - 將會員卡分享給其他人
   - 產生邀請連結

2. **自訂樣式** 🎨
   - 不同會員等級不同顏色
   - 節日特殊主題

3. **更多資訊** 📊
   - 顯示會員等級
   - 顯示累計消費
   - 顯示可用票券數量

4. **快速捷徑** ⚡
   - Rich Menu 整合
   - 快速訪問按鈕

---

## 🎉 完成！

會員卡發送功能已完整實作：
- ✨ 一鍵發送到 LINE
- 🎨 精美的 Flex Message 卡片
- 📊 包含完整會員資訊
- 🔄 自動關閉視窗

會員現在可以隨時將會員卡發送到 LINE，方便查看和使用！😊

