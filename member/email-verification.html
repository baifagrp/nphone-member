<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email é©—è­‰ - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/animations.css">
    <style>
        .verification-container {
            max-width: 480px;
            margin: 60px auto;
            padding: 0 20px;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }
        
        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-border);
            transition: all 0.3s;
        }
        
        .step-dot.active {
            width: 24px;
            border-radius: 5px;
            background: var(--color-primary);
        }
        
        .verification-code-input {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 24px 0;
        }
        
        .code-digit {
            width: 50px;
            height: 60px;
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            border: 2px solid var(--color-border);
            border-radius: var(--radius);
            transition: all 0.3s;
        }
        
        .code-digit:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(200, 164, 138, 0.1);
        }
        
        .countdown-timer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 16px;
        }
        
        .countdown-timer.warning {
            color: var(--color-error);
            font-weight: 600;
        }
    </style>
</head>
<body class="ds-page">
    <div class="verification-container">
        <!-- Logo -->
        <div style="text-align: center; margin-bottom: 32px;">
            <h1 style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
                NPHONE
            </h1>
            <p style="color: var(--text-secondary); font-size: 14px;">æœƒå“¡è¨»å†Š</p>
        </div>
        
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
            <div class="step-dot" id="step-1"></div>
            <div class="step-dot active" id="step-2"></div>
            <div class="step-dot" id="step-3"></div>
        </div>
        
        <!-- æ­¥é©Ÿ 1: è¼¸å…¥ Email -->
        <div id="step-email" class="ds-card" style="display: none;">
            <div class="ds-card-body">
                <h2 class="ds-card-title" style="text-align: center; margin-bottom: 8px;">
                    è¼¸å…¥æ‚¨çš„ Email
                </h2>
                <p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">
                    æˆ‘å€‘å°‡ç™¼é€é©—è­‰ç¢¼åˆ°æ‚¨çš„ä¿¡ç®±
                </p>
                
                <div class="ds-form-group">
                    <label for="email-input" class="ds-form-label">Email åœ°å€</label>
                    <input 
                        type="email" 
                        id="email-input" 
                        class="ds-form-input" 
                        placeholder="your@email.com"
                        required
                    >
                    <div id="email-hint" class="ds-form-hint" style="display: none;"></div>
                </div>
                
                <button id="btn-send-code" class="ds-btn ds-btn-primary" style="width: 100%;">
                    ç™¼é€é©—è­‰ç¢¼
                </button>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 2: è¼¸å…¥é©—è­‰ç¢¼ -->
        <div id="step-verification" class="ds-card">
            <div class="ds-card-body">
                <h2 class="ds-card-title" style="text-align: center; margin-bottom: 8px;">
                    è¼¸å…¥é©—è­‰ç¢¼
                </h2>
                <p style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;">
                    æˆ‘å€‘å·²ç™¼é€é©—è­‰ç¢¼åˆ°<br>
                    <strong id="email-display"></strong>
                </p>
                
                <!-- é©—è­‰ç¢¼è¼¸å…¥æ¡† -->
                <div class="verification-code-input">
                    <input type="text" class="code-digit" maxlength="1" data-index="0">
                    <input type="text" class="code-digit" maxlength="1" data-index="1">
                    <input type="text" class="code-digit" maxlength="1" data-index="2">
                    <input type="text" class="code-digit" maxlength="1" data-index="3">
                    <input type="text" class="code-digit" maxlength="1" data-index="4">
                    <input type="text" class="code-digit" maxlength="1" data-index="5">
                </div>
                
                <!-- å€’æ•¸è¨ˆæ™‚ -->
                <div class="countdown-timer" id="countdown-display">
                    é©—è­‰ç¢¼å°‡åœ¨ <strong>10:00</strong> å¾ŒéæœŸ
                </div>
                
                <div style="margin-top: 24px; text-align: center;">
                    <button id="btn-resend-code" class="ds-btn ds-btn-secondary" style="width: 100%;" disabled>
                        é‡æ–°ç™¼é€é©—è­‰ç¢¼ (<span id="resend-countdown">60</span>)
                    </button>
                </div>
                
                <div style="margin-top: 16px; text-align: center;">
                    <button id="btn-change-email" class="ds-link">
                        ä¿®æ”¹ Email
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 3: å®Œæˆ -->
        <div id="step-complete" class="ds-card" style="display: none;">
            <div class="ds-card-body" style="text-align: center; padding: 48px 24px;">
                <div style="font-size: 64px; margin-bottom: 16px;">âœ…</div>
                <h2 class="ds-card-title" style="margin-bottom: 8px;">
                    è¨»å†ŠæˆåŠŸï¼
                </h2>
                <p id="complete-message" style="color: var(--text-secondary); margin-bottom: 24px;">
                    æ­¡è¿åŠ å…¥ NPHONE
                </p>
                
                <button id="btn-go-home" class="ds-btn ds-btn-primary" style="width: 100%;">
                    å‰å¾€é¦–é 
                </button>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="toast-container"></div>

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/email-verification.js"></script>
    <script src="../js/animation-utils.js"></script>
    
    <script>
        let currentEmail = '';
        let lineUserId = '';
        let lineDisplayName = '';
        let linePictureUrl = '';
        let verificationCountdown = 600; // 10 åˆ†é˜
        let resendCountdown = 60; // 60 ç§’å¾Œå¯é‡æ–°ç™¼é€
        let countdownInterval = null;
        let resendInterval = null;
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // å¾ URL æˆ– sessionStorage ç²å– LINE è³‡è¨Š
            const params = new URLSearchParams(window.location.search);
            lineUserId = params.get('line_user_id') || sessionStorage.getItem('temp_line_user_id');
            lineDisplayName = params.get('line_display_name') || sessionStorage.getItem('temp_line_display_name');
            linePictureUrl = params.get('line_picture_url') || sessionStorage.getItem('temp_line_picture_url');
            
            // åˆ¤æ–·æ˜¯ LIFF æ¨¡å¼é‚„æ˜¯ç¶²é æ¨¡å¼
            const isLiffMode = sessionStorage.getItem('liff_mode') === 'true' || !!lineUserId;
            
            if (isLiffMode) {
                CONFIG.log('ğŸ“± LIFF æ¨¡å¼ï¼šLINE ç™»å…¥ + Email é©—è­‰');
                // LIFF æ¨¡å¼éœ€è¦ LINE user id
                if (!lineUserId) {
                    UI.error('ç¼ºå°‘ LINE ç™»å…¥è³‡è¨Šï¼Œè«‹é‡æ–°ç™»å…¥');
                    setTimeout(() => {
                        window.location.href = '../index.html';
                    }, 2000);
                    return;
                }
                // æ›´æ–°é é¢æ¨™é¡Œ
                document.querySelector('body > div > div:nth-child(1) > p').textContent = 'LINE å¸³è™Ÿç¶å®š';
            } else {
                CONFIG.log('ğŸŒ ç¶²é æ¨¡å¼ï¼šEmail ç™»å…¥/è¨»å†Š');
                // ç¶²é æ¨¡å¼ä¸éœ€è¦ LINE user id
                // æ›´æ–°é é¢æ¨™é¡Œ
                document.querySelector('body > div > div:nth-child(1) > p').textContent = 'Email ç™»å…¥/è¨»å†Š';
            }
            
            // åˆå§‹åŒ– EmailJS
            if (typeof emailjs !== 'undefined' && CONFIG.EMAILJS_PUBLIC_KEY) {
                emailjs.init(CONFIG.EMAILJS_PUBLIC_KEY);
            }
            
            // ç¶å®šäº‹ä»¶
            setupEventListeners();
            
            // é¡¯ç¤º Email è¼¸å…¥æ­¥é©Ÿ
            showStep('email');
        });
        
        function setupEventListeners() {
            // ç™¼é€é©—è­‰ç¢¼
            document.getElementById('btn-send-code').addEventListener('click', sendVerificationCode);
            
            // Email è¼¸å…¥æ™‚æª¢æŸ¥
            document.getElementById('email-input').addEventListener('input', (e) => {
                const email = e.target.value;
                const isValid = EmailVerificationAPI.isValidEmail(email);
                const hintEl = document.getElementById('email-hint');
                
                if (email && !isValid) {
                    hintEl.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€';
                    hintEl.style.display = 'block';
                    hintEl.style.color = 'var(--color-error)';
                } else {
                    hintEl.style.display = 'none';
                }
            });
            
            // é©—è­‰ç¢¼è¼¸å…¥è‡ªå‹•è·³è½‰
            document.querySelectorAll('.code-digit').forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1) {
                        // è‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹
                        const nextInput = document.querySelector(`.code-digit[data-index="${index + 1}"]`);
                        if (nextInput) {
                            nextInput.focus();
                        } else {
                            // æœ€å¾Œä¸€å€‹ï¼Œè‡ªå‹•é©—è­‰
                            verifyCode();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '') {
                        // åˆªé™¤éµè·³åˆ°ä¸Šä¸€å€‹
                        const prevInput = document.querySelector(`.code-digit[data-index="${index - 1}"]`);
                        if (prevInput) {
                            prevInput.focus();
                        }
                    }
                });
                
                // åªå…è¨±æ•¸å­—
                input.addEventListener('keypress', (e) => {
                    if (!/[0-9]/.test(e.key)) {
                        e.preventDefault();
                    }
                });
            });
            
            // é‡æ–°ç™¼é€é©—è­‰ç¢¼
            document.getElementById('btn-resend-code').addEventListener('click', resendCode);
            
            // ä¿®æ”¹ Email
            document.getElementById('btn-change-email').addEventListener('click', () => {
                showStep('email');
                document.getElementById('email-input').value = currentEmail;
            });
            
            // å‰å¾€é¦–é ï¼ˆæª¢æŸ¥æ˜¯å¦éœ€è¦è£œå……è³‡æ–™ï¼‰
            document.getElementById('btn-go-home').addEventListener('click', async () => {
                // æª¢æŸ¥æ˜¯å¦éœ€è¦è£œå……è³‡æ–™
                const session = Auth.getMemberSession();
                if (session && session.member) {
                    // æª¢æŸ¥æ˜¯å¦æœ‰é›»è©±è™Ÿç¢¼ï¼ˆå¿…å¡«è³‡æ–™ï¼‰
                    if (!session.member.phone) {
                        window.location.href = 'setup.html';
                    } else {
                        window.location.href = 'profile.html';
                    }
                } else {
                    window.location.href = 'profile.html';
                }
            });
        }
        
        function showStep(step) {
            document.getElementById('step-email').style.display = 'none';
            document.getElementById('step-verification').style.display = 'none';
            document.getElementById('step-complete').style.display = 'none';
            
            document.getElementById('step-1').classList.remove('active');
            document.getElementById('step-2').classList.remove('active');
            document.getElementById('step-3').classList.remove('active');
            
            if (step === 'email') {
                document.getElementById('step-email').style.display = 'block';
                document.getElementById('step-1').classList.add('active');
            } else if (step === 'verification') {
                document.getElementById('step-verification').style.display = 'block';
                document.getElementById('step-2').classList.add('active');
                document.getElementById('email-display').textContent = currentEmail;
                startCountdown();
                startResendCountdown();
            } else if (step === 'complete') {
                document.getElementById('step-complete').style.display = 'block';
                document.getElementById('step-3').classList.add('active');
                stopCountdown();
            }
        }
        
        async function sendVerificationCode() {
            const email = document.getElementById('email-input').value.trim();
            
            if (!email) {
                UI.warning('è«‹è¼¸å…¥ Email');
                return;
            }
            
            if (!EmailVerificationAPI.isValidEmail(email)) {
                UI.error('Email æ ¼å¼ä¸æ­£ç¢º');
                return;
            }
            
            try {
                UI.showLoading('æª¢æŸ¥ Email...');
                
                // 1. æª¢æŸ¥ Email æ˜¯å¦å·²å­˜åœ¨
                const emailExists = await EmailVerificationAPI.checkEmailExists(email);
                currentEmail = email;
                
                if (emailExists) {
                    CONFIG.log('ğŸ“§ Email å·²è¨»å†Šï¼ŒåŸ·è¡Œç™»å…¥æµç¨‹');
                    UI.hideLoading();
                    UI.info('æ­¤ Email å·²è¨»å†Šï¼Œè«‹è¼¸å…¥é©—è­‰ç¢¼ç™»å…¥');
                } else {
                    CONFIG.log('ğŸ“§ Email æœªè¨»å†Šï¼ŒåŸ·è¡Œè¨»å†Šæµç¨‹');
                    UI.hideLoading();
                    UI.info('æ­¤ Email å°šæœªè¨»å†Šï¼Œè«‹è¼¸å…¥é©—è­‰ç¢¼å®Œæˆè¨»å†Š');
                }
                
                // 2. ç™¼é€é©—è­‰ç¢¼ï¼ˆç„¡è«–ç™»å…¥æˆ–è¨»å†Šéƒ½éœ€è¦ï¼‰
                UI.showLoading('ç™¼é€é©—è­‰ç¢¼ä¸­...');
                await EmailVerificationAPI.sendVerificationCode(email, lineUserId);
                
                UI.hideLoading();
                UI.success('é©—è­‰ç¢¼å·²ç™¼é€ï¼');
                
                showStep('verification');
                
                // èšç„¦ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
                document.querySelector('.code-digit[data-index="0"]').focus();
                
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('âŒ ç™¼é€é©—è­‰ç¢¼å¤±æ•—', error);
                UI.error(error.message || 'ç™¼é€é©—è­‰ç¢¼å¤±æ•—');
            }
        }
        
        async function verifyCode() {
            const digits = Array.from(document.querySelectorAll('.code-digit'));
            const code = digits.map(d => d.value).join('');
            
            if (code.length !== 6) {
                return;
            }
            
            try {
                UI.showLoading('é©—è­‰ä¸­...');
                
                // 1. é©—è­‰é©—è­‰ç¢¼
                const result = await EmailVerificationAPI.verifyCode(currentEmail, code);
                
                if (result.success) {
                    // 2. æª¢æŸ¥ Email æ˜¯å¦å·²è¨»å†Š
                    const emailExists = await EmailVerificationAPI.checkEmailExists(currentEmail);
                    
                    let finalResult;
                    const isLiffMode = sessionStorage.getItem('liff_mode') === 'true' || !!lineUserId;
                    
                    if (emailExists) {
                        // === Email å·²å­˜åœ¨ â†’ ç™»å…¥æµç¨‹ ===
                        CONFIG.log('ğŸ“§ Email å·²å­˜åœ¨ï¼ŒåŸ·è¡Œç™»å…¥æµç¨‹');
                        
                        if (isLiffMode && lineUserId) {
                            // LIFF + å·²å­˜åœ¨ Email â†’ é—œè¯ LINE
                            CONFIG.log('ğŸ”— é—œè¯ LINE å¸³è™Ÿåˆ°ç¾æœ‰æœƒå“¡');
                            finalResult = await EmailVerificationAPI.linkLineAccount(
                                currentEmail,
                                lineUserId,
                                lineDisplayName,
                                linePictureUrl
                            );
                        } else {
                            // ç¶²é  + å·²å­˜åœ¨ Email â†’ ç´”ç™»å…¥
                            CONFIG.log('ğŸ” Email ç™»å…¥');
                            finalResult = await EmailVerificationAPI.emailLogin(currentEmail);
                        }
                        
                    } else {
                        // === Email æœªå­˜åœ¨ â†’ è¨»å†Šæµç¨‹ ===
                        CONFIG.log('ğŸ“ Email æœªè¨»å†Šï¼ŒåŸ·è¡Œè¨»å†Šæµç¨‹');
                        
                        finalResult = await EmailVerificationAPI.completeRegistration(
                            currentEmail,
                            lineUserId || null,  // å¯èƒ½æœ‰ LINE user idï¼Œä¹Ÿå¯èƒ½æ²’æœ‰
                            lineDisplayName || null,
                            linePictureUrl || null
                        );
                    }
                    
                    UI.hideLoading();
                    
                    // 3. å„²å­˜ Session
                    if (finalResult.member) {
                        // ä½¿ç”¨ Auth.js çš„æ¨™æº–æ–¹æ³•å„²å­˜ session
                        Auth.saveMemberSession(
                            finalResult.member, 
                            finalResult.member.line_user_id || null, 
                            null
                        );
                    }
                    
                    // 4. é¡¯ç¤ºå®Œæˆè¨Šæ¯
                    const messageEl = document.getElementById('complete-message');
                    const btnGoHome = document.getElementById('btn-go-home');
                    const completeTitle = document.querySelector('#step-complete .ds-card-title');
                    
                    if (emailExists) {
                        // ç™»å…¥æˆåŠŸ
                        completeTitle.textContent = 'ç™»å…¥æˆåŠŸï¼';
                        messageEl.textContent = 'æ­¡è¿å›ä¾† NPHONE';
                    } else {
                        // è¨»å†ŠæˆåŠŸ
                        completeTitle.textContent = 'è¨»å†ŠæˆåŠŸï¼';
                        messageEl.textContent = 'æ­¡è¿åŠ å…¥ NPHONE';
                    }
                    
                    // 5. æª¢æŸ¥æ˜¯å¦éœ€è¦è£œå……è³‡æ–™
                    const needsProfile = !finalResult.member.phone;
                    if (needsProfile) {
                        btnGoHome.textContent = 'ç¹¼çºŒå¡«å¯«è³‡æ–™';
                    } else {
                        btnGoHome.textContent = 'å‰å¾€é¦–é ';
                    }
                    
                    showStep('complete');
                    UI.success(finalResult.message || 'é©—è­‰æˆåŠŸï¼');
                }
                
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('âŒ é©—è­‰å¤±æ•—', error);
                UI.error(error.message || 'é©—è­‰å¤±æ•—');
                
                // æ¸…ç©ºè¼¸å…¥
                document.querySelectorAll('.code-digit').forEach(d => d.value = '');
                document.querySelector('.code-digit[data-index="0"]').focus();
            }
        }
        
        async function resendCode() {
            if (resendCountdown > 0) return;
            
            await sendVerificationCode();
        }
        
        function startCountdown() {
            verificationCountdown = 600; // 10 åˆ†é˜
            updateCountdownDisplay();
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                verificationCountdown--;
                updateCountdownDisplay();
                
                if (verificationCountdown <= 0) {
                    stopCountdown();
                    UI.error('é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç²å–');
                }
            }, 1000);
        }
        
        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (resendInterval) {
                clearInterval(resendInterval);
                resendInterval = null;
            }
        }
        
        function updateCountdownDisplay() {
            const display = document.getElementById('countdown-display');
            const formatted = EmailVerificationAPI.formatCountdown(verificationCountdown);
            display.innerHTML = `é©—è­‰ç¢¼å°‡åœ¨ <strong>${formatted}</strong> å¾ŒéæœŸ`;
            
            if (verificationCountdown < 60) {
                display.classList.add('warning');
            } else {
                display.classList.remove('warning');
            }
        }
        
        function startResendCountdown() {
            resendCountdown = 60;
            updateResendButton();
            
            if (resendInterval) clearInterval(resendInterval);
            
            resendInterval = setInterval(() => {
                resendCountdown--;
                updateResendButton();
                
                if (resendCountdown <= 0) {
                    clearInterval(resendInterval);
                    resendInterval = null;
                }
            }, 1000);
        }
        
        function updateResendButton() {
            const btn = document.getElementById('btn-resend-code');
            const countdown = document.getElementById('resend-countdown');
            
            if (resendCountdown > 0) {
                btn.disabled = true;
                countdown.textContent = resendCountdown;
            } else {
                btn.disabled = false;
                btn.innerHTML = 'é‡æ–°ç™¼é€é©—è­‰ç¢¼';
            }
        }
    </script>
</body>
</html>

