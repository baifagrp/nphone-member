<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡å°ˆå€ - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/animations.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body class="ds-page">
    <!-- é é¢é ­éƒ¨ -->
    <div class="ds-page-header">
        <h1 class="ds-page-title">æœƒå“¡å°ˆå€</h1>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="ds-container">
        
        <!-- æœƒå“¡è³‡è¨Šå¡ç‰‡ -->
        <div class="ds-card ds-mb-lg">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                <div style="width: 80px; height: 80px; border-radius: var(--radius-full); overflow: hidden; border: 3px solid var(--primary-light); flex-shrink: 0;">
                    <img id="member-avatar" src="" alt="æœƒå“¡é ­åƒ" style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div id="member-phone" style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: 4px;">+886...</div>
                    <h2 id="member-name" style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--text-primary); margin: 0;">è¼‰å…¥ä¸­...</h2>
                </div>
                <a href="edit.html" style="color: var(--text-secondary); text-decoration: none; font-size: 20px;">
                    âœï¸
                </a>
            </div>

            <!-- æœƒå“¡ç·¨è™Ÿæ¢ç¢¼ -->
            <div style="text-align: center; padding: var(--spacing-lg); background: var(--gray-50); border-radius: var(--radius-md);">
                <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-sm);">æœƒå“¡æ¢ç¢¼</div>
                <svg id="barcode" style="max-width: 100%; height: auto;"></svg>
                <div id="member-code-text" style="font-size: var(--font-size-sm); color: var(--text-hint); margin-top: var(--spacing-xs);"></div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ• -->
        <button onclick="location.href='booking.html'" class="ds-btn ds-btn-primary ds-btn-lg ds-mb-lg">
            <span>å‰å¾€é ç´„</span>
        </button>

        <!-- è³‡è¨Šå¡ç‰‡ç¶²æ ¼ -->
        <div class="ds-grid ds-grid-2 ds-mb-lg">
            <!-- æˆ‘çš„é ç´„ -->
            <a href="bookings.html" class="ds-info-card">
                <div class="ds-info-card-icon">ğŸ“…</div>
                <div class="ds-info-card-value" id="booking-count">0</div>
                <div class="ds-info-card-label">æˆ‘çš„é ç´„</div>
            </a>

            <!-- æ“æœ‰ç¥¨åˆ¸ -->
            <div class="ds-info-card" style="opacity: 0.5; cursor: not-allowed;">
                <div class="ds-info-card-icon">ğŸ«</div>
                <div class="ds-info-card-value">0</div>
                <div class="ds-info-card-label">æ“æœ‰ç¥¨åˆ¸</div>
                <div style="font-size: 10px; color: var(--text-hint); margin-top: 4px;">å³å°‡æ¨å‡º</div>
            </div>

            <!-- ç›®å‰å„²å€¼é‡‘ -->
            <a href="wallet.html" class="ds-info-card">
                <div class="ds-info-card-icon">ğŸ’°</div>
                <div class="ds-info-card-value" id="wallet-balance">0</div>
                <div class="ds-info-card-label">ç›®å‰å„²å€¼é‡‘</div>
            </a>

            <!-- ç´…åˆ©å…Œæ›ï¼ˆç©åˆ†ï¼‰ -->
            <a href="points.html" class="ds-info-card">
                <div class="ds-info-card-icon">ğŸ</div>
                <div class="ds-info-card-value" id="points-balance">0</div>
                <div class="ds-info-card-label">ç´…åˆ©é»æ•¸</div>
            </a>
        </div>

        <!-- åŠŸèƒ½åˆ—è¡¨ -->
        <div class="ds-card">
            <ul class="ds-list">
                <a href="bookings.html" class="ds-list-item">
                    <div class="ds-list-item-icon">ğŸ“‹</div>
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">é ç´„ç®¡ç†</div>
                        <div class="ds-list-item-subtitle">æŸ¥çœ‹æ‰€æœ‰é ç´„è¨˜éŒ„</div>
                    </div>
                    <div class="ds-list-item-arrow">â€º</div>
                </a>

                <a href="wallet.html" class="ds-list-item">
                    <div class="ds-list-item-icon">ğŸ’³</div>
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">å„²å€¼é‡‘ç®¡ç†</div>
                        <div class="ds-list-item-subtitle">æŸ¥çœ‹äº¤æ˜“æ˜ç´°èˆ‡é¤˜é¡</div>
                    </div>
                    <div class="ds-list-item-arrow">â€º</div>
                </a>

                <a href="points.html" class="ds-list-item">
                    <div class="ds-list-item-icon">â­</div>
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">ç´…åˆ©é»æ•¸</div>
                        <div class="ds-list-item-subtitle">æŸ¥çœ‹é»æ•¸æ˜ç´°èˆ‡æ­·å²</div>
                    </div>
                    <div class="ds-list-item-arrow">â€º</div>
                </a>

                <div class="ds-list-item" style="opacity: 0.5; cursor: not-allowed;">
                    <div class="ds-list-item-icon">ğŸ«</div>
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">ç¥¨åˆ¸ç®¡ç†</div>
                        <div class="ds-list-item-subtitle">å³å°‡æ¨å‡º</div>
                    </div>
                    <div class="ds-list-item-arrow">â€º</div>
                </div>
            </ul>
        </div>

        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <div style="margin-top: var(--spacing-xl); text-align: center;">
            <button id="btn-logout" class="ds-btn ds-btn-text">
                ç™»å‡º
            </button>
        </div>

        <!-- åº•éƒ¨ç‰ˆæ¬Š -->
        <div style="text-align: center; padding: var(--spacing-xl) 0; color: var(--text-hint); font-size: var(--font-size-xs);">
            Powered by NPHONE 2025
        </div>
    </div>

    <!-- è¼‰å…¥ Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- è¼‰å…¥è…³æœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/wallet-points.js"></script>
    <script src="../js/animation-utils.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!Auth.requireMemberLogin()) {
                    return;
                }

                // åˆå§‹åŒ–æœƒå“¡è³‡æ–™
                await Member.init();
                const memberData = Member.currentMember;

                if (!memberData) {
                    UI.error('ç„¡æ³•è¼‰å…¥æœƒå“¡è³‡æ–™');
                    return;
                }

                // é¡¯ç¤ºæœƒå“¡è³‡æ–™
                document.getElementById('member-name').textContent = memberData.name || 'æœƒå“¡';
                document.getElementById('member-phone').textContent = memberData.phone || '+886...';
                
                // é¡¯ç¤ºé ­åƒ
                const avatarEl = document.getElementById('member-avatar');
                if (memberData.avatar_url) {
                    avatarEl.src = memberData.avatar_url;
                } else {
                    avatarEl.src = 'data:image/svg+xml,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="50" fill="#C8A48A"/>
                            <text x="50" y="50" font-family="Arial" font-size="40" fill="white" text-anchor="middle" dominant-baseline="central">${(memberData.name || 'æœƒå“¡')[0]}</text>
                        </svg>
                    `);
                }

                // é¡¯ç¤ºæœƒå“¡æ¢ç¢¼
                if (memberData.member_code) {
                    try {
                        JsBarcode("#barcode", memberData.member_code, {
                            format: "CODE128",
                            width: 2,
                            height: 60,
                            displayValue: false,
                            margin: 0
                        });
                        document.getElementById('member-code-text').textContent = memberData.member_code;
                    } catch (error) {
                        console.error('æ¢ç¢¼ç”Ÿæˆå¤±æ•—', error);
                    }
                }

                // è¼‰å…¥å„²å€¼é‡‘å’Œç©åˆ†
                await loadWalletAndPoints();

                // è¼‰å…¥é ç´„æ•¸é‡
                await loadBookingCount();

                CONFIG.log('æœƒå“¡å°ˆå€åˆå§‹åŒ–æˆåŠŸ', memberData);
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
                UI.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        });

        // è¼‰å…¥å„²å€¼é‡‘å’Œç©åˆ†
        async function loadWalletAndPoints() {
            try {
                const memberData = Member.currentMember;
                if (!memberData) return;

                // è¼‰å…¥å„²å€¼é‡‘ï¼ˆä½¿ç”¨ line_user_idï¼‰
                const wallet = await WalletPointsAPI.getMemberWallet(memberData.line_user_id);
                if (wallet) {
                    document.getElementById('wallet-balance').textContent = Math.floor(wallet.balance || 0);
                }

                // è¼‰å…¥ç©åˆ†ï¼ˆä½¿ç”¨ line_user_idï¼‰
                const points = await WalletPointsAPI.getMemberPoints(memberData.line_user_id);
                if (points) {
                    document.getElementById('points-balance').textContent = points.balance || 0;
                }
            } catch (error) {
                CONFIG.error('è¼‰å…¥å„²å€¼é‡‘/ç©åˆ†å¤±æ•—', error);
            }
        }

        // è¼‰å…¥é ç´„æ•¸é‡
        async function loadBookingCount() {
            try {
                const memberData = Member.currentMember;
                if (!memberData?.line_user_id) return;

                const bookings = await BookingAPI.getMyBookings(memberData.line_user_id, 100);
                const activeBookings = bookings.filter(b => 
                    b.status === 'pending' || b.status === 'confirmed'
                );
                document.getElementById('booking-count').textContent = activeBookings.length;
            } catch (error) {
                CONFIG.error('è¼‰å…¥é ç´„æ•¸é‡å¤±æ•—', error);
            }
        }

        // ç™»å‡ºæŒ‰éˆ•
        document.getElementById('btn-logout').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                Auth.memberLogout();
            }
        });
    </script>
</body>
</html>
