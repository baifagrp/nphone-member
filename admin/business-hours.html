<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台 - 營業時間設定</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .business-hours-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .day-card {
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }
        
        .day-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .day-name {
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }
        
        .day-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #D1D5DB;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: #10B981;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        
        .toggle-switch.active::after {
            left: 26px;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        .time-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .time-input-group label {
            font-size: 14px;
            color: #6B7280;
            font-weight: 500;
        }
        
        .time-input-group input {
            padding: 8px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .time-inputs.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .break-time {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #E5E7EB;
        }
        
        .break-time-label {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 8px;
        }
        
        .time-slots-section {
            margin-top: 40px;
        }
        
        .time-slots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .time-slot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            background: white;
        }
        
        .time-slot-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .time-slot-time {
            font-weight: 600;
            color: #111827;
        }
        
        .time-slot-max {
            font-size: 12px;
            color: #6B7280;
        }
        
        .time-slot-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            padding: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .btn-icon:hover {
            background: #F3F4F6;
        }
        
        .btn-icon.delete:hover {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .add-time-slot-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            padding: 20px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            background: #F9FAFB;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .form-group label {
            font-size: 14px;
            color: #6B7280;
            font-weight: 500;
        }
        
        .form-group input {
            padding: 8px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .save-status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .save-status.success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #10B981;
        }
        
        .save-status.error {
            background: #FEE2E2;
            color: #991B1B;
            border: 1px solid #DC2626;
        }
    </style>
</head>
<body>
    <!-- 導航列 -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">首頁</a>
                <a href="members.html" class="navbar-link">會員管理</a>
                <a href="bookings.html" class="navbar-link">預約管理</a>
                <a href="services.html" class="navbar-link">服務項目</a>
                <a href="checkout.html" class="navbar-link">結帳管理</a>
                <a href="business-hours.html" class="navbar-link active">營業時間</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">登出</button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container" style="margin-top: 40px;">
        <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 32px;">營業時間設定</h1>
        
        <!-- 儲存狀態提示 -->
        <div id="save-status" class="save-status"></div>
        
        <!-- 營業時間設定 -->
        <div class="card">
            <div class="card-header">每週營業時間</div>
            <div class="card-body">
                <div class="business-hours-grid" id="business-hours-grid">
                    <!-- 動態載入 -->
                </div>
                <div style="margin-top: 20px;">
                    <button id="btn-save-hours" class="btn btn-primary">儲存營業時間</button>
                </div>
            </div>
        </div>
        
        <!-- 時間段設定 -->
        <div class="time-slots-section">
            <div class="card">
                <div class="card-header">
                    <div class="time-slots-header">
                        <span>開放時間段</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="time-slots-grid" id="time-slots-grid">
                        <!-- 動態載入 -->
                    </div>
                    
                    <!-- 新增時間段表單 -->
                    <div class="add-time-slot-form">
                        <div class="form-group">
                            <label>時間</label>
                            <input type="time" id="new-time-slot" class="form-input" step="1800" required>
                        </div>
                        <div class="form-group">
                            <label>最大預約數</label>
                            <input type="number" id="new-max-bookings" class="form-input" value="1" min="1" required>
                        </div>
                        <button id="btn-add-time-slot" class="btn btn-primary">新增時間段</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        let businessHours = [];
        let timeSlots = [];
        
        const dayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
        
        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // 檢查管理員登入狀態
                if (!Auth.requireAdminLogin()) {
                    return;
                }
                
                await loadBusinessHours();
                await loadTimeSlots();
                
            } catch (error) {
                CONFIG.error('初始化失敗', error);
                showMessage('載入資料失敗', 'error');
            }
        });
        
        // 載入營業時間
        async function loadBusinessHours() {
            try {
                businessHours = await BookingAPI.getBusinessHours();
                
                // 確保所有天都有資料
                for (let i = 0; i < 7; i++) {
                    const existing = businessHours.find(h => h.day_of_week === i);
                    if (!existing) {
                        // 如果沒有，創建預設值
                        businessHours.push({
                            day_of_week: i,
                            is_open: i >= 1 && i <= 5, // 週一到週五預設營業
                            open_time: '09:00:00',
                            close_time: '18:00:00',
                            break_start: null,
                            break_end: null
                        });
                    }
                }
                
                // 按星期排序
                businessHours.sort((a, b) => a.day_of_week - b.day_of_week);
                
                renderBusinessHours();
            } catch (error) {
                CONFIG.error('載入營業時間失敗', error);
                showMessage('載入營業時間失敗', 'error');
            }
        }
        
        // 渲染營業時間
        function renderBusinessHours() {
            const grid = document.getElementById('business-hours-grid');
            grid.innerHTML = businessHours.map(day => `
                <div class="day-card">
                    <div class="day-header">
                        <div class="day-name">${dayNames[day.day_of_week]}</div>
                        <div class="day-toggle">
                            <span style="font-size: 14px; color: #6B7280;">${day.is_open ? '營業' : '休息'}</span>
                            <div class="toggle-switch ${day.is_open ? 'active' : ''}" 
                                 data-day="${day.day_of_week}"
                                 onclick="toggleDay(${day.day_of_week})">
                            </div>
                        </div>
                    </div>
                    <div class="time-inputs ${day.is_open ? '' : 'disabled'}">
                        <div class="time-input-group">
                            <label>開始時間</label>
                            <input type="time" 
                                   id="open-time-${day.day_of_week}" 
                                   value="${day.open_time ? day.open_time.slice(0, 5) : '09:00'}"
                                   onchange="updateDayTime(${day.day_of_week}, 'open_time', this.value)">
                        </div>
                        <div class="time-input-group">
                            <label>結束時間</label>
                            <input type="time" 
                                   id="close-time-${day.day_of_week}" 
                                   value="${day.close_time ? day.close_time.slice(0, 5) : '18:00'}"
                                   onchange="updateDayTime(${day.day_of_week}, 'close_time', this.value)">
                        </div>
                    </div>
                    <div class="break-time">
                        <div class="break-time-label">午休時間（選填）</div>
                        <div class="time-inputs ${day.is_open ? '' : 'disabled'}">
                            <div class="time-input-group">
                                <label>休息開始</label>
                                <input type="time" 
                                       id="break-start-${day.day_of_week}" 
                                       value="${day.break_start ? day.break_start.slice(0, 5) : ''}"
                                       onchange="updateDayTime(${day.day_of_week}, 'break_start', this.value || null)">
                            </div>
                            <div class="time-input-group">
                                <label>休息結束</label>
                                <input type="time" 
                                       id="break-end-${day.day_of_week}" 
                                       value="${day.break_end ? day.break_end.slice(0, 5) : ''}"
                                       onchange="updateDayTime(${day.day_of_week}, 'break_end', this.value || null)">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 切換營業狀態
        async function toggleDay(dayOfWeek) {
            const day = businessHours.find(h => h.day_of_week === dayOfWeek);
            if (!day) return;
            
            day.is_open = !day.is_open;
            renderBusinessHours();
        }
        
        // 更新時間
        function updateDayTime(dayOfWeek, field, value) {
            const day = businessHours.find(h => h.day_of_week === dayOfWeek);
            if (!day) return;
            
            if (value === null || value === '') {
                day[field] = null;
            } else {
                day[field] = value + ':00'; // 轉換為 TIME 格式
            }
        }
        
        // 儲存營業時間
        document.getElementById('btn-save-hours').addEventListener('click', async () => {
            try {
                showLoading('儲存中...');
                
                const client = getSupabase();
                
                for (const day of businessHours) {
                    const data = {
                        day_of_week: day.day_of_week,
                        is_open: day.is_open,
                        open_time: day.open_time,
                        close_time: day.close_time,
                        break_start: day.break_start || null,
                        break_end: day.break_end || null
                    };
                    
                    // 使用 UPSERT（ON CONFLICT）來處理新增或更新
                    const { error } = await client
                        .from('business_hours')
                        .upsert(data, {
                            onConflict: 'day_of_week',
                            ignoreDuplicates: false
                        });
                    
                    if (error) {
                        throw error;
                    }
                }
                
                hideLoading();
                showMessage('營業時間已儲存', 'success');
                
                // 重新載入
                await loadBusinessHours();
                
            } catch (error) {
                hideLoading();
                CONFIG.error('儲存營業時間失敗', error);
                showMessage('儲存失敗：' + (error.message || '未知錯誤'), 'error');
            }
        });
        
        // 載入時間段
        async function loadTimeSlots() {
            try {
                timeSlots = await BookingAPI.getAllTimeSlots();
                renderTimeSlots();
            } catch (error) {
                CONFIG.error('載入時間段失敗', error);
                showMessage('載入時間段失敗', 'error');
            }
        }
        
        // 渲染時間段
        function renderTimeSlots() {
            const grid = document.getElementById('time-slots-grid');
            
            if (timeSlots.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">尚無時間段設定</p>';
                return;
            }
            
            grid.innerHTML = timeSlots.map(slot => `
                <div class="time-slot-item ${!slot.is_active ? 'disabled' : ''}" style="opacity: ${slot.is_active ? 1 : 0.5};">
                    <div class="time-slot-info">
                        <div class="time-slot-time">${slot.time_slot.slice(0, 5)}</div>
                        <div class="time-slot-max">最大預約數：${slot.max_bookings}</div>
                    </div>
                    <div class="time-slot-actions">
                        <button class="btn-icon" onclick="editTimeSlot('${slot.id}')" title="編輯">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                                <path d="M11.5 2.5a2.121 2.121 0 0 1 3 3L6.5 12.5l-4 1 1-4L11.5 2.5z"/>
                            </svg>
                        </button>
                        <button class="btn-icon ${slot.is_active ? '' : 'delete'}" 
                                onclick="toggleTimeSlot('${slot.id}', ${!slot.is_active})" 
                                title="${slot.is_active ? '停用' : '啟用'}">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                                ${slot.is_active 
                                    ? '<path d="M2 2l12 12M2 14L14 2"/>' 
                                    : '<path d="M8 2L2 8l6 6 6-6-6-6z"/>'}
                            </svg>
                        </button>
                        <button class="btn-icon delete" onclick="deleteTimeSlot('${slot.id}')" title="刪除">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                                <path d="M3 4h10M5 4V3a1 1 0 0 1 1-1h4a1 1 0 0 1 1v1m1 0v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4h8z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // 新增時間段
        document.getElementById('btn-add-time-slot').addEventListener('click', async () => {
            try {
                const timeInput = document.getElementById('new-time-slot');
                const maxInput = document.getElementById('new-max-bookings');
                
                const time = timeInput.value;
                const maxBookings = parseInt(maxInput.value) || 1;
                
                if (!time) {
                    alert('請輸入時間');
                    return;
                }
                
                // 檢查是否已存在
                const existing = timeSlots.find(s => s.time_slot === time + ':00');
                if (existing) {
                    alert('該時間段已存在');
                    return;
                }
                
                showLoading('新增中...');
                await BookingAPI.createTimeSlot(time + ':00', maxBookings);
                hideLoading();
                showMessage('時間段新增成功', 'success');
                
                // 清空表單
                timeInput.value = '';
                maxInput.value = '1';
                
                // 重新載入
                await loadTimeSlots();
                
            } catch (error) {
                hideLoading();
                CONFIG.error('新增時間段失敗', error);
                showMessage('新增失敗：' + (error.message || '未知錯誤'), 'error');
            }
        });
        
        // 編輯時間段
        async function editTimeSlot(id) {
            const slot = timeSlots.find(s => s.id === id);
            if (!slot) return;
            
            const newMax = prompt('請輸入最大預約數：', slot.max_bookings);
            if (newMax === null) return;
            
            const maxBookings = parseInt(newMax);
            if (isNaN(maxBookings) || maxBookings < 1) {
                alert('請輸入有效的數字（至少為 1）');
                return;
            }
            
            try {
                showLoading('更新中...');
                await BookingAPI.updateTimeSlot(id, { max_bookings: maxBookings });
                hideLoading();
                showMessage('時間段更新成功', 'success');
                await loadTimeSlots();
            } catch (error) {
                hideLoading();
                CONFIG.error('更新時間段失敗', error);
                showMessage('更新失敗：' + (error.message || '未知錯誤'), 'error');
            }
        }
        
        // 切換時間段啟用狀態
        async function toggleTimeSlot(id, isActive) {
            try {
                showLoading('更新中...');
                await BookingAPI.updateTimeSlot(id, { is_active: isActive });
                hideLoading();
                showMessage('時間段狀態已更新', 'success');
                await loadTimeSlots();
            } catch (error) {
                hideLoading();
                CONFIG.error('更新時間段失敗', error);
                showMessage('更新失敗：' + (error.message || '未知錯誤'), 'error');
            }
        }
        
        // 刪除時間段
        async function deleteTimeSlot(id) {
            if (!confirm('確定要刪除此時間段嗎？')) {
                return;
            }
            
            try {
                showLoading('刪除中...');
                await BookingAPI.deleteTimeSlot(id);
                hideLoading();
                showMessage('時間段已刪除', 'success');
                await loadTimeSlots();
            } catch (error) {
                hideLoading();
                CONFIG.error('刪除時間段失敗', error);
                showMessage('刪除失敗：' + (error.message || '未知錯誤'), 'error');
            }
        }
        
        // 顯示訊息
        function showMessage(message, type) {
            const statusEl = document.getElementById('save-status');
            statusEl.textContent = message;
            statusEl.className = `save-status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        // 顯示載入中
        function showLoading(message) {
            // 可以在這裡添加載入指示器
        }
        
        // 隱藏載入中
        function hideLoading() {
            // 可以在這裡移除載入指示器
        }
        
        // 登出
        document.getElementById('btn-admin-logout').addEventListener('click', () => {
            Auth.adminLogout();
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>

