# 交易編輯/刪除功能測試指南

## 📋 前置準備

### 1. 執行 SQL 腳本

請依序在 Supabase SQL Editor 中執行以下腳本：

```sql
-- 1. 修正儲值金扣除邏輯（修正交易編號生成順序）
supabase/checkout-integrate-wallet-points.sql

-- 2. 建立交易編輯/刪除 RPC 函數
supabase/transaction-update-delete.sql
```

### 2. 確認檔案已更新

確認以下檔案已更新：
- ✅ `js/checkout.js` - 已修改為使用 RPC 函數

---

## 🧪 測試案例

### 測試 1：刪除儲值金交易

**初始狀態：**
- 會員儲值金：1000 元
- 會員積分：0 點

**步驟：**
1. 建立一筆儲值金付款交易（220 元）
2. 確認：
   - ✅ 儲值金餘額：780 元（1000 - 220）
   - ✅ 積分增加：22 點（220 ÷ 10）
   - ✅ 交易編號正確顯示（例如：20251212-0001）
   - ✅ 儲值金消費記錄顯示正確交易編號

3. **刪除此交易**
4. 確認：
   - ✅ 儲值金餘額恢復：1000 元（+220）
   - ✅ 積分扣除：0 點（-22）
   - ✅ 關聯預約狀態改為「未付款」
   - ✅ 儲值金交易記錄新增「交易刪除退回」記錄
   - ✅ 積分交易記錄新增「交易刪除收回積分」記錄

---

### 測試 2：編輯交易金額（儲值金 → 儲值金，金額改變）

**初始狀態：**
- 會員儲值金：1000 元
- 會員積分：0 點

**步驟：**
1. 建立一筆儲值金付款交易（220 元）
   - 儲值金餘額：780 元
   - 積分：22 點

2. **編輯金額為 330 元**
3. 確認：
   - ✅ 儲值金餘額：670 元（1000 - 330，實際操作：先退回 220，再扣 330）
   - ✅ 積分：33 點（實際操作：先收回 22，再發放 33）
   - ✅ 儲值金交易記錄：
     - 「交易編輯退回」+220 元
     - 「交易編輯扣款」-330 元
   - ✅ 積分交易記錄：
     - 「交易編輯收回積分」-22 點
     - 「交易編輯獲得積分」+33 點

---

### 測試 3：改變付款方式（儲值金 → 現金）

**初始狀態：**
- 會員儲值金：1000 元
- 會員積分：0 點

**步驟：**
1. 建立一筆儲值金付款交易（220 元）
   - 儲值金餘額：780 元
   - 積分：22 點

2. **編輯付款方式為「現金」**
3. 確認：
   - ✅ 儲值金餘額恢復：1000 元（+220）
   - ✅ 積分維持：22 點（不變，因為金額沒變）
   - ✅ 交易記錄的付款方式改為「現金」
   - ✅ 儲值金交易記錄新增「交易編輯退回」+220 元

---

### 測試 4：改變付款方式（現金 → 儲值金）

**初始狀態：**
- 會員儲值金：1000 元
- 會員積分：0 點

**步驟：**
1. 建立一筆現金付款交易（220 元）
   - 儲值金餘額：1000 元（不變）
   - 積分：22 點

2. **編輯付款方式為「儲值金」**
3. 確認：
   - ✅ 儲值金餘額：780 元（-220）
   - ✅ 積分維持：22 點（不變）
   - ✅ 交易記錄的付款方式改為「儲值金」
   - ✅ 儲值金交易記錄新增「交易編輯扣款」-220 元

---

### 測試 5：編輯金額並改變付款方式（儲值金 220 → 現金 330）

**初始狀態：**
- 會員儲值金：1000 元
- 會員積分：0 點

**步驟：**
1. 建立一筆儲值金付款交易（220 元）
   - 儲值金餘額：780 元
   - 積分：22 點

2. **同時編輯：金額改為 330 元，付款方式改為「現金」**
3. 確認：
   - ✅ 儲值金餘額恢復：1000 元（+220，退回原扣款）
   - ✅ 積分：33 點（先收回 22，再發放 33）
   - ✅ 交易記錄：金額 330，付款方式「現金」
   - ✅ 儲值金交易記錄新增「交易編輯退回」+220 元

---

### 測試 6：刪除現金交易（只收回積分）

**初始狀態：**
- 會員儲值金：1000 元
- 會員積分：0 點

**步驟：**
1. 建立一筆現金付款交易（220 元）
   - 儲值金餘額：1000 元（不變）
   - 積分：22 點

2. **刪除此交易**
3. 確認：
   - ✅ 儲值金餘額：1000 元（不變）
   - ✅ 積分扣除：0 點（-22）
   - ✅ 關聯預約狀態改為「未付款」
   - ✅ 積分交易記錄新增「交易刪除收回積分」-22 點

---

## 🔍 檢查項目

### 後端日誌檢查

在 Supabase Dashboard → Database → Logs 中確認：

```
✅ 已退回儲值金: 220
✅ 已收回積分: 22
✅ 已發放積分: 33
✅ 已更新預約 [UUID] 付款狀態為未付款
✅ 已刪除交易記錄: [UUID]
```

### 前端控制台檢查

開啟瀏覽器開發者工具（F12），檢查：

```javascript
// 刪除交易
[NPHONE] 呼叫 delete_transaction RPC { transaction_id: "..." }
[NPHONE] 刪除交易記錄成功（已自動處理儲值金退回和積分收回）

// 更新交易
[NPHONE] 呼叫 update_transaction RPC { transaction_id: "...", updates: {...} }
[NPHONE] 更新交易記錄成功（已自動處理儲值金和積分變更）
```

### 資料庫檢查

在 Supabase Table Editor 中檢查：

1. **transactions 表**
   - 交易記錄正確更新或刪除

2. **wallets 表**
   - `balance` 正確變動
   - `total_spent` 正確調整

3. **wallet_transactions 表**
   - 有「交易編輯退回」、「交易編輯扣款」、「交易刪除退回」記錄
   - `balance_before` 和 `balance_after` 正確

4. **points 表**
   - `balance` 正確變動
   - `total_earned` / `total_spent` 正確調整

5. **point_transactions 表**
   - 有「交易編輯收回積分」、「交易編輯獲得積分」、「交易刪除收回積分」記錄
   - `balance_before` 和 `balance_after` 正確

6. **bookings 表**
   - `payment_status` 正確更新
   - `paid_amount` 正確更新
   - `transaction_id` 在刪除交易後為 NULL

---

## ⚠️ 常見問題

### Q1: 刪除後餘額沒變動？
**A:** 確認已執行 `transaction-update-delete.sql` 並且前端 `js/checkout.js` 已更新為使用 RPC 函數。

### Q2: 編輯金額後積分計算錯誤？
**A:** 檢查 `point_rules` 表中 `spend_rate` 規則是否正確（預設：每 10 元 1 點）。

### Q3: 儲值金餘額不足時能否刪除/編輯？
**A:** 
- **刪除**：可以，會退回原金額
- **編輯改為儲值金**：不可以，會顯示「會員儲值金餘額不足」錯誤

### Q4: 積分不足時能否刪除/編輯？
**A:** 會顯示警告但不會阻止操作，可能導致積分餘額為負（需要管理員手動補正）。

---

## ✅ 測試完成檢查表

- [ ] 測試 1：刪除儲值金交易
- [ ] 測試 2：編輯交易金額（儲值金 → 儲值金）
- [ ] 測試 3：改變付款方式（儲值金 → 現金）
- [ ] 測試 4：改變付款方式（現金 → 儲值金）
- [ ] 測試 5：同時編輯金額和付款方式
- [ ] 測試 6：刪除現金交易（只收回積分）
- [ ] 檢查後端日誌
- [ ] 檢查前端控制台
- [ ] 檢查資料庫各表數據正確性

---

## 📝 備註

- 所有的儲值金和積分變動都會自動記錄在 `wallet_transactions` 和 `point_transactions` 表中
- 每次編輯/刪除都會在描述中註明原交易編號，方便追蹤
- RPC 函數使用 `SECURITY DEFINER`，確保權限正確執行
- 所有操作都會記錄 `admin_id`（如果是管理員操作）

