<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™¼é€æœƒå“¡å¡ - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #9c9c9c 0%, #696969 100%);
            margin: 0;
            padding: 20px;
        }
        
        .loading-container {
            text-align: center;
            color: white;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .loading-detail {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .error-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="loading-container" id="status">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨æº–å‚™æ‚¨çš„æœƒå“¡å¡...</div>
        <div class="loading-detail">è«‹ç¨å€™</div>
    </div>

    <!-- JavaScript -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/member.js"></script>
    
    <script>
        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(icon, text, detail) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="success-icon">${icon}</div>
                <div class="loading-text">${text}</div>
                <div class="loading-detail">${detail}</div>
            `;
        }

        // ç”Ÿæˆæœƒå“¡æ¢ç¢¼ URLï¼ˆä½¿ç”¨å¤–éƒ¨ API é¿å… Base64 å¤ªå¤§ï¼‰
        function generateBarcodeURL(memberCode) {
            // ä½¿ç”¨å…è²»çš„æ¢ç¢¼ç”Ÿæˆ API
            // API: https://bwipjs-api.metafloor.com/
            const barcodeParams = new URLSearchParams({
                bcid: 'code128',           // æ¢ç¢¼é¡å‹
                text: memberCode,          // æ¢ç¢¼å…§å®¹
                scale: 3,                  // ç¸®æ”¾æ¯”ä¾‹
                height: 15,                // é«˜åº¦ï¼ˆå–®ä½ï¼šæ¨¡çµ„ï¼‰
                includetext: true,         // é¡¯ç¤ºæ–‡å­—
                textxalign: 'center',      // æ–‡å­—å°é½Š
                backgroundcolor: 'FFFFFF', // èƒŒæ™¯è‰²ï¼ˆç™½è‰²ï¼‰
                barcolor: '000000'         // æ¢ç¢¼é¡è‰²ï¼ˆé»‘è‰²ï¼‰
            });
            
            return `https://bwipjs-api.metafloor.com/?${barcodeParams.toString()}`;
        }

        // å‰µå»ºæœƒå“¡å¡ Flex Messageï¼ˆä½¿ç”¨å¤–éƒ¨æ¢ç¢¼ APIï¼‰
        function createMemberCardFlexMessage(memberData, barcodeImageUrl) {
            return {
                type: 'flex',
                altText: 'ğŸ« æˆ‘çš„ NPHONE æœƒå“¡å¡',
                contents: {
                    type: 'bubble',
                    size: 'mega',
                    header: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            {
                                type: 'box',
                                layout: 'vertical',
                                contents: [
                                    {
                                        type: 'text',
                                        text: 'NPHONE',
                                        color: '#ffffff',
                                        size: 'xl',
                                        weight: 'bold',
                                        align: 'center'
                                    },
                                    {
                                        type: 'text',
                                        text: 'æœƒå“¡å¡',
                                        color: '#ffffff99',
                                        size: 'sm',
                                        align: 'center',
                                        margin: 'sm'
                                    }
                                ]
                            }
                        ],
                        paddingAll: '20px',
                        backgroundColor: '#667eea',
                        spacing: 'md',
                        paddingTop: '22px'
                    },
                    body: {
                        type: 'box',
                        layout: 'vertical',
                        contents: [
                            // æœƒå“¡è³‡è¨Š
                            {
                                type: 'box',
                                layout: 'vertical',
                                margin: 'lg',
                                spacing: 'sm',
                                contents: [
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'æœƒå“¡å§“å',
                                                size: 'sm',
                                                color: '#999999',
                                                flex: 0,
                                                wrap: true
                                            },
                                            {
                                                type: 'text',
                                                text: memberData.name || 'æœªè¨­å®š',
                                                size: 'sm',
                                                color: '#333333',
                                                align: 'end',
                                                weight: 'bold',
                                                wrap: true
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'æœƒå“¡ç·¨è™Ÿ',
                                                size: 'sm',
                                                color: '#999999',
                                                flex: 0
                                            },
                                            {
                                                type: 'text',
                                                text: memberData.member_code || 'æœªè¨­å®š',
                                                size: 'sm',
                                                color: '#667eea',
                                                align: 'end',
                                                weight: 'bold',
                                                style: 'normal'
                                            }
                                        ],
                                        margin: 'md'
                                    }
                                ]
                            },
                            // åˆ†éš”ç·š
                            {
                                type: 'separator',
                                margin: 'xl'
                            },
                            // æœƒå“¡æ¢ç¢¼ï¼ˆä½¿ç”¨å¤–éƒ¨ API ç”Ÿæˆï¼‰
                            {
                                type: 'box',
                                layout: 'vertical',
                                margin: 'xl',
                                spacing: 'sm',
                                contents: [
                                    {
                                        type: 'text',
                                        text: 'æœƒå“¡æ¢ç¢¼',
                                        size: 'sm',
                                        color: '#999999',
                                        align: 'center'
                                    },
                                    {
                                        type: 'image',
                                        url: barcodeImageUrl,
                                        size: 'full',
                                        aspectMode: 'fit',
                                        aspectRatio: '4:1',
                                        margin: 'md',
                                        backgroundColor: '#FFFFFF'
                                    },
                                    {
                                        type: 'text',
                                        text: 'è«‹åœ¨çµå¸³æ™‚å‡ºç¤ºæ­¤æ¢ç¢¼',
                                        size: 'xs',
                                        color: '#999999',
                                        align: 'center',
                                        margin: 'md',
                                        wrap: true
                                    }
                                ]
                            },
                            // åˆ†éš”ç·š
                            {
                                type: 'separator',
                                margin: 'xl'
                            },
                            // é¤˜é¡è³‡è¨Š
                            {
                                type: 'box',
                                layout: 'vertical',
                                margin: 'xl',
                                spacing: 'sm',
                                contents: [
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'ğŸ’° å„²å€¼é‡‘',
                                                size: 'sm',
                                                color: '#666666',
                                                flex: 0
                                            },
                                            {
                                                type: 'text',
                                                text: `NT$ ${memberData.wallet_balance || 0}`,
                                                size: 'sm',
                                                color: '#ff6b6b',
                                                align: 'end',
                                                weight: 'bold'
                                            }
                                        ]
                                    },
                                    {
                                        type: 'box',
                                        layout: 'horizontal',
                                        contents: [
                                            {
                                                type: 'text',
                                                text: 'â­ ç©åˆ†',
                                                size: 'sm',
                                                color: '#666666',
                                                flex: 0
                                            },
                                            {
                                                type: 'text',
                                                text: `${memberData.points_balance || 0} é»`,
                                                size: 'sm',
                                                color: '#ffd93d',
                                                align: 'end',
                                                weight: 'bold'
                                            }
                                        ],
                                        margin: 'md'
                                    }
                                ]
                            }
                        ]
                    },
                    footer: {
                        type: 'box',
                        layout: 'vertical',
                        spacing: 'sm',
                        contents: [
                            {
                                type: 'text',
                                text: 'æ„Ÿè¬æ‚¨çš„æ”¯æŒï¼',
                                size: 'xs',
                                color: '#999999',
                                align: 'center',
                                wrap: true
                            },
                            {
                                type: 'separator',
                                margin: 'md'
                            },
                            {
                                type: 'text',
                                text: 'NPHONE â¤ï¸',
                                size: 'xs',
                                color: '#667eea',
                                align: 'center',
                                margin: 'md',
                                weight: 'bold'
                            }
                        ],
                        flex: 0
                    }
                }
            };
        }

        // ä¸»è¦åŸ·è¡Œå‡½æ•¸
        async function main() {
            try {
                // 1. åˆå§‹åŒ– LIFF
                updateStatus('ğŸ”„', 'åˆå§‹åŒ–ä¸­...', 'æ­£åœ¨é€£æ¥ LINE');
                
                if (typeof liff === 'undefined') {
                    throw new Error('LIFF SDK æœªè¼‰å…¥');
                }
                
                await liff.init({ liffId: CONFIG.LIFF_SEND_CARD_ID });
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!liff.isLoggedIn()) {
                    CONFIG.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œå°å‘ç™»å…¥é é¢');
                    liff.login();
                    return;
                }
                
                // é©—è­‰ Access Token å’Œæ¬Šé™
                try {
                    const accessToken = liff.getAccessToken();
                    if (!accessToken) {
                        CONFIG.log('Access Token ä¸å­˜åœ¨ï¼Œé‡æ–°ç™»å…¥');
                        await liff.logout();
                        window.location.reload();
                        return;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„æ¬Šé™
                    // å¦‚æœæ˜¯é¦–æ¬¡ä½¿ç”¨æˆ–æ¬Šé™æ›´æ–°ï¼Œå¼·åˆ¶é‡æ–°æˆæ¬Š
                    const needReauth = sessionStorage.getItem('liff_need_reauth');
                    if (needReauth === 'true') {
                        CONFIG.log('æª¢æ¸¬åˆ°éœ€è¦é‡æ–°æˆæ¬Š');
                        sessionStorage.removeItem('liff_need_reauth');
                        await liff.logout();
                        setTimeout(() => {
                            liff.login();
                        }, 500);
                        return;
                    }
                } catch (error) {
                    CONFIG.error('Access Token é©—è­‰å¤±æ•—', error);
                    // Token å¤±æ•ˆï¼Œé‡æ–°ç™»å…¥
                    await liff.logout();
                    setTimeout(() => {
                        liff.login();
                    }, 500);
                    return;
                }
                
                // 2. å–å¾—æœƒå“¡è³‡è¨Šå’Œæª¢æŸ¥æ¬Šé™
                updateStatus('ğŸ‘¤', 'è¼‰å…¥æœƒå“¡è³‡è¨Š...', 'æ­£åœ¨å–å¾—æ‚¨çš„è³‡æ–™');
                
                const profile = await liff.getProfile();
                const lineUserId = profile.userId;
                
                CONFIG.log('LIFF Profile', profile);
                
                // æª¢æŸ¥å¯ç”¨çš„æ¬Šé™
                const context = liff.getContext();
                CONFIG.log('LIFF Context', context);
                
                // æª¢æŸ¥æ˜¯å¦åœ¨ LINE å…§éƒ¨ç€è¦½å™¨
                if (!liff.isInClient()) {
                    throw new Error('è«‹åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿæ­¤åŠŸèƒ½');
                }
                
                // å¾è³‡æ–™åº«å–å¾—å®Œæ•´æœƒå“¡è³‡è¨Šï¼ˆåŒ…å«å„²å€¼é‡‘å’Œç©åˆ†ï¼‰
                const { data: memberData, error: memberError } = await getSupabase()
                    .from('members')
                    .select(`
                        *,
                        wallets:wallets!member_id (balance),
                        points:points!member_id (balance)
                    `)
                    .eq('line_user_id', lineUserId)
                    .single();
                
                if (memberError || !memberData) {
                    throw new Error('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                }
                
                CONFIG.log('æœƒå“¡è³‡æ–™', memberData);
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æœƒå“¡ç·¨è™Ÿ
                if (!memberData.member_code) {
                    throw new Error('æ‚¨é‚„æ²’æœ‰æœƒå“¡ç·¨è™Ÿï¼Œè«‹è¯ç¹«å•†å®¶è¨­å®š');
                }
                
                // 3. è™•ç†å„²å€¼é‡‘å’Œç©åˆ†è³‡æ–™
                updateStatus('ğŸ’°', 'è¼‰å…¥é¤˜é¡è³‡è¨Š...', 'æ­£åœ¨å–å¾—å„²å€¼é‡‘èˆ‡ç©åˆ†');
                
                // å¾é—œè¯æŸ¥è©¢ä¸­æå–é¤˜é¡
                memberData.wallet_balance = memberData.wallets?.[0]?.balance || 0;
                memberData.points_balance = memberData.points?.[0]?.balance || 0;
                
                // 4. ç”Ÿæˆæ¢ç¢¼ URL
                updateStatus('ğŸ“Š', 'ç”Ÿæˆæ¢ç¢¼...', 'æ­£åœ¨è£½ä½œæ‚¨çš„æœƒå“¡æ¢ç¢¼');
                
                const barcodeImageUrl = generateBarcodeURL(memberData.member_code);
                CONFIG.log('æ¢ç¢¼ URL', barcodeImageUrl);
                
                // 5. å‰µå»º Flex Message
                updateStatus('ğŸ¨', 'è£½ä½œæœƒå“¡å¡...', 'æ­£åœ¨ç”Ÿæˆæœƒå“¡å¡è¨Šæ¯');
                
                const flexMessage = createMemberCardFlexMessage(memberData, barcodeImageUrl);
                
                CONFIG.log('Flex Message', flexMessage);
                
                // 6. ç™¼é€è¨Šæ¯
                updateStatus('ğŸ“¤', 'ç™¼é€æœƒå“¡å¡...', 'æ­£åœ¨ç™¼é€åˆ°èŠå¤©å®¤');
                
                await liff.sendMessages([flexMessage]);
                
                // 7. é¡¯ç¤ºæˆåŠŸä¸¦é—œé–‰
                updateStatus('âœ…', 'æœƒå“¡å¡å·²ç™¼é€ï¼', 'è¦–çª—å³å°‡é—œé–‰...');
                
                setTimeout(() => {
                    liff.closeWindow();
                }, 1500);
                
            } catch (error) {
                CONFIG.error('ç™¼é€æœƒå“¡å¡å¤±æ•—', error);
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ¬Šé™æˆ– Token ç›¸é—œéŒ¯èª¤
                if (error.message && (
                    error.message.includes('access token revoked') ||
                    error.message.includes('access token expired') ||
                    error.message.includes('permission is not in LIFF app scope') ||
                    error.message.includes("doesn't grant required permissions")
                )) {
                    updateStatus('ğŸ”', 'éœ€è¦æˆæ¬Š', 'è«‹æˆäºˆã€Œç™¼é€è¨Šæ¯ã€æ¬Šé™');
                    
                    // æ¨™è¨˜éœ€è¦é‡æ–°æˆæ¬Š
                    sessionStorage.setItem('liff_need_reauth', 'true');
                    
                    // æ¸…é™¤èˆŠçš„ç™»å…¥ç‹€æ…‹ä¸¦é‡æ–°ç™»å…¥
                    setTimeout(async () => {
                        await liff.logout();
                        setTimeout(() => {
                            liff.login();
                        }, 500);
                    }, 2000);
                } else {
                    updateStatus('âŒ', 'ç™¼é€å¤±æ•—', error.message || 'è«‹ç¨å¾Œå†è©¦');
                    
                    setTimeout(() => {
                        liff.closeWindow();
                    }, 3000);
                }
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>

