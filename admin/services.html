<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務管理 - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/admin-enhancements.css">
</head>
<body class="ds-page">
    <!-- 導航列 -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE 管理後台</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">儀表板</a>
                <a href="members.html" class="navbar-link">會員管理</a>
                <a href="services.html" class="navbar-link active">服務管理</a>
                <a href="bookings.html" class="navbar-link">預約管理</a>
                <a href="checkout.html" class="navbar-link">結帳管理</a>
                <a href="business-hours.html" class="navbar-link">營業時間</a>
                <a href="wallet-points.html" class="navbar-link">儲值/積分</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">登出</button>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 40px;">
        <div class="page-actions">
            <h1 class="page-title">服務管理</h1>
            <button id="btn-add-service" class="ds-btn ds-btn-primary">+ 新增服務</button>
        </div>
        
        <!-- 服務列表 -->
        <div class="ds-card">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>服務名稱</th>
                        <th>基礎價格</th>
                        <th>服務時長</th>
                        <th>是否有選項</th>
                        <th>狀態</th>
                        <th style="text-align: center;">操作</th>
                    </tr>
                </thead>
                <tbody id="services-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--spacing-2xl);">
                            <div class="loading-spinner"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) return;
                await loadServices();
            } catch (error) {
                CONFIG.error('初始化失敗', error);
                UI.error('載入失敗');
            }
        });

        async function loadServices() {
            try {
                UI.showLoading('載入中...');
                const services = await BookingAPI.getActiveServices();
                displayServices(services);
                UI.hideLoading();
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('載入服務失敗', error);
                UI.error('載入服務失敗');
            }
        }

        function displayServices(services) {
            const tbody = document.getElementById('services-tbody');
            if (!services || services.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="ds-text-center ds-p-xl"><div class="ds-empty-title">尚無服務項目</div></td></tr>';
                return;
            }

            tbody.innerHTML = services.map(s => `
                <tr>
                    <td><strong>${s.name}</strong>${s.description ? `<br><small style="color: var(--text-secondary);">${s.description}</small>` : ''}</td>
                    <td>NT$ ${(s.base_price || s.price || 0).toLocaleString()}</td>
                    <td>${s.duration} 分鐘</td>
                    <td><span class="ds-badge ${s.has_options ? 'ds-badge-info' : 'ds-badge-default'}">${s.has_options ? '有選項' : '無選項'}</span></td>
                    <td><span class="ds-badge ${s.is_active ? 'ds-badge-success' : 'ds-badge-error'}">${s.is_active ? '啟用' : '停用'}</span></td>
                    <td>
                        <div class="admin-actions" style="justify-content: center;">
                            <button onclick="viewService('${s.id}')" class="admin-action-btn">查看</button>
                            <button onclick="editService('${s.id}')" class="admin-action-btn">編輯</button>
                            <button onclick="toggleService('${s.id}', ${!s.is_active})" class="admin-action-btn">${s.is_active ? '停用' : '啟用'}</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function viewService(id) {
            UI.info('服務詳情頁面開發中');
        }

        function editService(id) {
            UI.info('服務編輯頁面開發中');
        }

        async function toggleService(id, newStatus) {
            try {
                UI.showLoading('更新中...');
                // 這裡需要實作 updateService API
                UI.hideLoading();
                UI.success(`${newStatus ? '啟用' : '停用'}成功`);
                await loadServices();
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('更新失敗', error);
                UI.error('更新失敗');
            }
        }

        document.getElementById('btn-add-service').addEventListener('click', () => {
            UI.info('新增服務頁面開發中');
        });

        document.getElementById('btn-admin-logout').addEventListener('click', () => {
            if (confirm('確定要登出嗎？')) {
                Auth.adminLogout();
            }
        });
    </script>
</body>
</html>
