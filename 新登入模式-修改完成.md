# ✅ 新登入模式修改完成

**修改時間：** 2025-12-15

---

## 📋 修改需求

根據新的登入邏輯要求，修改了登入模式的判斷流程。

### 新邏輯

#### LIFF 環境
1. **已註冊（有 LINE 資料）** → 進入主頁 ✅
2. **未註冊** → LIFF補上用戶line user id + Email註冊 ✅
3. **已註冊無LINE資料且有EMAIL資料EMAIL相符驗證碼認證成功** → Email登入 + LIFF補上用戶line user id ✅ **新增**

#### 網頁環境（不變）
1. **已註冊** → Email登入 ✅
2. **未註冊** → Email註冊 ✅

---

## 🔧 修改內容

### 1️⃣ `index.html` - 登入入口邏輯

**修改：**
- ✅ 保持原有邏輯（已註冊有LINE資料 → 直接登入）
- ✅ 未找到LINE資料時，導向Email驗證頁面（由email-verification.html判斷是註冊還是登入+關聯）
- ✅ 保存 LIFF access token 到 sessionStorage

**關鍵代碼：**
```javascript
// 保存 LIFF access token（如果可用）
const liffAccessToken = LiffClient.getAccessToken();
if (liffAccessToken) {
    sessionStorage.setItem('temp_liff_access_token', liffAccessToken);
}
```

---

### 2️⃣ `member/email-verification.html` - Email 驗證流程

**修改：**
- ✅ 保持原有的自動判斷邏輯（Email已存在 → 登入；Email不存在 → 註冊）
- ✅ 在LIFF模式下，當Email已存在時，執行「Email登入 + 關聯LINE」（調用 `linkLineAccount`）
- ✅ 優化完成訊息顯示，區分「純登入」和「登入+關聯LINE」
- ✅ 正確保存 LIFF access token 到 session

**關鍵邏輯：**
```javascript
if (emailExists) {
    if (isLiffMode && lineUserId) {
        // LIFF + 已存在 Email → 關聯 LINE + 登入
        finalResult = await EmailVerificationAPI.linkLineAccount(...);
    } else {
        // 網頁 + 已存在 Email → 純登入
        finalResult = await EmailVerificationAPI.emailLogin(currentEmail);
    }
} else {
    // Email 不存在 → 註冊（可能帶LINE user id）
    finalResult = await EmailVerificationAPI.completeRegistration(...);
}
```

**完成訊息：**
- LIFF模式 + Email已存在 → 「登入成功！LINE 帳號已綁定」
- 網頁模式 + Email已存在 → 「登入成功！」
- LIFF模式 + Email不存在 → 「註冊成功！LINE 帳號已綁定」
- 網頁模式 + Email不存在 → 「註冊成功！」

---

### 3️⃣ `supabase/email-verification-rpc.sql` - `link_line_account` 函數

**修改：**
- ✅ 添加檢查：如果會員已經有 LINE 資料，且與傳入的 LINE user id 相同，直接返回會員資料
- ✅ 如果會員已有不同的 LINE 資料，報錯
- ✅ 只有在會員沒有 LINE 資料時，才執行關聯操作

**關鍵邏輯：**
```sql
-- 檢查該會員是否已經有 LINE 資料
IF v_member.line_user_id IS NOT NULL AND v_member.line_user_id != '' THEN
    IF v_member.line_user_id = p_line_user_id THEN
        -- 是同一個 LINE 帳號，直接返回
        RETURN v_result;
    ELSE
        -- 是不同的 LINE 帳號，不允許
        RAISE EXCEPTION '此 Email 帳號已綁定到其他 LINE 帳號';
    END IF;
END IF;
```

---

## 📊 流程圖

### LIFF 環境流程

```
LIFF 開啟
    ↓
檢查是否已登入
    ↓
取得 LINE Profile
    ↓
查找會員（透過 LINE user id）
    ↓
┌─────────────────┬──────────────────────────┐
│ 已找到會員       │ 未找到會員                │
│ （有 LINE 資料） │ （無 LINE 資料）          │
└─────────────────┴──────────────────────────┘
        ↓                      ↓
   直接登入             導向 Email 驗證頁面
   進入主頁                    ↓
                       輸入 Email
                            ↓
                   檢查 Email 是否已註冊
                            ↓
            ┌───────────────┴───────────────┐
            │                               │
        Email 已存在                  Email 不存在
            │                               │
      Email登入 + 關聯LINE            Email註冊 + 關聯LINE
            │                               │
        └───────────────┬───────────────┘
                        ↓
                    進入主頁
```

### 網頁環境流程（不變）

```
網頁開啟
    ↓
檢查是否已登入
    ↓
導向 Email 驗證頁面
    ↓
輸入 Email
    ↓
檢查 Email 是否已註冊
    ↓
┌───────────────┴───────────────┐
│                               │
Email 已存在              Email 不存在
│                               │
Email 登入                Email 註冊
│                               │
└───────────────┬───────────────┘
                ↓
            進入主頁
```

---

## ✅ 測試場景

### 場景 1：LIFF - 已註冊（有 LINE 資料）
1. 在 LINE 開啟網站
2. LIFF 自動登入
3. ✅ 找到會員資料 → 直接進入主頁

---

### 場景 2：LIFF - 未註冊
1. 在 LINE 開啟網站
2. LIFF 自動登入
3. 輸入新 Email
4. 驗證碼驗證
5. ✅ 建立新會員（帶 LINE user id）→ 進入主頁

---

### 場景 3：LIFF - 已註冊（無 LINE 資料，透過 Email 註冊的）⭐ 新增
1. 在 LINE 開啟網站
2. LIFF 自動登入
3. 輸入已註冊的 Email
4. 驗證碼驗證
5. ✅ Email登入 + 關聯 LINE user id → 進入主頁
6. ✅ 顯示「登入成功！LINE 帳號已綁定」

---

### 場景 4：網頁 - 已註冊
1. 在瀏覽器開啟網站
2. 輸入已註冊的 Email
3. 驗證碼驗證
4. ✅ Email 登入 → 進入主頁

---

### 場景 5：網頁 - 未註冊
1. 在瀏覽器開啟網站
2. 輸入新 Email
3. 驗證碼驗證
4. ✅ Email 註冊 → 進入主頁

---

## 🔍 重要改進

### 1. **智能判斷流程**
- 不再需要用戶手動選擇「登入」或「註冊」
- 系統自動根據 Email 是否存在判斷流程

### 2. **LINE 帳號關聯**
- 支援將現有的 Email 會員帳號關聯到 LINE 帳號
- 防止重複關聯或錯誤關聯

### 3. **完善的錯誤處理**
- 如果 Email 已綁定到其他 LINE 帳號，會正確報錯
- 如果 LINE 帳號已綁定到其他會員，會正確報錯

### 4. **Session 管理**
- 正確保存 LIFF access token
- 清理臨時 sessionStorage 資料

---

## 📁 修改的檔案

1. ✅ `index.html` - 保存 LIFF access token
2. ✅ `member/email-verification.html` - 優化登入/註冊邏輯和完成訊息
3. ✅ `supabase/email-verification-rpc.sql` - 優化 `link_line_account` 函數

---

## ⚠️ 注意事項

### 需要執行 SQL

請在 Supabase SQL Editor 中執行：
```sql
supabase/email-verification-rpc.sql
```

這樣 `link_line_account` 函數的更新才會生效。

---

## 🎊 總結

所有修改已完成！

新的登入模式現在完全支援：
- ✅ LIFF 環境下的三種情況
- ✅ 網頁環境下的兩種情況
- ✅ 智能判斷登入/註冊流程
- ✅ 正確關聯 LINE 帳號
- ✅ 完善的錯誤處理

**下一步：** 執行 SQL 腳本並測試所有場景！

