<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šé ç´„</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="../index.html" class="navbar-brand">NPHONE</a>
            <div class="navbar-menu">
                <a href="profile.html" class="navbar-link">å€‹äººè³‡æ–™</a>
                <a href="booking.html" class="navbar-link">ç·šä¸Šé ç´„</a>
                <button id="btn-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container-sm" style="margin-top: 40px;">
        <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 32px;">ç·šä¸Šé ç´„</h1>
        
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div style="display: flex; justify-content: space-between; margin-bottom: 32px; max-width: 600px; flex-wrap: wrap; gap: 8px;">
            <div class="booking-step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">é¸æ“‡æœå‹™</div>
            </div>
            <div class="booking-step" data-step="1.5">
                <div class="step-number">2</div>
                <div class="step-label">é¸æ“‡å‹è™Ÿ</div>
            </div>
            <div class="booking-step" data-step="2">
                <div class="step-number">3</div>
                <div class="step-label">é¸æ“‡æ—¥æœŸ</div>
            </div>
            <div class="booking-step" data-step="3">
                <div class="step-number">4</div>
                <div class="step-label">é¸æ“‡æ™‚é–“</div>
            </div>
            <div class="booking-step" data-step="4">
                <div class="step-number">5</div>
                <div class="step-label">ç¢ºèªé ç´„</div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 1: é¸æ“‡æœå‹™ -->
        <div id="step-1" class="booking-step-content active">
            <div class="card">
                <div class="card-header">é¸æ“‡æœå‹™é …ç›®</div>
                <div class="card-body" id="services-list">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 1.5: é¸æ“‡æœå‹™é¸é …ï¼ˆå¦‚æœæœå‹™æœ‰é¸é …ï¼‰ -->
        <div id="step-1.5" class="booking-step-content" style="display: none;">
            <div class="card">
                <div class="card-header" id="option-header">é¸æ“‡æ‰‹æ©Ÿå‹è™Ÿ</div>
                <div class="card-body" id="service-options-list">
                    <div class="loading-spinner"></div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #E5E7EB;">
                    <button id="btn-next-step-1.5" class="btn btn-primary" disabled>ä¸‹ä¸€æ­¥</button>
                    <button id="btn-back-step-1.5" class="btn btn-secondary" style="margin-left: 8px;">ä¸Šä¸€æ­¥</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 2: é¸æ“‡æ—¥æœŸ -->
        <div id="step-2" class="booking-step-content" style="display: none;">
            <div class="card">
                <div class="card-header">é¸æ“‡é ç´„æ—¥æœŸ</div>
                <div class="card-body">
                    <input 
                        type="date" 
                        id="booking-date" 
                        class="form-input" 
                        required
                        min=""
                    >
                    <div class="form-help">è«‹é¸æ“‡é ç´„æ—¥æœŸ</div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #E5E7EB;">
                    <button id="btn-next-step-2" class="btn btn-primary">ä¸‹ä¸€æ­¥</button>
                    <button id="btn-back-step-2" class="btn btn-secondary" style="margin-left: 8px;">ä¸Šä¸€æ­¥</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 3: é¸æ“‡æ™‚é–“ -->
        <div id="step-3" class="booking-step-content" style="display: none;">
            <div class="card">
                <div class="card-header">é¸æ“‡é ç´„æ™‚é–“</div>
                <div class="card-body" id="time-slots-list">
                    <div class="loading-spinner"></div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #E5E7EB;">
                    <button id="btn-next-step-3" class="btn btn-primary" disabled>ä¸‹ä¸€æ­¥</button>
                    <button id="btn-back-step-3" class="btn btn-secondary" style="margin-left: 8px;">ä¸Šä¸€æ­¥</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 4: ç¢ºèªé ç´„ -->
        <div id="step-4" class="booking-step-content" style="display: none;">
            <div class="card">
                <div class="card-header">ç¢ºèªé ç´„è³‡è¨Š</div>
                <div class="card-body">
                    <div class="profile-info-row">
                        <span class="profile-label">æœå‹™é …ç›®</span>
                        <span class="profile-value" id="confirm-service-name">-</span>
                    </div>
                    <div id="confirm-option-row" class="profile-info-row" style="display: none;">
                        <span class="profile-label" id="confirm-option-label">å‹è™Ÿ</span>
                        <span class="profile-value" id="confirm-service-option">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">æœå‹™æ™‚é•·</span>
                        <span class="profile-value" id="confirm-service-duration">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">æœå‹™åƒ¹æ ¼</span>
                        <span class="profile-value" id="confirm-service-price">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">é ç´„æ—¥æœŸ</span>
                        <span class="profile-value" id="confirm-booking-date">-</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="profile-label">é ç´„æ™‚é–“</span>
                        <span class="profile-value" id="confirm-booking-time">-</span>
                    </div>
                    
                    <div class="form-group" style="margin-top: 24px;">
                        <label for="booking-notes" class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                        <textarea 
                            id="booking-notes" 
                            class="form-textarea" 
                            placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤è¨»æ˜"
                            rows="3"
                        ></textarea>
                    </div>
                </div>
                <div style="padding: 16px; border-top: 1px solid #E5E7EB;">
                    <button id="btn-submit-booking" class="btn btn-success btn-block">ç¢ºèªé ç´„</button>
                    <button id="btn-back-step-4" class="btn btn-secondary btn-block" style="margin-top: 8px;">ä¸Šä¸€æ­¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        // è¼”åŠ©å‡½æ•¸ï¼šå‘å¾Œå…¼å®¹èˆŠçš„ showMessage å’Œ showLoading
        function showMessage(message, type = 'info') {
            if (typeof UI !== 'undefined') {
                UI.showToast(message, type);
            } else {
                alert(message);
            }
        }
        
        function showLoading(message) {
            if (typeof UI !== 'undefined') {
                UI.showLoading(message);
            }
        }
        
        function hideLoading() {
            if (typeof UI !== 'undefined') {
                UI.hideLoading();
            }
        }
        
        let currentStep = 1;
        let selectedService = null;
        let selectedServiceOption = null;
        let selectedDate = null;
        let selectedTime = null;
        let availableServices = [];
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!Auth.requireMemberLogin()) {
                    return;
                }
                
                // è¨­å®šæ—¥æœŸé¸æ“‡å™¨çš„æœ€å°æ—¥æœŸç‚ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('booking-date').setAttribute('min', today);
                
                // é¡¯ç¤ºéª¨æ¶å±
                const servicesList = document.getElementById('services-list');
                if (servicesList && typeof UI !== 'undefined') {
                    UI.showSkeleton(servicesList, 'card');
                }
                
                // è¼‰å…¥æœå‹™åˆ—è¡¨
                await loadServices();
                
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
                if (typeof UI !== 'undefined') {
                    UI.error('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                }
            }
        });
        
        // è¼‰å…¥æœå‹™åˆ—è¡¨
        async function loadServices() {
            try {
                // éª¨æ¶å±å·²åœ¨åˆå§‹åŒ–æ™‚é¡¯ç¤ºï¼Œä¸éœ€è¦é¡å¤–çš„è¼‰å…¥æç¤º
                availableServices = await BookingAPI.getActiveServices();
                if (availableServices.length === 0) {
                    document.getElementById('services-list').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš«ç„¡å¯é ç´„çš„æœå‹™é …ç›®</p>';
                    return;
                }
                
                // æ¨™æº–åŒ–æœå‹™è³‡æ–™ï¼ˆç¢ºä¿åƒ¹æ ¼æ¬„ä½å­˜åœ¨ï¼‰
                availableServices = availableServices.map(service => {
                    // ç¢ºä¿ base_price å­˜åœ¨ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
                    if (service.base_price === null || service.base_price === undefined) {
                        service.base_price = service.price || 0;
                    }
                    // ç‚ºäº†å‘å¾Œå…¼å®¹ï¼Œä¹Ÿä¿ç•™ price æ¬„ä½
                    if (!service.price) {
                        service.price = service.base_price || 0;
                    }
                    // ç¢ºä¿ service_options æ˜¯é™£åˆ—
                    if (!service.service_options) {
                        service.service_options = [];
                    }
                    return service;
                });
                
                // é¡¯ç¤ºæœå‹™åˆ—è¡¨
                document.getElementById('services-list').innerHTML = availableServices.map(service => `
                    <div class="service-card" data-service-id="${service.id}" onclick="selectService('${service.id}')">
                        <div class="service-info">
                            <h3>${service.name}</h3>
                            ${service.description ? `<p style="color: #86868B; margin-top: 8px;">${service.description}</p>` : ''}
                            <div style="margin-top: 16px; display: flex; gap: 16px;">
                                <span style="color: #007AFF;">â± ${service.duration} åˆ†é˜</span>
                                <span style="color: #34C759; font-weight: 600;">NT$ ${(service.base_price || service.price || 0).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™å¤±æ•—', error);
                const servicesList = document.getElementById('services-list');
                if (servicesList) {
                    servicesList.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¼‰å…¥æœå‹™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
                }
                showMessage('è¼‰å…¥æœå‹™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
            }
        }
        
        // é¸æ“‡æœå‹™
        function selectService(serviceId) {
            selectedService = availableServices.find(s => s.id === serviceId);
            
            if (!selectedService) {
                showMessage('æ‰¾ä¸åˆ°æœå‹™é …ç›®', 'error');
                return;
            }
            
            // æ›´æ–° UI
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('selected');
            });
            const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (serviceCard) {
                serviceCard.classList.add('selected');
            }
            
            // é‡ç½®é¸é …ï¼ˆç¢ºä¿æ˜¯ nullï¼Œä¸æ˜¯ undefinedï¼‰
            selectedServiceOption = null;
            
            // æª¢æŸ¥æœå‹™æ˜¯å¦éœ€è¦é¸æ“‡é¸é …
            if (selectedService.has_options && selectedService.service_options && selectedService.service_options.length > 0) {
                // éœ€è¦é¸æ“‡é¸é …ï¼Œé€²å…¥æ­¥é©Ÿ 1.5
                setTimeout(() => {
                    loadServiceOptions();
                    goToStep(1.5);
                }, 500);
            } else {
                // ä¸éœ€è¦é¸é …ï¼Œç›´æ¥é€²å…¥é¸æ“‡æ—¥æœŸ
                setTimeout(() => {
                    goToStep(2);
                }, 500);
            }
        }
        
        // è¼‰å…¥æœå‹™é¸é …
        async function loadServiceOptions() {
            try {
                if (!selectedService || !selectedService.has_options) {
                    return;
                }
                
                const options = selectedService.service_options || [];
                
                // æ›´æ–°æ¨™é¡Œ
                document.getElementById('option-header').textContent = `é¸æ“‡${selectedService.option_label || 'é¸é …'}`;
                
                if (options.length === 0) {
                    document.getElementById('service-options-list').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">æš«ç„¡å¯é¸é¸é …</p>';
                    return;
                }
                
                // é¡¯ç¤ºé¸é …åˆ—è¡¨
                document.getElementById('service-options-list').innerHTML = options
                    .filter(opt => opt.is_active !== false)
                    .map(option => {
                        const finalPrice = (selectedService.base_price || 0) + (option.price_modifier || 0);
                        const priceText = option.price_modifier 
                            ? (option.price_modifier > 0 ? `+NT$ ${option.price_modifier}` : `NT$ ${option.price_modifier}`)
                            : '';
                        
                        return `
                            <div class="service-card" data-option-id="${option.id}" onclick="selectServiceOption('${option.id}')">
                                <div class="service-info">
                                    <h3>${option.name}</h3>
                                    ${priceText ? `<p style="color: #007AFF; margin-top: 8px;">${priceText}</p>` : ''}
                                    <p style="color: #86868B; margin-top: 8px; font-size: 14px;">
                                        ç¸½åƒ¹ï¼šNT$ ${finalPrice.toLocaleString()}
                                    </p>
                                </div>
                            </div>
                        `;
                    }).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™é¸é …å¤±æ•—', error);
                showMessage('è¼‰å…¥é¸é …å¤±æ•—', 'error');
            }
        }
        
        // é¸æ“‡æœå‹™é¸é …
        function selectServiceOption(optionId) {
            if (!selectedService || !selectedService.service_options) {
                showMessage('ç„¡æ³•é¸æ“‡é¸é …', 'error');
                return;
            }
            
            const option = selectedService.service_options.find(opt => opt.id === optionId);
            if (!option) {
                showMessage('æ‰¾ä¸åˆ°é¸é …', 'error');
                return;
            }
            
            selectedServiceOption = option;
            
            // æ›´æ–° UI
            document.querySelectorAll('[data-option-id]').forEach(card => {
                card.classList.remove('selected');
            });
            const optionCard = document.querySelector(`[data-option-id="${optionId}"]`);
            if (optionCard) {
                optionCard.classList.add('selected');
            }
            
            // å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
            const nextBtn = document.getElementById('btn-next-step-1.5');
            if (nextBtn) {
                nextBtn.disabled = false;
            }
        }
        
        // é€²å…¥ä¸‹ä¸€æ­¥
        function goToStep(step) {
            // éš±è—æ‰€æœ‰æ­¥é©Ÿ
            document.querySelectorAll('.booking-step-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // é¡¯ç¤ºç•¶å‰æ­¥é©Ÿ
            const stepElement = document.getElementById(`step-${step}`);
            if (stepElement) {
                stepElement.classList.add('active');
                stepElement.style.display = 'block';
            }
            
            // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
            document.querySelectorAll('.booking-step').forEach((stepEl) => {
                stepEl.classList.remove('active');
                const stepNum = parseFloat(stepEl.getAttribute('data-step'));
                if (stepNum <= parseFloat(step)) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
            
            // ç‰¹æ®Šè™•ç†
            if (step === 3 && selectedDate) {
                loadTimeSlots();
            } else if (step === 4) {
                displayConfirmation();
            }
        }
        
        // æ—¥æœŸé¸æ“‡äº‹ä»¶
        document.getElementById('booking-date').addEventListener('change', (e) => {
            selectedDate = e.target.value;
        });
        
        // æ­¥é©Ÿ 1.5 ä¸‹ä¸€æ­¥
        document.getElementById('btn-next-step-1.5').addEventListener('click', () => {
            if (!selectedServiceOption) {
                showMessage('è«‹é¸æ“‡é¸é …', 'warning');
                return;
            }
            goToStep(2);
        });
        
        // æ­¥é©Ÿ 1.5 ä¸Šä¸€æ­¥
        document.getElementById('btn-back-step-1.5').addEventListener('click', () => {
            goToStep(1);
        });
        
        // æ­¥é©Ÿ 2 ä¸‹ä¸€æ­¥
        document.getElementById('btn-next-step-2').addEventListener('click', () => {
            const date = document.getElementById('booking-date').value;
            if (!date) {
                showMessage('è«‹é¸æ“‡é ç´„æ—¥æœŸ', 'warning');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†ä»Šå¤©çš„æ—¥æœŸï¼Œå¦‚æœæ˜¯ä¸”ç•¶å‰æ™‚é–“å·²æ™šï¼Œçµ¦å‡ºæç¤º
            const today = new Date().toISOString().split('T')[0];
            if (date === today) {
                const now = new Date();
                const currentHour = now.getHours();
                // å¦‚æœå·²ç¶“å¾ˆæ™šäº†ï¼ˆä¾‹å¦‚æ™šä¸Š 8 é»ä¹‹å¾Œï¼‰ï¼Œæç¤ºå»ºè­°é¸æ“‡æ˜å¤©
                if (currentHour >= 20) {
                    if (!confirm('ä»Šå¤©å·²ç¶“å¾ˆæ™šäº†ï¼Œå»ºè­°é¸æ“‡æ˜å¤©ä¹‹å¾Œçš„æ—¥æœŸã€‚\n\næ˜¯å¦è¦ç¹¼çºŒé¸æ“‡ä»Šå¤©ï¼Ÿ')) {
                        return;
                    }
                }
            }
            
            selectedDate = date;
            goToStep(3);
        });
        
        // æ­¥é©Ÿ 3 è¼‰å…¥æ™‚é–“æ®µ
        async function loadTimeSlots() {
            try {
                document.getElementById('time-slots-list').innerHTML = '<div class="loading-spinner"></div>';
                
                const slots = await BookingAPI.getAvailableTimeSlots(selectedDate, selectedService.duration);
                
                if (slots.length === 0) {
                    document.getElementById('time-slots-list').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ç•¶å¤©ç„¡å¯ç”¨æ™‚é–“æ®µï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ</p>';
                    return;
                }
                
                // éæ¿¾å·²éæ™‚é–“ï¼šå¦‚æœé¸æ“‡çš„æ˜¯ä»Šå¤©ï¼Œå‰‡éæ¿¾æ‰ç•¶å‰æ™‚é–“ä¹‹å‰çš„æ™‚é–“æ®µ
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().slice(0, 5); // HH:MM
                
                let availableSlots = slots;
                
                // å¦‚æœé¸æ“‡çš„æ˜¯ä»Šå¤©ï¼Œéæ¿¾æ‰å·²éæ™‚é–“
                if (selectedDate === today) {
                    availableSlots = slots.filter(slot => {
                        // slot å¯èƒ½æ˜¯å­—ä¸²æˆ–å°è±¡ï¼Œæå–æ™‚é–“
                        const slotTime = typeof slot === 'string' ? slot : (slot.time_slot || slot);
                        return slotTime > currentTime;
                    });
                }
                
                if (availableSlots.length === 0) {
                    document.getElementById('time-slots-list').innerHTML = `
                        <p style="text-align: center; color: #999; padding: 40px;">
                            ${selectedDate === today ? 'ä»Šå¤©çš„å¯ç”¨æ™‚é–“å·²éï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸæˆ–æ˜å¤©ä¹‹å¾Œ' : 'ç•¶å¤©ç„¡å¯ç”¨æ™‚é–“æ®µï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ'}
                        </p>
                    `;
                    return;
                }
                
                document.getElementById('time-slots-list').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;">
                        ${availableSlots.map(slot => {
                            // æå–æ™‚é–“å­—ä¸²
                            const slotTime = typeof slot === 'string' ? slot : (slot.time_slot || slot);
                            return `
                                <button class="time-slot-btn" data-time="${slotTime}" onclick="selectTime('${slotTime}')">
                                    ${slotTime}
                                </button>
                            `;
                        }).join('')}
                    </div>
                `;
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æ™‚é–“æ®µå¤±æ•—', error);
                document.getElementById('time-slots-list').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¼‰å…¥æ™‚é–“æ®µå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
                if (typeof UI !== 'undefined') {
                    UI.error('è¼‰å…¥æ™‚é–“æ®µå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }
        }
        
        // é¸æ“‡æ™‚é–“
        function selectTime(time) {
            selectedTime = time;
            
            // æ›´æ–° UI
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-time="${time}"]`).classList.add('selected');
            
            // å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
            document.getElementById('btn-next-step-3').disabled = false;
        }
        
        // æ­¥é©Ÿ 3 ä¸‹ä¸€æ­¥
        document.getElementById('btn-next-step-3').addEventListener('click', () => {
            if (!selectedTime) {
                showMessage('è«‹é¸æ“‡é ç´„æ™‚é–“', 'warning');
                return;
            }
            
            // é©—è­‰æ™‚é–“æ˜¯å¦å·²éï¼ˆå¦‚æœæ˜¯ä»Šå¤©ï¼‰
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate === today) {
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5); // HH:MM
                if (selectedTime <= currentTime) {
                    showMessage('ç„¡æ³•é ç´„å·²éçš„æ™‚é–“ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“', 'warning');
                    return;
                }
            }
            
            goToStep(4);
        });
        
        // é¡¯ç¤ºç¢ºèªè³‡è¨Š
        function displayConfirmation() {
            let finalPrice = selectedService.base_price || selectedService.price || 0;
            let serviceName = selectedService.name;
            
            // é¡¯ç¤ºæœå‹™é¸é …ï¼ˆå¦‚æœæœ‰ï¼‰
            if (selectedServiceOption) {
                finalPrice = finalPrice + (selectedServiceOption.price_modifier || 0);
                document.getElementById('confirm-option-row').style.display = 'flex';
                document.getElementById('confirm-option-label').textContent = selectedService.option_label || 'é¸é …';
                document.getElementById('confirm-service-option').textContent = selectedServiceOption.name;
            } else {
                document.getElementById('confirm-option-row').style.display = 'none';
            }
            
            document.getElementById('confirm-service-name').textContent = serviceName;
            document.getElementById('confirm-service-duration').textContent = `${selectedService.duration} åˆ†é˜`;
            document.getElementById('confirm-service-price').textContent = `NT$ ${finalPrice.toLocaleString()}`;
            document.getElementById('confirm-booking-date').textContent = formatDateDisplay(selectedDate);
            document.getElementById('confirm-booking-time').textContent = selectedTime;
        }
        
        // æäº¤é ç´„
        document.getElementById('btn-submit-booking').addEventListener('click', async () => {
            try {
                if (!Auth.isMemberLoggedIn()) {
                    alert('è«‹å…ˆç™»å…¥');
                    return;
                }
                
                // é©—è­‰å¿…è¦è³‡æ–™
                if (!selectedService || !selectedService.id) {
                    showMessage('è«‹é¸æ“‡æœå‹™é …ç›®', 'error');
                    return;
                }
                
                // é©—è­‰æœå‹™ ID æ ¼å¼
                const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (!uuidPattern.test(selectedService.id)) {
                    CONFIG.error('ç„¡æ•ˆçš„æœå‹™ ID', selectedService.id);
                    showMessage('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                    return;
                }
                
                if (!selectedDate) {
                    showMessage('è«‹é¸æ“‡é ç´„æ—¥æœŸ', 'error');
                    return;
                }
                
                if (!selectedTime) {
                    showMessage('è«‹é¸æ“‡é ç´„æ™‚é–“', 'error');
                    return;
                }
                
                // é©—è­‰æ™‚é–“æ˜¯å¦å·²éï¼ˆå¦‚æœæ˜¯ä»Šå¤©ï¼‰
                const today = new Date().toISOString().split('T')[0];
                if (selectedDate === today) {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5); // HH:MM
                    if (selectedTime <= currentTime) {
                        showMessage('ç„¡æ³•é ç´„å·²éçš„æ™‚é–“ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“', 'error');
                        return;
                    }
                }
                
                // å¦‚æœæœå‹™éœ€è¦é¸é …ä½†æœªé¸æ“‡
                if (selectedService.has_options && !selectedServiceOption) {
                    showMessage(`è«‹é¸æ“‡${selectedService.option_label || 'é¸é …'}`, 'error');
                    return;
                }
                
                const session = Auth.getMemberSession();
                const notes = document.getElementById('booking-notes').value.trim() || null;
                
                showLoading('å»ºç«‹é ç´„ä¸­...');
                
                // ç¢ºä¿æ—¥æœŸæ ¼å¼æ­£ç¢ºï¼ˆYYYY-MM-DDï¼‰
                const bookingDate = selectedDate instanceof Date 
                    ? selectedDate.toISOString().split('T')[0]
                    : selectedDate;
                
                // ç¢ºä¿æ™‚é–“æ ¼å¼æ­£ç¢ºï¼ˆHH:MM:SS æˆ– HH:MMï¼‰
                let bookingTime = selectedTime;
                if (!bookingTime.includes(':')) {
                    bookingTime = '00:00:00';
                } else if (bookingTime.split(':').length === 2) {
                    bookingTime = bookingTime + ':00';
                }
                
                // æœ€çµ‚é©—è­‰ï¼šç¢ºä¿ serviceId ä¸æ˜¯ "0" æˆ–ç„¡æ•ˆå€¼
                if (!selectedService.id || selectedService.id === '0' || selectedService.id === 0 || String(selectedService.id).trim() === '0') {
                    CONFIG.error('âŒ æœå‹™ ID ç„¡æ•ˆ', {
                        serviceId: selectedService.id,
                        selectedService: selectedService
                    });
                    showMessage('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                    return;
                }
                
                // é©—è­‰ serviceId æ˜¯æœ‰æ•ˆçš„ UUID æ ¼å¼
                const serviceIdStr = String(selectedService.id).trim();
                if (!uuidPattern.test(serviceIdStr)) {
                    CONFIG.error('âŒ æœå‹™ ID æ ¼å¼éŒ¯èª¤', {
                        serviceId: selectedService.id,
                        serviceIdStr: serviceIdStr
                    });
                    showMessage('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                    return;
                }
                
                // ç¢ºä¿ serviceOptionId æ˜¯æœ‰æ•ˆçš„ UUID æˆ– null
                let serviceOptionId = null;
                if (selectedServiceOption && selectedServiceOption.id) {
                    const optionId = String(selectedServiceOption.id).trim();
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç„¡æ•ˆå€¼
                    if (optionId && 
                        optionId !== '0' && 
                        optionId !== '' && 
                        optionId !== 'null' && 
                        optionId !== 'undefined' &&
                        optionId !== 'false') {
                        // é©—è­‰ UUID æ ¼å¼
                        if (uuidPattern.test(optionId)) {
                            serviceOptionId = optionId;
                            CONFIG.log('âœ… æœå‹™é¸é … ID é©—è­‰é€šé', serviceOptionId);
                        } else {
                            CONFIG.error('âŒ ç„¡æ•ˆçš„æœå‹™é¸é … ID æ ¼å¼', {
                                original: selectedServiceOption.id,
                                trimmed: optionId
                            });
                            showMessage('æœå‹™é¸é …è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                            return;
                        }
                    } else {
                        // å¦‚æœé¸é … ID æ˜¯ç„¡æ•ˆå€¼ï¼Œè¨˜éŒ„ä½†ä¸å‚³é
                        CONFIG.log('âš ï¸ æœå‹™é¸é … ID ç‚ºç„¡æ•ˆå€¼ï¼Œå°‡ä¸å‚³éæ­¤åƒæ•¸', {
                            original: selectedServiceOption.id,
                            trimmed: optionId
                        });
                        serviceOptionId = null;
                    }
                }
                
                // æœ€çµ‚æª¢æŸ¥ï¼šç¢ºä¿ serviceOptionId ä¸æ˜¯ "0"
                if (serviceOptionId === '0' || serviceOptionId === 0 || String(serviceOptionId).trim() === '0') {
                    CONFIG.error('âŒ æœå‹™é¸é … ID ç‚º "0"ï¼Œå°‡å…¶è¨­ç‚º null', serviceOptionId);
                    serviceOptionId = null;
                }
                
                // æœ€çµ‚é©—è­‰æ‰€æœ‰åƒæ•¸
                CONFIG.log('ğŸ“‹ å»ºç«‹é ç´„åƒæ•¸ï¼ˆæœ€çµ‚æª¢æŸ¥ï¼‰', {
                    lineUserId: session.lineUserId,
                    serviceId: serviceIdStr,
                    serviceIdType: typeof serviceIdStr,
                    serviceIdIsValid: uuidPattern.test(serviceIdStr),
                    bookingDate: bookingDate,
                    bookingTime: bookingTime,
                    serviceOptionId: serviceOptionId,
                    serviceOptionIdType: typeof serviceOptionId,
                    serviceOptionIdIsNull: serviceOptionId === null,
                    serviceOptionIdIsValid: serviceOptionId ? uuidPattern.test(String(serviceOptionId)) : true,
                    notes: notes
                });
                
                // æœ€å¾Œä¸€æ¬¡æª¢æŸ¥ï¼šç¢ºä¿ serviceId çµ•å°ä¸æ˜¯ "0"
                if (serviceIdStr === '0') {
                    CONFIG.error('âŒâŒâŒ è‡´å‘½éŒ¯èª¤ï¼šserviceId ä»ç„¶æ˜¯ "0"', {
                        selectedService: selectedService,
                        serviceIdStr: serviceIdStr
                    });
                    showMessage('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡', 'error');
                    return;
                }
                
                const booking = await BookingAPI.createBooking(
                    session.lineUserId,
                    serviceIdStr,  // ä½¿ç”¨å·²é©—è­‰çš„ serviceIdStr
                    bookingDate,
                    bookingTime,
                    serviceOptionId,  // é€™å·²ç¶“æ˜¯ null æˆ–æœ‰æ•ˆçš„ UUID å­—ä¸²
                    notes
                );
                
                    hideLoading();
                    showMessage('é ç´„æˆåŠŸï¼', 'success');
                    
                    // å»¶é²å¾Œè·³è½‰åˆ°é ç´„åˆ—è¡¨
                
                // 2 ç§’å¾Œå°å‘é ç´„è¨˜éŒ„é é¢
                setTimeout(() => {
                    window.location.href = 'bookings.html';
                }, 2000);
                
            } catch (error) {
                hideLoading();
                CONFIG.error('é ç´„å¤±æ•—', error);
                
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
                let errorMessage = 'é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.error_description) {
                    errorMessage = error.error_description;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }
                
                showMessage(errorMessage, 'error');
            }
        });
        
        // ä¸Šä¸€æ­¥æŒ‰éˆ•
        document.getElementById('btn-back-step-2').addEventListener('click', () => goToStep(1));
        document.getElementById('btn-back-step-3').addEventListener('click', () => goToStep(2));
        document.getElementById('btn-back-step-4').addEventListener('click', () => goToStep(3));
        
        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatDateDisplay(dateString) {
            const date = new Date(dateString);
            const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${date.getFullYear()}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
        }
    </script>
    
    <style>
        .booking-step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .booking-step::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: #E5E7EB;
            z-index: 0;
        }
        
        .booking-step:last-child::after {
            display: none;
        }
        
        .booking-step.active::after {
            background: #007AFF;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #E5E7EB;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        
        .booking-step.active .step-number {
            background: #007AFF;
            color: white;
        }
        
        .step-label {
            font-size: 12px;
            color: #999;
        }
        
        .booking-step.active .step-label {
            color: #007AFF;
            font-weight: 600;
        }
        
        .service-card {
            padding: 20px;
            border: 2px solid #E5E7EB;
            border-radius: var(--radius);
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .service-card:hover {
            border-color: #007AFF;
            box-shadow: var(--shadow-md);
        }
        
        .service-card.selected {
            border-color: #007AFF;
            background: rgba(0, 122, 255, 0.05);
        }
        
        .time-slot-btn {
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: var(--radius-sm);
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }
        
        .time-slot-btn:hover {
            border-color: #007AFF;
        }
        
        .time-slot-btn.selected {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }
    </style>
</body>
</html>

