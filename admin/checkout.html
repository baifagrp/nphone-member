<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>結帳管理 - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- 導航列 -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">首頁</a>
                <a href="members.html" class="navbar-link">會員管理</a>
                <a href="bookings.html" class="navbar-link">預約管理</a>
                <a href="services.html" class="navbar-link">服務項目</a>
                <a href="checkout.html" class="navbar-link active">結帳管理</a>
                <a href="wallet-points.html" class="navbar-link">儲值金與積分</a>
                <a href="business-hours.html" class="navbar-link">營業時間</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">登出</button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container-sm" style="margin-top: 40px;">
        <div class="flex-between" style="margin-bottom: 24px;">
            <h1 style="font-size: 32px; font-weight: 700;">結帳管理</h1>
            <button id="btn-new-transaction" class="btn btn-success">+ 新增交易</button>
        </div>
        
        <!-- 結帳表單 -->
        <div id="checkout-form" class="card" style="margin-bottom: 24px; display: none;">
            <h2 style="font-size: 24px; margin-bottom: 24px;" id="form-title">新增交易</h2>
            
            <!-- 會員選擇 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="member-select" class="form-label">選擇會員 <span style="color: #FF3B30;">*</span></label>
                <select id="member-select" class="form-input" required>
                    <option value="">請選擇會員</option>
                </select>
            </div>
            
            <!-- 預約選擇（可選） -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="booking-select" class="form-label">關聯預約（選填）</label>
                <select id="booking-select" class="form-input">
                    <option value="">不關聯預約</option>
                </select>
                <div id="booking-preview" style="margin-top: 12px; padding: 16px; background: #F5F5F7; border-radius: 8px; display: none;">
                    <!-- 動態載入預約詳情 -->
                </div>
            </div>
            
            <!-- 會員儲值金資訊 -->
            <div id="member-wallet-info" class="form-group" style="margin-bottom: 24px; padding: 16px; background: #F0F9FF; border: 1px solid #B3E5FC; border-radius: 8px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 600; color: #0277BD;">儲值金餘額</span>
                    <span id="wallet-balance-display" style="font-size: 18px; font-weight: 700; color: #0277BD;">NT$ 0</span>
                </div>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="use-wallet-payment" style="width: 18px; height: 18px; cursor: pointer;">
                    <span style="font-weight: 500;">使用儲值金付款</span>
                </label>
                <div id="wallet-payment-amount-group" style="margin-top: 12px; display: none;">
                    <label for="wallet-payment-amount" class="form-label">使用儲值金金額</label>
                    <input 
                        type="number" 
                        id="wallet-payment-amount" 
                        class="form-input" 
                        step="0.01"
                        min="0"
                        placeholder="0"
                        style="margin-top: 8px;"
                    >
                    <div style="margin-top: 8px; font-size: 13px; color: #666;">
                        <span id="remaining-amount-display">剩餘需付：NT$ 0</span>
                    </div>
                </div>
            </div>
            
            <!-- 交易類型 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="transaction-type" class="form-label">交易類型 <span style="color: #FF3B30;">*</span></label>
                <select id="transaction-type" class="form-input" required>
                    <option value="payment">付款</option>
                    <option value="refund">退款</option>
                </select>
            </div>
            
            <!-- 金額 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="amount" class="form-label">金額 <span style="color: #FF3B30;">*</span></label>
                <input 
                    type="number" 
                    id="amount" 
                    class="form-input" 
                    step="0.01"
                    min="0.01"
                    required
                    placeholder="請輸入金額"
                >
            </div>
            
            <!-- 折扣金額（可選） -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="discount-amount" class="form-label">折扣金額（選填）</label>
                <input 
                    type="number" 
                    id="discount-amount" 
                    class="form-input" 
                    step="0.01"
                    min="0"
                    value="0"
                    placeholder="0"
                >
            </div>
            
            <!-- 付款方式 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="payment-method" class="form-label">付款方式 <span style="color: #FF3B30;">*</span></label>
                <select id="payment-method" class="form-input" required>
                    <option value="">請選擇付款方式</option>
                </select>
            </div>
            
            <!-- 交易描述 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="description" class="form-label">交易描述（選填）</label>
                <input 
                    type="text" 
                    id="description" 
                    class="form-input" 
                    placeholder="例如：服務費用、退款說明等"
                >
            </div>
            
            <!-- 收據編號（可選，系統會自動生成） -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="receipt-number" class="form-label">收據編號（選填，留空將自動生成）</label>
                <input 
                    type="text" 
                    id="receipt-number" 
                    class="form-input" 
                    placeholder="留空將自動生成"
                >
            </div>
            
            <!-- 參考編號（可選） -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="reference-number" class="form-label">參考編號（選填）</label>
                <input 
                    type="text" 
                    id="reference-number" 
                    class="form-input" 
                    placeholder="例如：信用卡授權碼、轉帳帳號等"
                >
            </div>
            
            <!-- 備註 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="notes" class="form-label">備註（選填）</label>
                <textarea 
                    id="notes" 
                    class="form-input" 
                    rows="3"
                    placeholder="客戶可見的備註"
                ></textarea>
            </div>
            
            <!-- 管理員備註 -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="admin-notes" class="form-label">管理員備註（選填）</label>
                <textarea 
                    id="admin-notes" 
                    class="form-input" 
                    rows="3"
                    placeholder="僅管理員可見的備註"
                ></textarea>
            </div>
            
            <!-- 按鈕 -->
            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button id="btn-cancel-form" class="btn btn-secondary" style="flex: 1;">取消</button>
                <button id="btn-submit-transaction" class="btn btn-success" style="flex: 2;">確認交易</button>
            </div>
        </div>
        
        <!-- 交易記錄列表 -->
        <div id="transactions-list">
            <!-- 動態載入 -->
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/wallet-points.js"></script>
    <script src="../js/checkout.js"></script>
    
    <script>
        let allMembers = [];
        let memberBookings = [];
        
        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) {
                    return;
                }
                
                await loadMembers();
                await loadPaymentMethods();
                await loadAllTransactions();
                
                // 綁定事件
                setupEventListeners();
                
            } catch (error) {
                CONFIG.error('初始化失敗', error);
            }
        });
        
        // 設定事件監聽器
        function setupEventListeners() {
            // 新增交易按鈕
            document.getElementById('btn-new-transaction').addEventListener('click', () => {
                resetForm(); // 確保表單是乾淨的
                showCheckoutForm();
            });
            
            // 取消表單
            document.getElementById('btn-cancel-form').addEventListener('click', () => {
                hideCheckoutForm();
                resetForm();
            });
            
            // 會員選擇變更
            document.getElementById('member-select').addEventListener('change', async (e) => {
                const memberSelect = e.target;
                const selectedOption = memberSelect.options[memberSelect.selectedIndex];
                const memberId = selectedOption.getAttribute('data-member-id'); // 使用 data-member-id 獲取 UUID
                const lineUserId = e.target.value; // value 是 line_user_id
                
                if (memberId || lineUserId) {
                    await loadMemberBookings(memberId || lineUserId);
                    // 載入會員儲值金資訊
                    await loadMemberWalletInfo(lineUserId);
                } else {
                    document.getElementById('booking-select').innerHTML = '<option value="">不關聯預約</option>';
                    document.getElementById('booking-preview').style.display = 'none';
                    document.getElementById('member-wallet-info').style.display = 'none';
                }
            });
            
            // 使用儲值金付款 checkbox
            document.getElementById('use-wallet-payment').addEventListener('change', (e) => {
                const walletAmountGroup = document.getElementById('wallet-payment-amount-group');
                if (e.target.checked) {
                    walletAmountGroup.style.display = 'block';
                    updateRemainingAmount();
                } else {
                    walletAmountGroup.style.display = 'none';
                    document.getElementById('wallet-payment-amount').value = '';
                    updateRemainingAmount();
                }
            });
            
            // 儲值金金額輸入變化時更新剩餘金額
            document.getElementById('wallet-payment-amount').addEventListener('input', updateRemainingAmount);
            document.getElementById('amount').addEventListener('input', updateRemainingAmount);
            document.getElementById('discount-amount').addEventListener('input', updateRemainingAmount);
            
            // 預約選擇變更
            document.getElementById('booking-select').addEventListener('change', (e) => {
                const bookingId = e.target.value;
                if (bookingId) {
                    displayBookingPreview(bookingId);
                } else {
                    document.getElementById('booking-preview').style.display = 'none';
                }
            });
            
            // 交易類型變更
            document.getElementById('transaction-type').addEventListener('change', (e) => {
                const type = e.target.value;
                if (type === 'refund') {
                    document.getElementById('form-title').textContent = '新增退款';
                } else {
                    document.getElementById('form-title').textContent = '新增交易';
                }
            });
            
            // 提交交易
            document.getElementById('btn-submit-transaction').addEventListener('click', async () => {
                await submitTransaction();
            });
            
            // 管理員登出
            document.getElementById('btn-admin-logout').addEventListener('click', () => {
                Auth.adminLogout();
            });
        }
        
        // 載入會員列表
        async function loadMembers() {
            try {
                // 使用 MemberAPI.getAll 獲取所有會員（設置一個很大的 limit 來獲取所有會員）
                const result = await MemberAPI.getAll(1000, 0);
                allMembers = result.members || [];
                
                const memberSelect = document.getElementById('member-select');
                memberSelect.innerHTML = '<option value="">請選擇會員</option>' +
                    allMembers.map(member => `
                        <option value="${member.line_user_id}" data-member-id="${member.id}">${member.name} (${member.phone || '無電話'})</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('載入會員列表失敗', error);
                showMessage('載入會員列表失敗', 'error');
            }
        }
        
        // 載入付款方式
        async function loadPaymentMethods() {
            try {
                const methods = await CheckoutAPI.getActivePaymentMethods();
                
                const paymentMethodSelect = document.getElementById('payment-method');
                paymentMethodSelect.innerHTML = '<option value="">請選擇付款方式</option>' +
                    methods.map(method => `
                        <option value="${method.code}">${method.name}</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('載入付款方式失敗', error);
                showMessage('載入付款方式失敗', 'error');
            }
        }
        
        // 載入會員儲值金資訊
        async function loadMemberWalletInfo(lineUserId) {
            try {
                const wallet = await WalletPointsAPI.getMemberWallet(lineUserId);
                const walletInfo = document.getElementById('member-wallet-info');
                const balanceDisplay = document.getElementById('wallet-balance-display');
                
                if (wallet && wallet.balance > 0) {
                    balanceDisplay.textContent = WalletPointsAPI.formatAmount(wallet.balance);
                    walletInfo.style.display = 'block';
                    
                    // 設置儲值金金額的最大值
                    const walletAmountInput = document.getElementById('wallet-payment-amount');
                    walletAmountInput.setAttribute('max', wallet.balance);
                } else {
                    balanceDisplay.textContent = 'NT$ 0';
                    walletInfo.style.display = 'none';
                }
            } catch (error) {
                CONFIG.error('載入儲值金資訊失敗', error);
                // 不顯示錯誤訊息，因為這不是關鍵功能
            }
        }
        
        // 更新剩餘需付金額
        function updateRemainingAmount() {
            const amountInput = document.getElementById('amount');
            const discountInput = document.getElementById('discount-amount');
            const walletAmountInput = document.getElementById('wallet-payment-amount');
            const remainingDisplay = document.getElementById('remaining-amount-display');
            
            const amount = parseFloat(amountInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const walletAmount = parseFloat(walletAmountInput.value) || 0;
            
            const totalAmount = amount + discount;
            const remaining = Math.max(0, totalAmount - walletAmount);
            
            remainingDisplay.textContent = `剩餘需付：NT$ ${remaining.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // 載入會員的預約
        async function loadMemberBookings(memberId) {
            try {
                const member = allMembers.find(m => m.id === memberId || m.line_user_id === memberId);
                if (!member) {
                    CONFIG.error('找不到會員資料', { memberId, allMembers });
                    return;
                }
                
                // 使用管理員 API 獲取該會員的所有預約（因為管理員應該能看到所有預約）
                const client = getSupabase();
                const { data: bookingsData, error } = await client
                    .from('bookings')
                    .select('*')
                    .eq('member_id', member.id)
                    .order('booking_date', { ascending: false })
                    .order('booking_time', { ascending: false })
                    .limit(100);
                
                if (error) {
                    CONFIG.error('查詢預約失敗', error);
                    // 如果管理員查詢失敗，嘗試使用會員 API
                    const bookings = await BookingAPI.getMyBookings(member.line_user_id, 100);
                    memberBookings = bookings || [];
                } else {
                    // 確保有 payment_status 和 paid_amount（如果資料庫中沒有，設為預設值）
                    memberBookings = (bookingsData || []).map(b => ({
                        ...b,
                        payment_status: b.payment_status || 'unpaid',
                        paid_amount: b.paid_amount || 0
                    }));
                }
                
                // 過濾：只顯示未取消的預約
                memberBookings = memberBookings.filter(b => 
                    b.status !== 'cancelled'
                );
                
                // 檢查每個預約是否已有付款交易
                for (const booking of memberBookings) {
                    const { data: payments } = await client
                        .from('transactions')
                        .select('id')
                        .eq('booking_id', booking.id)
                        .eq('transaction_type', 'payment')
                        .eq('status', 'completed')
                        .limit(1);
                    
                    booking.hasPayment = (payments && payments.length > 0);
                }
                
                const bookingSelect = document.getElementById('booking-select');
                const editId = document.getElementById('checkout-form').getAttribute('data-edit-id');
                
                if (memberBookings.length === 0) {
                    bookingSelect.innerHTML = '<option value="">該會員尚無可關聯的預約</option>';
                } else {
                    bookingSelect.innerHTML = '<option value="">不關聯預約</option>' +
                        memberBookings.map(booking => {
                            const paymentStatusText = booking.payment_status === 'unpaid' ? '未付款' :
                                                      booking.payment_status === 'partial' ? '部分付款' :
                                                      booking.payment_status === 'paid' ? '已付款' :
                                                      booking.payment_status === 'refunded' ? '已退款' : '未知';
                            
                            // 如果是編輯模式，允許選擇已結帳的預約；否則禁用已結帳的預約
                            const hasPayment = booking.hasPayment || booking.payment_status === 'paid';
                            const isDisabled = hasPayment && !editId;
                            
                            return `
                                <option value="${booking.id}" ${isDisabled ? 'disabled' : ''}>${booking.service_name} - ${booking.booking_date} ${booking.booking_time} (NT$ ${booking.service_price.toLocaleString()}) [${paymentStatusText}]${hasPayment && !editId ? ' [已結帳]' : ''}</option>
                            `;
                        }).join('');
                }
                
                CONFIG.log('載入預約成功', { 
                    memberId: member.id, 
                    memberName: member.name,
                    bookingsCount: memberBookings.length 
                });
                
            } catch (error) {
                CONFIG.error('載入預約失敗', error);
                showMessage('載入預約失敗：' + (error.message || '未知錯誤'), 'error');
                document.getElementById('booking-select').innerHTML = '<option value="">載入預約失敗</option>';
            }
        }
        
        // 顯示預約預覽
        function displayBookingPreview(bookingId) {
            const booking = memberBookings.find(b => b.id === bookingId);
            if (!booking) {
                CONFIG.error('找不到預約資料', { bookingId, memberBookings });
                return;
            }
            
            // 確保有預設值
            const paymentStatus = booking.payment_status || 'unpaid';
            const paidAmount = booking.paid_amount || 0;
            const servicePrice = booking.service_price || 0;
            
            const paymentStatusText = paymentStatus === 'unpaid' ? '未付款' :
                                      paymentStatus === 'partial' ? '部分付款' :
                                      paymentStatus === 'paid' ? '已付款' :
                                      paymentStatus === 'refunded' ? '已退款' : '未知';
            
            const preview = document.getElementById('booking-preview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="color: #86868B; font-size: 12px;">服務</div>
                        <div style="font-weight: 600;">${booking.service_name || '未知'}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">日期時間</div>
                        <div style="font-weight: 600;">${booking.booking_date || ''} ${booking.booking_time || ''}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">金額</div>
                        <div style="font-weight: 600;">NT$ ${servicePrice.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">付款狀態</div>
                        <div style="font-weight: 600;">${paymentStatusText}</div>
                    </div>
                </div>
                ${paidAmount > 0 ? `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #D2D2D7;">
                        <div style="color: #86868B; font-size: 12px;">已付金額</div>
                        <div style="font-weight: 600; color: #34C759;">NT$ ${paidAmount.toLocaleString()}</div>
                    </div>
                ` : ''}
            `;
            
            // 自動填入金額（如果沒有填寫且不是已付款）
            if (!document.getElementById('amount').value && paymentStatus !== 'paid') {
                const remaining = servicePrice - paidAmount;
                if (remaining > 0) {
                    document.getElementById('amount').value = remaining.toFixed(2);
                }
            }
        }
        
        // 載入所有交易記錄
        async function loadAllTransactions() {
            try {
                // 顯示骨架屏
                const transactionsList = document.getElementById('transactions-list');
                if (transactionsList && typeof UI !== 'undefined') {
                    UI.showSkeleton(transactionsList, 'list');
                }
                
                const client = getSupabase();
                
                // 先查詢交易記錄
                const { data: transactions, error } = await client
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                // 分別查詢會員和預約資料，避免關聯關係衝突
                const transactionsWithRelations = await Promise.all((transactions || []).map(async (transaction) => {
                    // 查詢會員資料
                    if (transaction.member_id) {
                        const { data: member } = await client
                            .from('members')
                            .select('line_user_id, name, phone')
                            .eq('id', transaction.member_id)
                            .single();
                        
                        transaction.members = member || null;
                    }
                    
                    // 查詢預約資料
                    if (transaction.booking_id) {
                        const { data: booking } = await client
                            .from('bookings')
                            .select('id, service_name, booking_date, booking_time')
                            .eq('id', transaction.booking_id)
                            .single();
                        
                        transaction.bookings = booking || null;
                    }
                    
                    return transaction;
                }));
                
                displayTransactions(transactionsWithRelations);
                
            } catch (error) {
                CONFIG.error('載入交易記錄失敗', error);
                showMessage('載入交易記錄失敗', 'error');
            }
        }
        
        // 顯示交易記錄
        function displayTransactions(transactions) {
            const transactionsList = document.getElementById('transactions-list');
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>尚無交易記錄</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            transactionsList.innerHTML = transactions.map(transaction => {
                const typeMap = {
                    'payment': { text: '付款', class: 'status-success' },
                    'refund': { text: '退款', class: 'status-error' },
                    'deposit': { text: '儲值', class: 'status-info' },
                    'withdrawal': { text: '提領', class: 'status-warning' },
                };
                const statusMap = {
                    'pending': { text: '待處理', class: 'status-warning' },
                    'completed': { text: '已完成', class: 'status-success' },
                    'failed': { text: '失敗', class: 'status-error' },
                    'cancelled': { text: '已取消', class: 'status-gray' },
                    'refunded': { text: '已退款', class: 'status-gray' },
                };
                
                const type = typeMap[transaction.transaction_type] || { text: transaction.transaction_type, class: 'status-gray' };
                const status = statusMap[transaction.status] || { text: transaction.status, class: 'status-gray' };
                const member = transaction.members || {};
                const amountColor = transaction.amount >= 0 ? '#1D1D1F' : '#FF3B30';
                
                return `
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="flex-between">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <span class="status-badge ${type.class}">${type.text}</span>
                                    <span class="status-badge ${status.class}">${status.text}</span>
                                    ${transaction.receipt_number ? `<span style="color: #86868B; font-size: 14px;">收據：${transaction.receipt_number}</span>` : ''}
                                </div>
                                <div style="color: #86868B; font-size: 14px;">
                                    <div>會員：${member.name || '未知'} (${member.phone || '無電話'})</div>
                                    ${transaction.bookings ? `<div>預約：${transaction.bookings.service_name || '未知'} - ${transaction.bookings.booking_date || ''} ${transaction.bookings.booking_time || ''}</div>` : ''}
                                    <div>金額：<span style="color: ${amountColor}; font-weight: 600; font-size: 18px;">NT$ ${Math.abs(transaction.amount).toLocaleString()}</span></div>
                                    <div>付款方式：${transaction.payment_method_name || '未知'}</div>
                                    ${transaction.description ? `<div>說明：${transaction.description}</div>` : ''}
                                    ${transaction.created_at ? `<div>時間：${formatDateTime(transaction.created_at)}</div>` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <button class="btn btn-sm btn-secondary" onclick="editTransaction('${transaction.id}')" title="編輯">
                                    編輯
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTransaction('${transaction.id}')" title="刪除">
                                    刪除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 顯示結帳表單
        function showCheckoutForm() {
            document.getElementById('checkout-form').style.display = 'block';
            document.getElementById('checkout-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // 隱藏結帳表單
        function hideCheckoutForm() {
            document.getElementById('checkout-form').style.display = 'none';
        }
        
        // 重置表單
        function resetForm() {
            // 手動重置所有表單欄位（因為 checkout-form 是 div 而不是 form）
            document.getElementById('member-select').value = '';
            document.getElementById('booking-select').innerHTML = '<option value="">不關聯預約</option>';
            document.getElementById('booking-preview').style.display = 'none';
            document.getElementById('transaction-type').value = 'payment';
            document.getElementById('form-title').textContent = '新增交易';
            document.getElementById('amount').value = '';
            document.getElementById('discount-amount').value = '0';
            document.getElementById('payment-method').value = '';
            document.getElementById('description').value = '';
            document.getElementById('receipt-number').value = '';
            document.getElementById('reference-number').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('admin-notes').value = '';
            
            // 清除編輯 ID
            document.getElementById('checkout-form').removeAttribute('data-edit-id');
            
            // 清空預約資料
            memberBookings = [];
            
            // 重置儲值金相關
            document.getElementById('member-wallet-info').style.display = 'none';
            document.getElementById('use-wallet-payment').checked = false;
            document.getElementById('wallet-payment-amount-group').style.display = 'none';
            document.getElementById('wallet-payment-amount').value = '';
            document.getElementById('wallet-balance-display').textContent = 'NT$ 0';
            document.getElementById('remaining-amount-display').textContent = '剩餘需付：NT$ 0';
        }
        
        // 載入會員儲值金資訊
        async function loadMemberWalletInfo(lineUserId) {
            try {
                const wallet = await WalletPointsAPI.getMemberWallet(lineUserId);
                const walletInfo = document.getElementById('member-wallet-info');
                const balanceDisplay = document.getElementById('wallet-balance-display');
                
                if (wallet && wallet.balance > 0) {
                    balanceDisplay.textContent = WalletPointsAPI.formatAmount(wallet.balance);
                    walletInfo.style.display = 'block';
                    
                    // 設置儲值金金額的最大值
                    const walletAmountInput = document.getElementById('wallet-payment-amount');
                    walletAmountInput.setAttribute('max', wallet.balance);
                } else {
                    balanceDisplay.textContent = 'NT$ 0';
                    walletInfo.style.display = 'none';
                }
            } catch (error) {
                CONFIG.error('載入儲值金資訊失敗', error);
                // 不顯示錯誤訊息，因為這不是關鍵功能
            }
        }
        
        // 更新剩餘需付金額
        function updateRemainingAmount() {
            const amountInput = document.getElementById('amount');
            const discountInput = document.getElementById('discount-amount');
            const walletAmountInput = document.getElementById('wallet-payment-amount');
            const remainingDisplay = document.getElementById('remaining-amount-display');
            
            const amount = parseFloat(amountInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const walletAmount = parseFloat(walletAmountInput.value) || 0;
            
            const totalAmount = amount + discount;
            const remaining = Math.max(0, totalAmount - walletAmount);
            
            remainingDisplay.textContent = `剩餘需付：NT$ ${remaining.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // 提交交易
        async function submitTransaction() {
            try {
                const memberSelect = document.getElementById('member-select');
                const bookingSelect = document.getElementById('booking-select');
                const transactionType = document.getElementById('transaction-type').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
                const paymentMethod = document.getElementById('payment-method').value;
                const description = document.getElementById('description').value.trim();
                const receiptNumber = document.getElementById('receipt-number').value.trim();
                const referenceNumber = document.getElementById('reference-number').value.trim();
                const notes = document.getElementById('notes').value.trim();
                const adminNotes = document.getElementById('admin-notes').value.trim();
                
                // 驗證
                if (!memberSelect.value) {
                    UI.error('請選擇會員');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    UI.error('請輸入有效的金額');
                    return;
                }
                
                if (!paymentMethod) {
                    UI.error('請選擇付款方式');
                    return;
                }
                
                // 檢查是否使用儲值金付款
                const useWallet = document.getElementById('use-wallet-payment').checked;
                let walletPaymentAmount = 0;
                if (useWallet) {
                    walletPaymentAmount = parseFloat(document.getElementById('wallet-payment-amount').value) || 0;
                    if (walletPaymentAmount <= 0) {
                        UI.error('請輸入有效的儲值金付款金額');
                        return;
                    }
                    
                    // 檢查儲值金餘額
                    const wallet = await WalletPointsAPI.getMemberWallet(memberSelect.value);
                    if (!wallet || wallet.balance < walletPaymentAmount) {
                        UI.error('儲值金餘額不足');
                        return;
                    }
                }
                
                // 計算總金額
                const totalAmount = amount + discountAmount;
                
                const form = document.getElementById('checkout-form');
                const editId = form.getAttribute('data-edit-id');
                const isEdit = !!editId;
                
                if (isEdit) {
                    UI.warning('編輯交易時無法使用儲值金付款');
                    return;
                }
                
                UI.showLoading('建立交易中...');
                
                // 建立新交易
                const transaction = await CheckoutAPI.createTransaction({
                    lineUserId: memberSelect.value,
                    bookingId: bookingSelect.value || null,
                    transactionType: transactionType,
                    amount: amount,
                    totalAmount: totalAmount,
                    discountAmount: discountAmount,
                    paymentMethodCode: paymentMethod,
                    description: description || null,
                    receiptNumber: receiptNumber || null,
                    referenceNumber: referenceNumber || null,
                    notes: notes || null,
                    adminNotes: adminNotes || null,
                    useWalletPayment: useWallet,
                    walletPaymentAmount: walletPaymentAmount,
                });
                
                UI.hideLoading();
                UI.success('交易建立成功！');
                
                // 重置表單並重新載入交易列表
                resetForm();
                hideCheckoutForm();
                await loadAllTransactions();
                
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('建立交易失敗', error);
                UI.error(error.message || '建立交易失敗');
            }
        }
        
        // 格式化日期時間
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
            });
        }
        
        // 編輯交易
        async function editTransaction(transactionId) {
            try {
                // 取得交易記錄
                const transaction = await CheckoutAPI.getTransactionById(transactionId);
                
                // 填入表單
                const member = transaction.members || {};
                const memberOption = Array.from(document.getElementById('member-select').options)
                    .find(opt => opt.value === member.line_user_id);
                
                if (memberOption) {
                    document.getElementById('member-select').value = member.line_user_id;
                    // 觸發會員選擇變更事件
                    document.getElementById('member-select').dispatchEvent(new Event('change'));
                    
                    // 等待預約載入後再選擇預約
                    setTimeout(async () => {
                        if (transaction.booking_id) {
                            document.getElementById('booking-select').value = transaction.booking_id;
                            document.getElementById('booking-select').dispatchEvent(new Event('change'));
                        }
                        
                        document.getElementById('transaction-type').value = transaction.transaction_type || 'payment';
                        document.getElementById('amount').value = Math.abs(transaction.amount || 0);
                        document.getElementById('discount-amount').value = transaction.discount_amount || 0;
                        document.getElementById('payment-method').value = transaction.payment_method_code || '';
                        document.getElementById('description').value = transaction.description || '';
                        document.getElementById('receipt-number').value = transaction.receipt_number || '';
                        document.getElementById('reference-number').value = transaction.reference_number || '';
                        document.getElementById('notes').value = transaction.notes || '';
                        document.getElementById('admin-notes').value = transaction.admin_notes || '';
                        
                        // 更新表單標題
                        document.getElementById('form-title').textContent = '編輯交易';
                        
                        // 儲存編輯的交易 ID
                        document.getElementById('checkout-form').setAttribute('data-edit-id', transactionId);
                        
                        // 顯示表單
                        showCheckoutForm();
                    }, 500);
                } else {
                    showMessage('找不到對應的會員資料', 'error');
                }
            } catch (error) {
                CONFIG.error('載入交易資料失敗', error);
                showMessage('載入交易資料失敗：' + (error.message || '未知錯誤'), 'error');
            }
        }
        
        // 刪除交易
        async function deleteTransaction(transactionId) {
            if (!confirm('確定要刪除此交易記錄嗎？\n\n注意：刪除交易後，關聯的預約付款狀態也會被更新。')) {
                return;
            }
            
            try {
                showLoading('刪除中...');
                
                await CheckoutAPI.deleteTransaction(transactionId);
                
                    hideLoading();
                    showMessage('交易記錄已刪除', 'success');
                
                // 重新載入交易列表
                await loadAllTransactions();
                
            } catch (error) {
                hideLoading();
                CONFIG.error('刪除交易失敗', error);
                showMessage('刪除失敗：' + (error.message || '未知錯誤'), 'error');
            }
        }
        
        // 顯示訊息
        function showMessage(message, type = 'info') {
            if (type === 'error') {
                alert('❌ ' + message);
            } else if (type === 'success') {
                alert('✅ ' + message);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>

