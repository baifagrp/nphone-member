# 📋 預約詳情功能說明

## ✨ 功能概述

會員可以查看預約的完整詳細資訊，包括服務內容、時間、付款狀態等，並可以取消預約。

---

## 🎯 功能特色

### 1. **完整的預約資訊** ✅
- 📋 服務項目與選項
- 📅 預約日期與時間
- 📝 預約備註
- 💳 付款狀態與方式
- ⚙️ 系統資訊（預約編號、建立時間）

### 2. **視覺化狀態顯示** ✅
- ⏳ 待確認（橘色）
- ✅ 已確認（綠色）
- ✓ 已完成（藍色）
- ✕ 已取消（灰色）

### 3. **操作功能** ✅
- ❌ 取消預約（待確認/已確認狀態可用）
- ← 返回預約列表

---

## 📱 頁面結構

```
┌─────────────────────────────────┐
│  ← 返回     預約詳情             │ ← 頁面頭部
└─────────────────────────────────┘

┌─────────────────────────────────┐
│         ⏳ 待確認                 │ ← 狀態卡片
│    我們將盡快為您確認預約          │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  📋 預約資訊                     │
│  ─────────────────────────────  │
│  服務項目                        │ ← 預約資訊
│  螢幕貼膜                        │
│  iPhone 14 Pro                  │
│                                 │
│  預約時間                        │
│  📅 2025年12月14日 (週日)       │
│  🕐 09:00                       │
│                                 │
│  備註                           │
│  請準備好手機                    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  💳 付款資訊                     │
│  ─────────────────────────────  │
│  付款狀態          未付款        │ ← 付款資訊
│  付款方式          現金          │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  ⚙️ 系統資訊                     │
│  ─────────────────────────────  │
│  預約編號    abc123...          │ ← 系統資訊
│  建立時間    2025/12/14 09:00   │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│         [取消預約]               │ ← 操作按鈕
└─────────────────────────────────┘
```

---

## 🔄 使用流程

### 查看預約詳情

```
我的預約頁面
    ↓
點擊預約卡片
    ↓
載入預約詳情
    ├─ 取得預約資料
    ├─ 取得服務資訊
    └─ 取得服務選項
    ↓
顯示完整資訊
    ├─ 狀態卡片
    ├─ 預約資訊
    ├─ 付款資訊
    ├─ 系統資訊
    └─ 操作按鈕
```

---

### 取消預約

```
查看預約詳情
    ↓
點擊「取消預約」按鈕
    ↓
確認對話框
    ├─ 取消 → 保持原狀
    └─ 確定 ↓
更新預約狀態為「已取消」
    ↓
顯示成功訊息
    ↓
重新載入詳情
    ↓
狀態更新為「✕ 已取消」
    ↓
取消按鈕隱藏
```

---

## 📊 狀態顯示規則

### 待確認（pending）
- 🎨 圖示：⏳
- 🏷️ Badge：橘色
- 📝 說明：我們將盡快為您確認預約
- 🔧 操作：可以取消

### 已確認（confirmed）
- 🎨 圖示：✅
- 🏷️ Badge：綠色
- 📝 說明：請準時到店，期待您的光臨
- 🔧 操作：可以取消

### 已完成（completed）
- 🎨 圖示：✓
- 🏷️ Badge：藍色
- 📝 說明：感謝您的光臨
- 🔧 操作：無

### 已取消（cancelled）
- 🎨 圖示：✕
- 🏷️ Badge：灰色
- 📝 說明：此預約已取消
- 🔧 操作：無

---

## 💳 付款狀態顯示

### 未付款（unpaid）
- 🏷️ Badge：紅色
- 📝 文字：未付款

### 已付款（paid）
- 🏷️ Badge：綠色
- 📝 文字：已付款

### 部分付款（partial）
- 🏷️ Badge：橘色
- 📝 文字：部分付款

### 已退款（refunded）
- 🏷️ Badge：藍色
- 📝 文字：已退款

---

## 🔧 技術實作

### 1. **路由參數** ✅

```javascript
// 在預約列表點擊卡片
function viewBookingDetail(bookingId) {
    window.location.href = `booking-detail.html?id=${bookingId}`;
}

// 在詳情頁取得參數
const urlParams = new URLSearchParams(window.location.search);
const bookingId = urlParams.get('id');
```

---

### 2. **資料查詢** ✅

```javascript
const { data, error } = await getSupabase()
    .from('bookings')
    .select(`
        *,
        services (
            name,
            description,
            duration,
            price
        ),
        service_options (
            name
        )
    `)
    .eq('id', bookingId)
    .eq('line_user_id', memberData.line_user_id)
    .single();
```

**關聯查詢：**
- ✅ 預約基本資料
- ✅ 服務資訊（services 表）
- ✅ 服務選項（service_options 表）

---

### 3. **取消預約** ✅

```javascript
const { error } = await getSupabase()
    .from('bookings')
    .update({ status: 'cancelled' })
    .eq('id', bookingId);
```

**安全檢查：**
- ✅ 只能取消自己的預約
- ✅ 確認對話框
- ✅ 錯誤處理

---

### 4. **動態顯示** ✅

```javascript
// 條件式顯示備註
if (booking.notes) {
    document.getElementById('notes-container').style.display = 'block';
}

// 條件式顯示取消按鈕
if (booking.status === 'pending' || booking.status === 'confirmed') {
    document.getElementById('btn-cancel').style.display = 'block';
}
```

---

## 📝 文件結構

### member/booking-detail.html
**功能：** 預約詳情頁面

**區塊：**
1. 頁面頭部（返回按鈕 + 標題）
2. 狀態卡片
3. 預約資訊卡片
4. 付款資訊卡片
5. 系統資訊卡片
6. 操作按鈕區

**依賴：**
- ✅ config.js
- ✅ supabase-client.js
- ✅ ui-utils.js
- ✅ auth.js
- ✅ member.js
- ✅ booking.js

---

### member/bookings.html
**更新：** 查看詳情功能

**修改：**
```javascript
function viewBookingDetail(bookingId) {
    window.location.href = `booking-detail.html?id=${bookingId}`;
}
```

---

## 🧪 測試步驟

### 測試 1：查看預約詳情

1. 會員登入
2. 進入「我的預約」
3. 點擊任一預約卡片
4. ✅ 成功跳轉到詳情頁面
5. ✅ 顯示完整預約資訊
6. ✅ 狀態正確顯示

---

### 測試 2：取消待確認預約

1. 查看待確認狀態的預約
2. ✅ 顯示「取消預約」按鈕
3. 點擊「取消預約」
4. ✅ 顯示確認對話框
5. 點擊「確定」
6. ✅ 顯示成功訊息
7. ✅ 狀態更新為「已取消」
8. ✅ 取消按鈕隱藏

---

### 測試 3：查看已完成預約

1. 查看已完成狀態的預約
2. ✅ 顯示「已完成」狀態（藍色）
3. ✅ 不顯示「取消預約」按鈕
4. ✅ 資訊完整顯示

---

### 測試 4：返回功能

1. 在詳情頁面
2. 點擊「← 返回」
3. ✅ 返回預約列表頁面

---

## 🎨 視覺設計

### 卡片樣式
- 📦 使用 `ds-card` 統一卡片樣式
- 📊 `ds-card-header` + `ds-card-body` 結構
- 🎯 清晰的資訊層次

### 狀態徽章
- 🏷️ 使用 `ds-badge` 系列
- 🎨 顏色對應狀態
- 💡 大尺寸徽章用於主要狀態

### 間距系統
- 📏 使用 Design System 間距變數
- 🎯 統一的間距規範
- 💎 視覺協調一致

---

## 🔒 安全性

### 權限檢查
- ✅ 需要會員登入
- ✅ 只能查看自己的預約
- ✅ 使用 `line_user_id` 過濾

### 資料驗證
- ✅ 檢查預約 ID 是否存在
- ✅ 檢查會員資料是否完整
- ✅ 錯誤處理與訊息提示

---

## 📋 檢查清單

部署前確認：

- [ ] ✅ 預約詳情頁面已建立
- [ ] ✅ 預約列表連接已更新
- [ ] ✅ 狀態顯示正確
- [ ] ✅ 取消預約功能正常
- [ ] ✅ 付款資訊顯示正確
- [ ] ✅ 權限檢查正常
- [ ] ✅ 錯誤處理完善
- [ ] ✅ UI/UX 符合設計系統

---

## 🎯 未來擴展

### 可能的增強功能

1. **分享預約** 📤
   - 分享預約資訊到 LINE
   - 生成預約 QR Code

2. **編輯預約** ✏️
   - 修改預約時間
   - 修改備註

3. **預約提醒** ⏰
   - 設定提醒通知
   - 自訂提醒時間

4. **評價功能** ⭐
   - 完成後評價服務
   - 查看歷史評價

---

## 🎉 完成！

預約詳情功能已完整實作：
- ✨ 完整的資訊展示
- 🎨 美觀的視覺設計
- 🔧 實用的操作功能
- 🔒 安全的權限控制

會員現在可以輕鬆查看和管理自己的預約！😊

