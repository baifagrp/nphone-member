<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šé ç´„ - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/calendar.css">
    <link rel="stylesheet" href="../css/animations.css">
</head>
<body class="ds-page">
    <!-- é é¢é ­éƒ¨ -->
    <div class="ds-page-header">
        <div style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; padding: 0 var(--spacing-md);">
            <button onclick="location.href='profile.html'" class="ds-btn ds-btn-text" style="padding: 8px;">â† è¿”å›</button>
            <h1 class="ds-page-title" style="margin: 0;">ç·šä¸Šé ç´„</h1>
            <div style="width: 60px;"></div>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="ds-container">
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="booking-steps">
            <div class="booking-step active" data-step="1">
                <div class="booking-step-circle">1</div>
                <div class="booking-step-label">é¸æ“‡æœå‹™</div>
            </div>
            <div class="booking-step" data-step="1.5">
                <div class="booking-step-circle">2</div>
                <div class="booking-step-label">é¸æ“‡å‹è™Ÿ</div>
            </div>
            <div class="booking-step" data-step="2">
                <div class="booking-step-circle">3</div>
                <div class="booking-step-label">é¸æ“‡æ—¥æœŸ</div>
            </div>
            <div class="booking-step" data-step="3">
                <div class="booking-step-circle">4</div>
                <div class="booking-step-label">é¸æ“‡æ™‚é–“</div>
            </div>
            <div class="booking-step" data-step="4">
                <div class="booking-step-circle">5</div>
                <div class="booking-step-label">ç¢ºèªé ç´„</div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 1: é¸æ“‡æœå‹™ -->
        <div id="step-1" class="booking-step-content active">
            <div id="services-list"></div>
        </div>
        
        <!-- æ­¥é©Ÿ 1.5: é¸æ“‡æœå‹™é¸é … -->
        <div id="step-1.5" class="booking-step-content" style="display: none;">
            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title" id="option-header">é¸æ“‡æ‰‹æ©Ÿå‹è™Ÿ</div>
                </div>
                <div class="ds-card-body" id="service-options-list"></div>
                <div class="ds-card-footer ds-flex ds-gap-md">
                    <button id="btn-back-step-1.5" class="ds-btn ds-btn-secondary" style="flex: 1;">ä¸Šä¸€æ­¥</button>
                    <button id="btn-next-step-1.5" class="ds-btn ds-btn-primary" style="flex: 1;" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 2: é¸æ“‡æ—¥æœŸ -->
        <div id="step-2" class="booking-step-content" style="display: none;">
            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title">é¸æ“‡é ç´„æ—¥æœŸ</div>
                </div>
                <div class="ds-card-body">
                    <input 
                        type="date" 
                        id="booking-date" 
                        class="ds-form-input" 
                        required
                        min=""
                    >
                </div>
                <div class="ds-card-footer ds-flex ds-gap-md">
                    <button id="btn-back-step-2" class="ds-btn ds-btn-secondary" style="flex: 1;">ä¸Šä¸€æ­¥</button>
                    <button id="btn-next-step-2" class="ds-btn ds-btn-primary" style="flex: 1;">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 3: é¸æ“‡æ™‚é–“ -->
        <div id="step-3" class="booking-step-content" style="display: none;">
            <div class="time-slots-container">
                <div class="time-slots-header">
                    <div class="time-slots-title">é¸æ“‡é ç´„æ™‚é–“</div>
                    <div class="time-slots-info" id="selected-date-display"></div>
                </div>
                <div id="time-slots-list"></div>
            </div>
            <div class="ds-card ds-mt-md">
                <div class="ds-flex ds-gap-md">
                    <button id="btn-back-step-3" class="ds-btn ds-btn-secondary" style="flex: 1;">ä¸Šä¸€æ­¥</button>
                    <button id="btn-next-step-3" class="ds-btn ds-btn-primary" style="flex: 1;" disabled>ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>
        
        <!-- æ­¥é©Ÿ 4: ç¢ºèªé ç´„ -->
        <div id="step-4" class="booking-step-content" style="display: none;">
            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title">ç¢ºèªé ç´„è³‡è¨Š</div>
                </div>
                <div class="ds-card-body">
                    <div class="booking-summary-item">
                        <span class="booking-summary-label">æœå‹™é …ç›®</span>
                        <span class="booking-summary-value" id="confirm-service-name">-</span>
                    </div>
                    <div id="confirm-option-row" class="booking-summary-item" style="display: none;">
                        <span class="booking-summary-label" id="confirm-option-label">å‹è™Ÿ</span>
                        <span class="booking-summary-value" id="confirm-service-option">-</span>
                    </div>
                    <div class="booking-summary-item">
                        <span class="booking-summary-label">æœå‹™æ™‚é•·</span>
                        <span class="booking-summary-value" id="confirm-service-duration">-</span>
                    </div>
                    <div class="booking-summary-item">
                        <span class="booking-summary-label">é ç´„æ—¥æœŸ</span>
                        <span class="booking-summary-value" id="confirm-booking-date">-</span>
                    </div>
                    <div class="booking-summary-item">
                        <span class="booking-summary-label">é ç´„æ™‚é–“</span>
                        <span class="booking-summary-value" id="confirm-booking-time">-</span>
                    </div>
                    
                    <div class="booking-summary-total">
                        <div class="booking-summary-item">
                            <span class="booking-summary-label">æœå‹™åƒ¹æ ¼</span>
                            <span class="booking-summary-value" id="confirm-service-price">-</span>
                        </div>
                    </div>
                    
                    <div class="ds-form-group ds-mt-lg">
                        <label for="booking-notes" class="ds-form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                        <textarea 
                            id="booking-notes" 
                            class="ds-form-input" 
                            placeholder="è«‹å¡«å¯«ç‰¹æ®Šç‹€æ³åŠéœ€æ±‚"
                            rows="3"
                            style="resize: vertical;"
                        ></textarea>
                    </div>
                </div>
                <div class="ds-card-footer ds-flex ds-gap-md">
                    <button id="btn-back-step-4" class="ds-btn ds-btn-secondary" style="flex: 1;">ä¸Šä¸€æ­¥</button>
                    <button id="btn-submit-booking" class="ds-btn ds-btn-primary" style="flex: 1;">å®Œæˆé ç´„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/notification.js"></script>
    <script src="../js/animation-utils.js"></script>
    
    <script>
        // è¼”åŠ©å‡½æ•¸ï¼šå‘å¾Œå…¼å®¹
        function showMessage(message, type = 'info') {
            if (typeof UI !== 'undefined') {
                UI.showToast(message, type);
            } else {
                alert(message);
            }
        }
        
        function showLoading(message) {
            if (typeof UI !== 'undefined') {
                UI.showLoading(message);
            }
        }
        
        function hideLoading() {
            if (typeof UI !== 'undefined') {
                UI.hideLoading();
            }
        }
        
        let currentStep = 1;
        let selectedService = null;
        let selectedServiceOption = null;
        let selectedDate = null;
        let selectedTime = null;
        let availableServices = [];
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireMemberLogin()) {
                    return;
                }
                
                // è¨­å®šæ—¥æœŸé¸æ“‡å™¨çš„æœ€å°æ—¥æœŸç‚ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('booking-date').setAttribute('min', today);
                
                // é¡¯ç¤ºéª¨æ¶å±
                const servicesList = document.getElementById('services-list');
                if (servicesList && typeof UI !== 'undefined') {
                    UI.showSkeleton(servicesList, 'card');
                }
                
                await loadServices();
                
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
                UI.error('åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        });
        
        // è¼‰å…¥æœå‹™åˆ—è¡¨
        async function loadServices() {
            try {
                availableServices = await BookingAPI.getActiveServices();
                if (availableServices.length === 0) {
                    document.getElementById('services-list').innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">æš«ç„¡å¯é ç´„çš„æœå‹™é …ç›®</div></div>';
                    return;
                }
                
                // æ¨™æº–åŒ–æœå‹™è³‡æ–™
                availableServices = availableServices.map(service => {
                    if (service.base_price === null || service.base_price === undefined) {
                        service.base_price = service.price || 0;
                    }
                    if (!service.price) {
                        service.price = service.base_price || 0;
                    }
                    if (!service.service_options) {
                        service.service_options = [];
                    }
                    return service;
                });
                
                // é¡¯ç¤ºæœå‹™åˆ—è¡¨
                document.getElementById('services-list').innerHTML = availableServices.map(service => `
                    <div class="selection-card" data-service-id="${service.id}" onclick="selectService('${service.id}')">
                        <div class="selection-card-header">
                            <div>
                                <div class="selection-card-title">${service.name}</div>
                                ${service.description ? `<div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-top: 4px;">${service.description}</div>` : ''}
                            </div>
                            <div class="selection-card-check">âœ“</div>
                        </div>
                        <div class="selection-card-meta">
                            <div class="selection-card-duration">
                                <span>â±ï¸</span>
                                <span>${service.duration} åˆ†é˜</span>
                            </div>
                            <div class="selection-card-price">NT$ ${(service.base_price || service.price || 0).toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™å¤±æ•—', error);
                document.getElementById('services-list').innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">è¼‰å…¥æœå‹™å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div></div>';
                UI.error('è¼‰å…¥æœå‹™å¤±æ•—');
            }
        }
        
        // é¸æ“‡æœå‹™
        function selectService(serviceId) {
            selectedService = availableServices.find(s => s.id === serviceId);
            
            if (!selectedService) {
                UI.error('æ‰¾ä¸åˆ°æœå‹™é …ç›®');
                return;
            }
            
            // æ›´æ–° UI
            document.querySelectorAll('.selection-card').forEach(card => {
                card.classList.remove('selected');
            });
            const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
            if (serviceCard) {
                serviceCard.classList.add('selected');
            }
            
            selectedServiceOption = null;
            
            // æª¢æŸ¥æœå‹™æ˜¯å¦éœ€è¦é¸æ“‡é¸é …
            if (selectedService.has_options && selectedService.service_options && selectedService.service_options.length > 0) {
                setTimeout(() => {
                    loadServiceOptions();
                    goToStep(1.5);
                }, 300);
            } else {
                setTimeout(() => {
                    goToStep(2);
                }, 300);
            }
        }
        
        // è¼‰å…¥æœå‹™é¸é …
        async function loadServiceOptions() {
            try {
                if (!selectedService || !selectedService.has_options) {
                    return;
                }
                
                const options = selectedService.service_options || [];
                
                document.getElementById('option-header').textContent = `é¸æ“‡${selectedService.option_label || 'é¸é …'}`;
                
                if (options.length === 0) {
                    document.getElementById('service-options-list').innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">æš«ç„¡å¯é¸é¸é …</div></div>';
                    return;
                }
                
                document.getElementById('service-options-list').innerHTML = options
                    .filter(opt => opt.is_active !== false)
                    .map(option => {
                        const finalPrice = (selectedService.base_price || 0) + (option.price_modifier || 0);
                        const priceText = option.price_modifier 
                            ? (option.price_modifier > 0 ? `+NT$ ${option.price_modifier}` : `${option.price_modifier}`)
                            : '';
                        
                        return `
                            <div class="selection-card" data-option-id="${option.id}" onclick="selectServiceOption('${option.id}')">
                                <div class="selection-card-header">
                                    <div>
                                        <div class="selection-card-title">${option.name}</div>
                                        ${priceText ? `<div style="font-size: var(--font-size-sm); color: var(--primary-color); margin-top: 4px;">${priceText}</div>` : ''}
                                    </div>
                                    <div class="selection-card-check">âœ“</div>
                                </div>
                                <div class="selection-card-meta">
                                    <div class="selection-card-price">ç¸½åƒ¹ NT$ ${finalPrice.toLocaleString()}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™é¸é …å¤±æ•—', error);
                UI.error('è¼‰å…¥é¸é …å¤±æ•—');
            }
        }
        
        // é¸æ“‡æœå‹™é¸é …
        function selectServiceOption(optionId) {
            if (!selectedService || !selectedService.service_options) {
                UI.error('ç„¡æ³•é¸æ“‡é¸é …');
                return;
            }
            
            const option = selectedService.service_options.find(opt => opt.id === optionId);
            if (!option) {
                UI.error('æ‰¾ä¸åˆ°é¸é …');
                return;
            }
            
            selectedServiceOption = option;
            
            // æ›´æ–° UI
            document.querySelectorAll('[data-option-id]').forEach(card => {
                card.classList.remove('selected');
            });
            const optionCard = document.querySelector(`[data-option-id="${optionId}"]`);
            if (optionCard) {
                optionCard.classList.add('selected');
            }
            
            document.getElementById('btn-next-step-1.5').disabled = false;
        }
        
        // é€²å…¥æŒ‡å®šæ­¥é©Ÿ
        function goToStep(step) {
            document.querySelectorAll('.booking-step-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            const stepElement = document.getElementById(`step-${step}`);
            if (stepElement) {
                stepElement.classList.add('active');
                stepElement.style.display = 'block';
            }
            
            // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
            document.querySelectorAll('.booking-step').forEach((stepEl) => {
                stepEl.classList.remove('active', 'completed');
                const stepNum = parseFloat(stepEl.getAttribute('data-step'));
                if (stepNum < parseFloat(step)) {
                    stepEl.classList.add('completed');
                } else if (stepNum === parseFloat(step)) {
                    stepEl.classList.add('active');
                }
            });
            
            currentStep = step;
            
            if (step === 3 && selectedDate) {
                loadTimeSlots();
            } else if (step === 4) {
                displayConfirmation();
            }
        }
        
        // æ—¥æœŸé¸æ“‡äº‹ä»¶
        document.getElementById('booking-date').addEventListener('change', (e) => {
            selectedDate = e.target.value;
        });
        
        // è¼‰å…¥æ™‚é–“æ®µ
        async function loadTimeSlots() {
            try {
                const container = document.getElementById('time-slots-list');
                container.innerHTML = '<div class="ds-text-center ds-p-xl"><div class="loading-spinner"></div></div>';
                
                // æ›´æ–°æ—¥æœŸé¡¯ç¤º
                document.getElementById('selected-date-display').textContent = formatDateDisplay(selectedDate);
                
                const slots = await BookingAPI.getAvailableTimeSlots(selectedDate, selectedService.duration);
                
                if (slots.length === 0) {
                    container.innerHTML = '<div class="time-slots-empty"><div class="time-slots-empty-icon">ğŸ“…</div><div class="time-slots-empty-text">ç•¶å¤©ç„¡å¯ç”¨æ™‚é–“æ®µï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ</div></div>';
                    return;
                }
                
                // éæ¿¾å·²éæ™‚é–“
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().slice(0, 5);
                
                let availableSlots = slots;
                if (selectedDate === today) {
                    availableSlots = slots.filter(slot => {
                        const slotTime = typeof slot === 'string' ? slot : (slot.time_slot || slot);
                        return slotTime > currentTime;
                    });
                }
                
                if (availableSlots.length === 0) {
                    container.innerHTML = `<div class="time-slots-empty"><div class="time-slots-empty-icon">â°</div><div class="time-slots-empty-text">${selectedDate === today ? 'ä»Šå¤©çš„å¯ç”¨æ™‚é–“å·²éï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ' : 'ç•¶å¤©ç„¡å¯ç”¨æ™‚é–“æ®µ'}</div></div>`;
                    return;
                }
                
                container.innerHTML = `
                    <div class="time-slots-grid">
                        ${availableSlots.map(slot => {
                            const slotTime = typeof slot === 'string' ? slot : (slot.time_slot || slot);
                            return `<button class="time-slot" data-time="${slotTime}" onclick="selectTime('${slotTime}')">${slotTime}</button>`;
                        }).join('')}
                    </div>
                `;
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æ™‚é–“æ®µå¤±æ•—', error);
                document.getElementById('time-slots-list').innerHTML = '<div class="time-slots-empty"><div class="time-slots-empty-text">è¼‰å…¥æ™‚é–“æ®µå¤±æ•—</div></div>';
                UI.error('è¼‰å…¥æ™‚é–“æ®µå¤±æ•—');
            }
        }
        
        // é¸æ“‡æ™‚é–“
        function selectTime(time) {
            selectedTime = time;
            
            document.querySelectorAll('.time-slot').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-time="${time}"]`).classList.add('selected');
            
            document.getElementById('btn-next-step-3').disabled = false;
        }
        
        // é¡¯ç¤ºç¢ºèªè³‡è¨Š
        function displayConfirmation() {
            let finalPrice = selectedService.base_price || selectedService.price || 0;
            let serviceName = selectedService.name;
            
            if (selectedServiceOption) {
                finalPrice = finalPrice + (selectedServiceOption.price_modifier || 0);
                document.getElementById('confirm-option-row').style.display = 'flex';
                document.getElementById('confirm-option-label').textContent = selectedService.option_label || 'é¸é …';
                document.getElementById('confirm-service-option').textContent = selectedServiceOption.name;
            } else {
                document.getElementById('confirm-option-row').style.display = 'none';
            }
            
            document.getElementById('confirm-service-name').textContent = serviceName;
            document.getElementById('confirm-service-duration').textContent = `${selectedService.duration} åˆ†é˜`;
            document.getElementById('confirm-service-price').textContent = `NT$ ${finalPrice.toLocaleString()}`;
            document.getElementById('confirm-booking-date').textContent = formatDateDisplay(selectedDate);
            document.getElementById('confirm-booking-time').textContent = selectedTime;
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatDateDisplay(dateString) {
            const date = new Date(dateString);
            const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${date.getFullYear()}/${month}/${day} (${weekday})`;
        }
        
        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('btn-next-step-1.5').addEventListener('click', () => {
            if (!selectedServiceOption) {
                UI.warning('è«‹é¸æ“‡é¸é …');
                return;
            }
            goToStep(2);
        });
        
        document.getElementById('btn-back-step-1.5').addEventListener('click', () => goToStep(1));
        
        document.getElementById('btn-next-step-2').addEventListener('click', () => {
            const date = document.getElementById('booking-date').value;
            if (!date) {
                UI.warning('è«‹é¸æ“‡é ç´„æ—¥æœŸ');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            if (date === today) {
                const now = new Date();
                const currentHour = now.getHours();
                if (currentHour >= 20) {
                    if (!confirm('ä»Šå¤©å·²ç¶“å¾ˆæ™šäº†ï¼Œå»ºè­°é¸æ“‡æ˜å¤©ä¹‹å¾Œçš„æ—¥æœŸã€‚\n\næ˜¯å¦è¦ç¹¼çºŒé¸æ“‡ä»Šå¤©ï¼Ÿ')) {
                        return;
                    }
                }
            }
            
            selectedDate = date;
            goToStep(3);
        });
        
        document.getElementById('btn-back-step-2').addEventListener('click', () => {
            goToStep(selectedService.has_options ? 1.5 : 1);
        });
        
        document.getElementById('btn-next-step-3').addEventListener('click', () => {
            if (!selectedTime) {
                UI.warning('è«‹é¸æ“‡é ç´„æ™‚é–“');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            if (selectedDate === today) {
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5);
                if (selectedTime <= currentTime) {
                    UI.warning('ç„¡æ³•é ç´„å·²éçš„æ™‚é–“ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“');
                    return;
                }
            }
            
            goToStep(4);
        });
        
        document.getElementById('btn-back-step-3').addEventListener('click', () => goToStep(2));
        document.getElementById('btn-back-step-4').addEventListener('click', () => goToStep(3));
        
        // æäº¤é ç´„
        document.getElementById('btn-submit-booking').addEventListener('click', async () => {
            try {
                if (!Auth.isMemberLoggedIn()) {
                    UI.error('è«‹å…ˆç™»å…¥');
                    return;
                }
                
                // é©—è­‰å¿…è¦è³‡æ–™
                if (!selectedService || !selectedService.id) {
                    UI.error('è«‹é¸æ“‡æœå‹™é …ç›®');
                    return;
                }
                
                const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (!uuidPattern.test(selectedService.id)) {
                    CONFIG.error('ç„¡æ•ˆçš„æœå‹™ ID', selectedService.id);
                    UI.error('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡');
                    return;
                }
                
                if (!selectedDate || !selectedTime) {
                    UI.error('è«‹å®Œæˆæ‰€æœ‰å¿…å¡«æ¬„ä½');
                    return;
                }
                
                // é©—è­‰æ™‚é–“
                const today = new Date().toISOString().split('T')[0];
                if (selectedDate === today) {
                    const now = new Date();
                    const currentTime = now.toTimeString().slice(0, 5);
                    if (selectedTime <= currentTime) {
                        UI.error('ç„¡æ³•é ç´„å·²éçš„æ™‚é–“');
                        return;
                    }
                }
                
                if (selectedService.has_options && !selectedServiceOption) {
                    UI.error(`è«‹é¸æ“‡${selectedService.option_label || 'é¸é …'}`);
                    return;
                }
                
                const session = Auth.getMemberSession();
                const notes = document.getElementById('booking-notes').value.trim() || null;
                
                UI.showLoading('å»ºç«‹é ç´„ä¸­...');
                
                const bookingDate = selectedDate instanceof Date 
                    ? selectedDate.toISOString().split('T')[0]
                    : selectedDate;
                
                let bookingTime = selectedTime;
                if (!bookingTime.includes(':')) {
                    bookingTime = '00:00:00';
                } else if (bookingTime.split(':').length === 2) {
                    bookingTime = bookingTime + ':00';
                }
                
                if (!selectedService.id || selectedService.id === '0' || selectedService.id === 0 || String(selectedService.id).trim() === '0') {
                    CONFIG.error('âŒ æœå‹™ ID ç„¡æ•ˆ', selectedService.id);
                    UI.error('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡');
                    return;
                }
                
                const serviceIdStr = String(selectedService.id).trim();
                if (!uuidPattern.test(serviceIdStr)) {
                    CONFIG.error('âŒ æœå‹™ ID æ ¼å¼éŒ¯èª¤', serviceIdStr);
                    UI.error('æœå‹™é …ç›®è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡');
                    return;
                }
                
                let serviceOptionId = null;
                if (selectedServiceOption && selectedServiceOption.id) {
                    const optionId = String(selectedServiceOption.id).trim();
                    
                    if (optionId && 
                        optionId !== '0' && 
                        optionId !== '' && 
                        optionId !== 'null' && 
                        optionId !== 'undefined' &&
                        optionId !== 'false') {
                        if (uuidPattern.test(optionId)) {
                            serviceOptionId = optionId;
                        } else {
                            CONFIG.error('âŒ ç„¡æ•ˆçš„æœå‹™é¸é … ID æ ¼å¼', optionId);
                            UI.error('æœå‹™é¸é …è³‡æ–™éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡');
                            return;
                        }
                    }
                }
                
                if (serviceOptionId === '0' || serviceOptionId === 0 || String(serviceOptionId).trim() === '0') {
                    serviceOptionId = null;
                }
                
                CONFIG.log('ğŸ“‹ å»ºç«‹é ç´„åƒæ•¸', {
                    lineUserId: session.lineUserId,
                    serviceId: serviceIdStr,
                    bookingDate: bookingDate,
                    bookingTime: bookingTime,
                    serviceOptionId: serviceOptionId,
                    notes: notes
                });
                
                const booking = await BookingAPI.createBooking(
                    session.lineUserId,
                    serviceIdStr,
                    bookingDate,
                    bookingTime,
                    serviceOptionId,
                    notes
                );
                
                CONFIG.log('âœ… é ç´„å»ºç«‹æˆåŠŸ', booking);
                
                // ç™¼é€é ç´„æˆåŠŸé€šçŸ¥
                try {
                    const member = Member.currentMember;
                    const service = availableServices.find(s => s.id === serviceIdStr);
                    
                    // æº–å‚™é€šçŸ¥è³‡æ–™
                    const notificationData = {
                        id: booking.id || booking.booking_id,
                        member_name: member?.name || 'é¡§å®¢',
                        service_name: service?.name || 'æœå‹™',
                        service_option_name: selectedServiceOption?.name || null,
                        booking_date: bookingDate,
                        booking_time: bookingTime,
                        notes: notes
                    };
                    
                    CONFIG.log('ğŸ“¤ ç™¼é€é ç´„æˆåŠŸé€šçŸ¥', { lineUserId: session.lineUserId, notificationData });
                    
                    // éåŒæ­¥ç™¼é€é€šçŸ¥ï¼ˆä¸é˜»å¡ç”¨æˆ¶ï¼‰
                    NotificationAPI.sendBookingCreated(session.lineUserId, notificationData)
                        .then(() => {
                            CONFIG.log('âœ… é ç´„æˆåŠŸé€šçŸ¥å·²ç™¼é€');
                        })
                        .catch(error => {
                            // é€šçŸ¥ç™¼é€å¤±æ•—ä¸å½±éŸ¿é ç´„æµç¨‹
                            CONFIG.error('âŒ é ç´„æˆåŠŸé€šçŸ¥ç™¼é€å¤±æ•—', error);
                        });
                } catch (notificationError) {
                    // é€šçŸ¥ç™¼é€å¤±æ•—ä¸å½±éŸ¿é ç´„æµç¨‹
                    CONFIG.error('âŒ æº–å‚™é€šçŸ¥è³‡æ–™å¤±æ•—', notificationError);
                }
                
                UI.hideLoading();
                UI.success('é ç´„æˆåŠŸï¼æˆ‘å€‘å·²ç™¼é€ç¢ºèªé€šçŸ¥åˆ°æ‚¨çš„ LINE');
                
                setTimeout(() => {
                    window.location.href = 'bookings.html';
                }, 2000);
                
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('é ç´„å¤±æ•—', error);
                
                let errorMessage = 'é ç´„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.error_description) {
                    errorMessage = error.error_description;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }
                
                UI.error(errorMessage);
            }
        });
    </script>
</body>
</html>
