<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢é ç´„ - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/admin-enhancements.css">
    <link rel="stylesheet" href="../css/animations.css">
</head>
<body class="ds-page">
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE ç®¡ç†å¾Œå°</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">å„€è¡¨æ¿</a>
                <a href="members.html" class="navbar-link">æœƒå“¡ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link active">é ç´„ç®¡ç†</a>
                <a href="checkout.html" class="navbar-link">çµå¸³ç®¡ç†</a>
                <a href="business-hours.html" class="navbar-link">ç‡Ÿæ¥­æ™‚é–“</a>
                <a href="wallet-points.html" class="navbar-link">å„²å€¼/ç©åˆ†</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container" style="margin-top: 40px;">
        <h1 class="page-title ds-mb-lg">æ–°å¢é ç´„</h1>
        
        <!-- æ–°å¢é ç´„è¡¨å–® -->
        <div class="ds-card">
            <div class="ds-card-body">
            <!-- æœƒå“¡é¸æ“‡ -->
            <div class="ds-form-group">
                <label for="member-select" class="ds-form-label">é¸æ“‡æœƒå“¡ <span class="ds-text-error">*</span></label>
                <select id="member-select" class="ds-form-input" required>
                    <option value="">è«‹é¸æ“‡æœƒå“¡</option>
                </select>
            </div>
            
            <!-- æœå‹™é¸æ“‡ -->
            <div class="ds-form-group">
                <label for="service-select" class="ds-form-label">é¸æ“‡æœå‹™ <span class="ds-text-error">*</span></label>
                <select id="service-select" class="ds-form-input" required>
                    <option value="">è«‹é¸æ“‡æœå‹™</option>
                </select>
                <div id="service-options-container" class="ds-mt-sm" style="display: none;">
                    <label class="ds-form-label">æœå‹™é¸é …</label>
                    <select id="service-option-select" class="ds-form-input">
                        <option value="">ä¸éœ€è¦é¸é …</option>
                    </select>
                </div>
                <div id="service-preview" class="ds-info-box ds-mt-sm" style="display: none;">
                    <!-- å‹•æ…‹è¼‰å…¥æœå‹™è©³æƒ… -->
                </div>
            </div>
            
            <!-- æ—¥æœŸé¸æ“‡ -->
            <div class="ds-form-group">
                <label for="booking-date" class="ds-form-label">é ç´„æ—¥æœŸ <span class="ds-text-error">*</span></label>
                <input 
                    type="date" 
                    id="booking-date" 
                    class="ds-form-input" 
                    required
                    min=""
                >
            </div>
            
            <!-- æ™‚é–“é¸æ“‡ -->
            <div class="ds-form-group">
                <label for="booking-time" class="ds-form-label">é ç´„æ™‚é–“ <span class="ds-text-error">*</span></label>
                <select id="booking-time" class="ds-form-input" required>
                    <option value="">è«‹é¸æ“‡æ™‚é–“</option>
                </select>
            </div>
            
            <!-- å‚™è¨» -->
            <div class="ds-form-group">
                <label for="booking-notes" class="ds-form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea 
                    id="booking-notes" 
                    class="ds-form-input" 
                    rows="3"
                    placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚æˆ–å‚™è¨»ï¼Œè«‹åœ¨æ­¤å¡«å¯«"
                ></textarea>
            </div>
            
            <!-- ç®¡ç†å“¡å‚™è¨» -->
            <div class="ds-form-group">
                <label for="admin-notes" class="ds-form-label">ç®¡ç†å“¡å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea 
                    id="admin-notes" 
                    class="ds-form-input" 
                    rows="3"
                    placeholder="åƒ…ç®¡ç†å“¡å¯è¦‹çš„å‚™è¨»"
                ></textarea>
            </div>
            </div>
            
            <!-- æŒ‰éˆ• -->
            <div class="ds-card-footer">
                <a href="bookings.html" class="ds-btn ds-btn-secondary">å–æ¶ˆ</a>
                <button id="btn-submit-booking" class="ds-btn ds-btn-primary">å»ºç«‹é ç´„</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/animation-utils.js"></script>
    
    <script>
        let allMembers = [];
        let allServices = [];
        let selectedService = null;
        let selectedServiceOption = null;
        let availableTimeSlots = [];
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) {
                    return;
                }
                
                // è¨­å®šæ—¥æœŸæœ€å°å€¼ç‚ºä»Šå¤©
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('booking-date').min = today;
                
                await loadMembers();
                await loadServices();
                
                // ç¶å®šäº‹ä»¶
                setupEventListeners();
                
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
            }
        });
        
        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æœå‹™é¸æ“‡è®Šæ›´
            document.getElementById('service-select').addEventListener('change', async (e) => {
                const serviceId = e.target.value;
                if (serviceId) {
                    await handleServiceChange(serviceId);
                    // å¦‚æœå·²ç¶“é¸æ“‡äº†æ—¥æœŸï¼Œé‡æ–°è¼‰å…¥æ™‚é–“æ®µ
                    const selectedDate = document.getElementById('booking-date').value;
                    if (selectedDate) {
                        await loadAvailableTimeSlots(selectedDate);
                    } else {
                        // æç¤ºéœ€è¦é¸æ“‡æ—¥æœŸ
                        document.getElementById('booking-time').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ—¥æœŸ</option>';
                        showMessage('è«‹é¸æ“‡é ç´„æ—¥æœŸå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è¼‰å…¥å¯ç”¨æ™‚é–“æ®µ', 'info');
                    }
                } else {
                    document.getElementById('service-options-container').style.display = 'none';
                    document.getElementById('service-preview').style.display = 'none';
                    document.getElementById('booking-time').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æœå‹™</option>';
                    selectedService = null;
                }
            });
            
            // æœå‹™é¸é …è®Šæ›´
            document.getElementById('service-option-select').addEventListener('change', (e) => {
                const optionId = e.target.value;
                if (optionId && selectedService) {
                    selectedServiceOption = selectedService.service_options.find(opt => opt.id === optionId);
                    updateServicePreview();
                } else {
                    selectedServiceOption = null;
                    updateServicePreview();
                }
            });
            
            // æ—¥æœŸé¸æ“‡è®Šæ›´
            document.getElementById('booking-date').addEventListener('change', async (e) => {
                const date = e.target.value;
                if (date) {
                    await loadAvailableTimeSlots(date);
                }
            });
            
            // æäº¤é ç´„
            document.getElementById('btn-submit-booking').addEventListener('click', async () => {
                await submitBooking();
            });
        }
        
        // è¼‰å…¥æœƒå“¡åˆ—è¡¨
        async function loadMembers() {
            try {
                const result = await MemberAPI.getAll(1000, 0);
                allMembers = result.members || [];
                
                const memberSelect = document.getElementById('member-select');
                memberSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœƒå“¡</option>' +
                    allMembers.map(member => `
                        <option value="${member.line_user_id}">${member.name} (${member.phone || 'ç„¡é›»è©±'})</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—', error);
                showMessage('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—', 'error');
            }
        }
        
        // è¼‰å…¥æœå‹™åˆ—è¡¨
        async function loadServices() {
            try {
                allServices = await BookingAPI.getActiveServices();
                
                const serviceSelect = document.getElementById('service-select');
                serviceSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœå‹™</option>' +
                    allServices.map(service => `
                        <option value="${service.id}">${service.name} - NT$ ${(service.base_price || service.price || 0).toLocaleString()}</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™åˆ—è¡¨å¤±æ•—', error);
                showMessage('è¼‰å…¥æœå‹™åˆ—è¡¨å¤±æ•—', 'error');
            }
        }
        
        // è™•ç†æœå‹™é¸æ“‡è®Šæ›´
        async function handleServiceChange(serviceId) {
            selectedService = allServices.find(s => s.id === serviceId);
            if (!selectedService) return;
            
            // é¡¯ç¤ºæœå‹™é¸é …
            if (selectedService.has_options && selectedService.service_options && selectedService.service_options.length > 0) {
                const optionSelect = document.getElementById('service-option-select');
                optionSelect.innerHTML = '<option value="">ä¸éœ€è¦é¸é …</option>' +
                    selectedService.service_options.map(option => `
                        <option value="${option.id}">${option.name} (+NT$ ${option.price_modifier || 0})</option>
                    `).join('');
                document.getElementById('service-options-container').style.display = 'block';
            } else {
                document.getElementById('service-options-container').style.display = 'none';
            }
            
            updateServicePreview();
        }
        
        // æ›´æ–°æœå‹™é è¦½
        function updateServicePreview() {
            if (!selectedService) return;
            
            const preview = document.getElementById('service-preview');
            const basePrice = selectedService.base_price || selectedService.price || 0;
            const optionModifier = selectedServiceOption ? (selectedServiceOption.price_modifier || 0) : 0;
            const finalPrice = basePrice + optionModifier;
            
            preview.style.display = 'block';
            preview.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="color: #86868B; font-size: 12px;">æœå‹™</div>
                        <div style="font-weight: 600;">${selectedService.name}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">æ™‚é•·</div>
                        <div style="font-weight: 600;">${selectedService.duration} åˆ†é˜</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">åƒ¹æ ¼</div>
                        <div style="font-weight: 600; font-size: 18px; color: #007AFF;">NT$ ${finalPrice.toLocaleString()}</div>
                    </div>
                </div>
            `;
        }
        
        // è¼‰å…¥å¯ç”¨æ™‚é–“æ®µ
        async function loadAvailableTimeSlots(date) {
            const timeSelect = document.getElementById('booking-time');
            
            try {
                // éœ€è¦å…ˆé¸æ“‡æœå‹™æ‰èƒ½è¼‰å…¥æ™‚é–“æ®µï¼ˆå› ç‚ºéœ€è¦æœå‹™æ™‚é•·ï¼‰
                if (!selectedService) {
                    timeSelect.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æœå‹™</option>';
                    CONFIG.log('âš ï¸ å°šæœªé¸æ“‡æœå‹™ï¼Œç„¡æ³•è¼‰å…¥æ™‚é–“æ®µ');
                    return;
                }
                
                CONFIG.log('ğŸ“… è¼‰å…¥å¯ç”¨æ™‚é–“æ®µ', { date, service: selectedService.name, duration: selectedService.duration });
                
                // é¡¯ç¤ºè¼‰å…¥ä¸­
                timeSelect.innerHTML = '<option value="">è¼‰å…¥ä¸­...</option>';
                timeSelect.disabled = true;
                
                const serviceDuration = selectedService.duration || 60;
                const timeSlots = await BookingAPI.getAvailableTimeSlots(date, serviceDuration);
                availableTimeSlots = timeSlots;
                
                CONFIG.log('âœ… æˆåŠŸè¼‰å…¥æ™‚é–“æ®µ', { count: timeSlots?.length || 0, slots: timeSlots });
                
                // å•Ÿç”¨é¸å–®
                timeSelect.disabled = false;
                
                if (!timeSlots || timeSlots.length === 0) {
                    timeSelect.innerHTML = '<option value="">ç•¶æ—¥ç„¡å¯ç”¨æ™‚é–“</option>';
                    showMessage('è©²æ—¥æœŸç„¡å¯ç”¨æ™‚é–“æ®µï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ', 'warning');
                } else {
                    timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚é–“</option>' +
                        timeSlots.map(slot => {
                            const timeValue = slot.time_slot || slot;
                            return `<option value="${timeValue}">${timeValue}</option>`;
                        }).join('');
                    showMessage(`å·²è¼‰å…¥ ${timeSlots.length} å€‹å¯ç”¨æ™‚é–“æ®µ`, 'success');
                }
                
            } catch (error) {
                CONFIG.error('âŒ è¼‰å…¥å¯ç”¨æ™‚é–“å¤±æ•—', error);
                timeSelect.disabled = false;
                timeSelect.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦</option>';
                showMessage('è¼‰å…¥å¯ç”¨æ™‚é–“å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            }
        }
        
        // æäº¤é ç´„
        async function submitBooking() {
            try {
                const memberLineUserId = document.getElementById('member-select').value;
                const serviceId = document.getElementById('service-select').value;
                const serviceOptionId = document.getElementById('service-option-select').value || null;
                const bookingDate = document.getElementById('booking-date').value;
                const bookingTime = document.getElementById('booking-time').value;
                const notes = document.getElementById('booking-notes').value.trim() || null;
                const adminNotes = document.getElementById('admin-notes').value.trim() || null;
                
                // é©—è­‰
                if (!memberLineUserId) {
                    showMessage('è«‹é¸æ“‡æœƒå“¡', 'error');
                    return;
                }
                
                if (!serviceId) {
                    showMessage('è«‹é¸æ“‡æœå‹™', 'error');
                    return;
                }
                
                if (!bookingDate) {
                    showMessage('è«‹é¸æ“‡é ç´„æ—¥æœŸ', 'error');
                    return;
                }
                
                if (!bookingTime) {
                    showMessage('è«‹é¸æ“‡é ç´„æ™‚é–“', 'error');
                    return;
                }
                
                showLoading('å»ºç«‹é ç´„ä¸­...');
                
                const booking = await BookingAPI.createBooking(
                    memberLineUserId,
                    serviceId,
                    bookingDate,
                    bookingTime,
                    serviceOptionId,
                    notes
                );
                
                // å¦‚æœæœ‰ç®¡ç†å“¡å‚™è¨»ï¼Œæ›´æ–°é ç´„
                if (adminNotes) {
                    await BookingAPI.updateBookingStatus(booking.id, booking.status, adminNotes);
                }
                
                showMessage('é ç´„å»ºç«‹æˆåŠŸï¼', 'success');
                
                // å»¶é²å¾Œè¿”å›é ç´„åˆ—è¡¨
                setTimeout(() => {
                    window.location.href = 'bookings.html';
                }, 1500);
                
            } catch (error) {
                CONFIG.error('å»ºç«‹é ç´„å¤±æ•—', error);
                showMessage(error.message || 'å»ºç«‹é ç´„å¤±æ•—', 'error');
            }
        }
        
        // é¡¯ç¤ºè¨Šæ¯ï¼ˆä½¿ç”¨æ–°çš„ UI å·¥å…·ï¼‰
        function showMessage(message, type = 'info') {
            if (typeof UI !== 'undefined') {
                UI.showToast(message, type);
            } else {
                // å¾Œå‚™æ–¹æ¡ˆ
                if (type === 'error') {
                    alert('âŒ ' + message);
                } else if (type === 'success') {
                    alert('âœ… ' + message);
                } else {
                    alert(message);
                }
            }
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoading(message) {
            if (typeof UI !== 'undefined') {
                UI.showLoading(message);
            }
        }
        
        // éš±è—è¼‰å…¥ç‹€æ…‹
        function hideLoading() {
            if (typeof UI !== 'undefined') {
                UI.hideLoading();
            }
        }
    </script>
</body>
</html>

