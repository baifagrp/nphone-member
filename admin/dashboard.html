<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/animations.css">
</head>
<body class="ds-page">
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE ç®¡ç†å¾Œå°</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link active">å„€è¡¨æ¿</a>
                <a href="members.html" class="navbar-link">æœƒå“¡ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link">é ç´„ç®¡ç†</a>
                <a href="checkout.html" class="navbar-link">çµå¸³ç®¡ç†</a>
                <a href="business-hours.html" class="navbar-link">ç‡Ÿæ¥­æ™‚é–“</a>
                <a href="wallet-points.html" class="navbar-link">å„²å€¼/ç©åˆ†</a>
                <button id="btn-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container" style="margin-top: 40px;">
        <h1 class="ds-mb-lg" style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold);">å„€è¡¨æ¿</h1>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="ds-grid ds-grid-4 ds-mb-xl">
            <div class="ds-info-card">
                <div class="ds-info-card-icon" style="background: rgba(200, 164, 138, 0.1);">ğŸ‘¥</div>
                <div class="ds-info-card-value" id="total-members">0</div>
                <div class="ds-info-card-label">ç¸½æœƒå“¡æ•¸</div>
            </div>

            <div class="ds-info-card">
                <div class="ds-info-card-icon" style="background: rgba(102, 187, 106, 0.1); color: var(--success-color);">ğŸ“…</div>
                <div class="ds-info-card-value" id="total-bookings">0</div>
                <div class="ds-info-card-label">ç¸½é ç´„æ•¸</div>
            </div>

            <div class="ds-info-card">
                <div class="ds-info-card-icon" style="background: rgba(66, 165, 245, 0.1); color: var(--info-color);">â°</div>
                <div class="ds-info-card-value" id="today-bookings">0</div>
                <div class="ds-info-card-label">ä»Šæ—¥é ç´„</div>
            </div>

            <div class="ds-info-card">
                <div class="ds-info-card-icon" style="background: rgba(255, 167, 38, 0.1); color: var(--warning-color);">ğŸ’°</div>
                <div class="ds-info-card-value" id="total-revenue">NT$ 0</div>
                <div class="ds-info-card-label">ç¸½ç‡Ÿæ”¶</div>
            </div>
        </div>

        <!-- æœ€è¿‘æ´»å‹• -->
        <div class="ds-grid ds-grid-2" style="gap: var(--spacing-lg);">
            <!-- æœ€è¿‘é ç´„ -->
            <div class="ds-card">
                <div class="ds-card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="ds-card-title">æœ€è¿‘é ç´„</div>
                        <a href="bookings.html" class="ds-btn ds-btn-sm ds-btn-text">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
                    </div>
                </div>
                <div class="ds-card-body" id="recent-bookings">
                    <div class="ds-text-center ds-p-lg"><div class="loading-spinner"></div></div>
                </div>
            </div>

            <!-- æœ€è¿‘åŠ å…¥æœƒå“¡ -->
            <div class="ds-card">
                <div class="ds-card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="ds-card-title">æœ€è¿‘åŠ å…¥æœƒå“¡</div>
                        <a href="members.html" class="ds-btn ds-btn-sm ds-btn-text">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
                    </div>
                </div>
                <div class="ds-card-body" id="recent-members">
                    <div class="ds-text-center ds-p-lg"><div class="loading-spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/animation-utils.js"></script>
    
    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) return;
                
                UI.showLoading('è¼‰å…¥ä¸­...');
                await loadDashboardData();
                UI.hideLoading();
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('è¼‰å…¥å¤±æ•—', error);
                UI.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—');
            }
        });

        async function loadDashboardData() {
            try {
                // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                const [membersResult, bookingsResult] = await Promise.all([
                    MemberAPI.getAll(1000, 0),
                    BookingAPI.getAllBookings(1000, 0)
                ]);

                const members = membersResult.members || [];
                const bookings = bookingsResult.bookings || [];

                // ç¸½æœƒå“¡æ•¸
                document.getElementById('total-members').textContent = members.length;

                // ç¸½é ç´„æ•¸
                document.getElementById('total-bookings').textContent = bookings.length;

                // ä»Šæ—¥é ç´„
                const today = new Date().toISOString().split('T')[0];
                const todayBookings = bookings.filter(b => b.booking_date === today);
                document.getElementById('today-bookings').textContent = todayBookings.length;

                // ç¸½ç‡Ÿæ”¶ï¼ˆå·²ä»˜æ¬¾çš„é ç´„ï¼‰
                const revenue = bookings
                    .filter(b => b.payment_status === 'paid')
                    .reduce((sum, b) => sum + (parseFloat(b.paid_amount) || 0), 0);
                document.getElementById('total-revenue').textContent = `NT$ ${Math.floor(revenue).toLocaleString()}`;

                // æœ€è¿‘é ç´„ï¼ˆå‰ 5 ç­†ï¼‰
                displayRecentBookings(bookings.slice(0, 5));

                // æœ€è¿‘æœƒå“¡ï¼ˆå‰ 5 ç­†ï¼‰
                displayRecentMembers(members.slice(0, 5));

            } catch (error) {
                CONFIG.error('è¼‰å…¥å„€è¡¨æ¿æ•¸æ“šå¤±æ•—', error);
                throw error;
            }
        }

        function displayRecentBookings(bookings) {
            const container = document.getElementById('recent-bookings');
            if (!bookings || bookings.length === 0) {
                container.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">å°šç„¡é ç´„</div></div>';
                return;
            }

            container.innerHTML = bookings.map(b => `
                <div class="ds-list-item" style="margin-bottom: var(--spacing-sm);">
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">${b.service_name || 'æœªçŸ¥æœå‹™'}</div>
                        <div class="ds-list-item-subtitle">
                            ${b.booking_date} ${b.booking_time?.substring(0, 5)}
                        </div>
                    </div>
                    ${getStatusBadge(b.status)}
                </div>
            `).join('');
        }

        function displayRecentMembers(members) {
            const container = document.getElementById('recent-members');
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">å°šç„¡æœƒå“¡</div></div>';
                return;
            }

            container.innerHTML = members.map(m => `
                <div class="ds-list-item" style="margin-bottom: var(--spacing-sm); cursor: pointer;" onclick="location.href='member-detail.html?id=${m.id}'">
                    <div style="width: 40px; height: 40px; border-radius: var(--radius-full); background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: var(--font-weight-semibold); margin-right: var(--spacing-md);">
                        ${(m.name || 'æœƒå“¡')[0]}
                    </div>
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">${m.name || 'æœªå‘½å'}</div>
                        <div class="ds-list-item-subtitle">${m.phone || 'æœªæä¾›é›»è©±'}</div>
                    </div>
                    <div class="ds-list-item-arrow">â€º</div>
                </div>
            `).join('');
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'å¾…ç¢ºèª', class: 'ds-badge-warning' },
                'confirmed': { text: 'å·²ç¢ºèª', class: 'ds-badge-success' },
                'completed': { text: 'å·²å®Œæˆ', class: 'ds-badge-info' },
                'cancelled': { text: 'å·²å–æ¶ˆ', class: 'ds-badge-error' }
            };
            
            const statusInfo = statusMap[status] || { text: status, class: 'ds-badge-primary' };
            return `<span class="ds-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        document.getElementById('btn-logout').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                Auth.adminLogout();
            }
        });
    </script>
</body>
</html>
