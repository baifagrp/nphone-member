<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„ç®¡ç†</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">é¦–é </a>
                <a href="members.html" class="navbar-link">æœƒå“¡ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link">é ç´„ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™é …ç›®</a>
                <a href="checkout.html" class="navbar-link">çµå¸³ç®¡ç†</a>
                <a href="business-hours.html" class="navbar-link">ç‡Ÿæ¥­æ™‚é–“</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container" style="margin-top: 40px;">
        <div class="flex-between" style="margin-bottom: 24px;">
            <h1 style="font-size: 32px; font-weight: 700;">é ç´„ç®¡ç†</h1>
        </div>
        
        <!-- ç¯©é¸å™¨ -->
        <div class="card" style="margin-bottom: 24px;">
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                <select id="filter-status" class="form-select" style="width: auto; min-width: 150px;">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="pending">å¾…ç¢ºèª</option>
                    <option value="confirmed">å·²ç¢ºèª</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="no_show">æœªåˆ°</option>
                </select>
                
                <input 
                    type="date" 
                    id="filter-date" 
                    class="form-input" 
                    style="width: auto; min-width: 150px;"
                >
                
                <button id="btn-apply-filter" class="btn btn-primary">ç¯©é¸</button>
                <button id="btn-clear-filter" class="btn btn-secondary">æ¸…é™¤</button>
            </div>
        </div>
        
        <!-- é ç´„åˆ—è¡¨ -->
        <div id="bookings-list">
            <div class="card">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        let currentFilter = {
            status: null,
            date: null,
        };
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await Admin.init();
                await loadBookings();
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
            }
        });
        
        // è¼‰å…¥é ç´„åˆ—è¡¨
        async function loadBookings() {
            try {
                const result = await BookingAPI.getAllBookings(100, 0, currentFilter.status);
                const bookings = result.bookings;
                
                // å¦‚æœæœ‰æ—¥æœŸç¯©é¸ï¼Œé€²ä¸€æ­¥éæ¿¾
                let filteredBookings = bookings;
                if (currentFilter.date) {
                    filteredBookings = bookings.filter(b => b.booking_date === currentFilter.date);
                }
                
                if (filteredBookings.length === 0) {
                    document.getElementById('bookings-list').innerHTML = `
                        <div class="card">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                å°šç„¡é ç´„è¨˜éŒ„
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // é¡¯ç¤ºé ç´„åˆ—è¡¨
                document.getElementById('bookings-list').innerHTML = filteredBookings.map(booking => {
                    const statusMap = {
                        'pending': { text: 'å¾…ç¢ºèª', class: 'status-warning', actions: ['confirm', 'cancel'] },
                        'confirmed': { text: 'å·²ç¢ºèª', class: 'status-success', actions: ['complete', 'cancel', 'no_show'] },
                        'cancelled': { text: 'å·²å–æ¶ˆ', class: 'status-gray', actions: [] },
                        'completed': { text: 'å·²å®Œæˆ', class: 'status-success', actions: [] },
                        'no_show': { text: 'æœªåˆ°', class: 'status-error', actions: [] },
                    };
                    
                    const status = statusMap[booking.status] || { text: booking.status, class: 'status-gray', actions: [] };
                    const member = booking.members || {};
                    
                    return `
                        <div class="card" style="margin-bottom: 16px;">
                            <div class="flex-between">
                                <div style="flex: 1;">
                                    <h3 style="margin-bottom: 8px;">${booking.service_name}</h3>
                                    <div style="color: #86868B; font-size: 14px; margin-bottom: 12px;">
                                        <div><strong>æœƒå“¡ï¼š</strong>${member.name || 'æœªçŸ¥'}</div>
                                        <div><strong>é›»è©±ï¼š</strong>${member.phone || '-'}</div>
                                        <div>ğŸ“… ${formatDateDisplay(booking.booking_date)}</div>
                                        <div>â° ${booking.booking_time}</div>
                                        <div>â± ${booking.service_duration} åˆ†é˜</div>
                                        ${booking.service_option_name ? `<div>ğŸ“± <strong>å‹è™Ÿï¼š</strong>${booking.service_option_name}</div>` : ''}
                                        <div>ğŸ’° NT$ ${booking.service_price.toLocaleString()}</div>
                                    </div>
                                    ${booking.notes ? `<div style="padding: 8px; background: #F5F5F7; border-radius: 8px; color: #666; font-size: 13px; margin-top: 8px;">ğŸ“ ${booking.notes}</div>` : ''}
                                    ${booking.admin_notes ? `<div style="padding: 8px; background: #FFF4E6; border-radius: 8px; color: #666; font-size: 13px; margin-top: 8px;">ğŸ”’ ç®¡ç†å“¡å‚™è¨»: ${booking.admin_notes}</div>` : ''}
                                </div>
                                <div style="text-align: right; min-width: 200px;">
                                    <div class="status-badge ${status.class}" style="margin-bottom: 12px;">${status.text}</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        ${status.actions.includes('confirm') ? `<button class="btn btn-sm btn-success" onclick="updateBookingStatus('${booking.id}', 'confirmed')">ç¢ºèªé ç´„</button>` : ''}
                                        ${status.actions.includes('complete') ? `<button class="btn btn-sm btn-primary" onclick="updateBookingStatus('${booking.id}', 'completed')">æ¨™è¨˜å®Œæˆ</button>` : ''}
                                        ${status.actions.includes('cancel') ? `<button class="btn btn-sm btn-danger" onclick="updateBookingStatus('${booking.id}', 'cancelled')">å–æ¶ˆé ç´„</button>` : ''}
                                        ${status.actions.includes('no_show') ? `<button class="btn btn-sm btn-warning" onclick="updateBookingStatus('${booking.id}', 'no_show')">æ¨™è¨˜æœªåˆ°</button>` : ''}
                                        <button class="btn btn-sm btn-secondary" onclick="deleteBooking('${booking.id}', '${booking.service_name}')" style="margin-top: 8px;">åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥é ç´„å¤±æ•—', error);
                showMessage('è¼‰å…¥é ç´„å¤±æ•—', 'error');
            }
        }
        
        // åˆªé™¤é ç´„
        async function deleteBooking(bookingId, serviceName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é ç´„ã€Œ${serviceName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                return;
            }
            
            try {
                showLoading('åˆªé™¤ä¸­...');
                await BookingAPI.deleteBooking(bookingId);
                hideLoading();
                showMessage('é ç´„å·²åˆªé™¤', 'success');
                await loadBookings();
            } catch (error) {
                hideLoading();
                CONFIG.error('åˆªé™¤é ç´„å¤±æ•—', error);
                showMessage(error.message || 'åˆªé™¤å¤±æ•—', 'error');
            }
        }
        
        // æ›´æ–°é ç´„ç‹€æ…‹
        async function updateBookingStatus(bookingId, status) {
            const statusMap = {
                'confirmed': 'ç¢ºèª',
                'cancelled': 'å–æ¶ˆ',
                'completed': 'å®Œæˆ',
                'no_show': 'æ¨™è¨˜ç‚ºæœªåˆ°',
            };
            
            if (!confirm(`ç¢ºå®šè¦${statusMap[status]}æ­¤é ç´„å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                showLoading('æ›´æ–°ä¸­...');
                await BookingAPI.updateBookingStatus(bookingId, status);
                hideLoading();
                showMessage('é ç´„ç‹€æ…‹å·²æ›´æ–°', 'success');
                await loadBookings();
            } catch (error) {
                hideLoading();
                CONFIG.error('æ›´æ–°ç‹€æ…‹å¤±æ•—', error);
                showMessage('æ›´æ–°å¤±æ•—', 'error');
            }
        }
        
        // æ–°å¢é ç´„æŒ‰éˆ•
        document.getElementById('btn-new-booking').addEventListener('click', () => {
            // å°å‘åˆ°æœƒå“¡é ç´„é é¢ï¼Œæˆ–å‰µå»ºä¸€å€‹ç®¡ç†å“¡æ–°å¢é ç´„çš„é é¢
            // æš«æ™‚å…ˆå°å‘åˆ°æœƒå“¡é ç´„é é¢ï¼ˆç®¡ç†å“¡å¯ä»¥é€éé¸æ“‡æœƒå“¡ä¾†ç‚ºå…¶æ–°å¢é ç´„ï¼‰
            window.location.href = 'member-booking-new.html';
        });
        
        // ç¯©é¸åŠŸèƒ½
        document.getElementById('btn-apply-filter').addEventListener('click', () => {
            currentFilter.status = document.getElementById('filter-status').value || null;
            currentFilter.date = document.getElementById('filter-date').value || null;
            loadBookings();
        });
        
        document.getElementById('btn-clear-filter').addEventListener('click', () => {
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-date').value = '';
            currentFilter = { status: null, date: null };
            loadBookings();
        });
        
        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatDateDisplay(dateString) {
            const date = new Date(dateString);
            const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${date.getFullYear()}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
        }
    </script>
</body>
</html>

