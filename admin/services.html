<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå‹™é …ç›®ç®¡ç†</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">ç®¡ç†å¾Œå°</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">é¦–é </a>
                <a href="members.html" class="navbar-link">æœƒå“¡ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link">é ç´„ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™é …ç›®</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container" style="margin-top: 40px;">
        <div class="flex-between" style="margin-bottom: 24px;">
            <h1 style="font-size: 32px; font-weight: 700;">æœå‹™é …ç›®ç®¡ç†</h1>
            <button id="btn-new-service" class="btn btn-success">+ æ–°å¢æœå‹™</button>
        </div>
        
        <!-- æœå‹™åˆ—è¡¨ -->
        <div id="services-list">
            <div class="card">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯æœå‹™ Modal -->
    <div id="service-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" id="modal-title">æ–°å¢æœå‹™</div>
            <div class="card-body">
                <form id="form-service">
                    <div class="form-group">
                        <label for="service-name" class="form-label required">æœå‹™åç¨±</label>
                        <input type="text" id="service-name" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-description" class="form-label">æœå‹™æè¿°</label>
                        <textarea id="service-description" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-duration" class="form-label required">æœå‹™æ™‚é•·ï¼ˆåˆ†é˜ï¼‰</label>
                        <input type="number" id="service-duration" class="form-input" required min="1" value="60">
                    </div>
                    
                    <div class="form-group">
                        <label for="service-price" class="form-label required">åƒ¹æ ¼</label>
                        <input type="number" id="service-price" class="form-input" required min="0" step="0.01" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="service-sort-order" class="form-label">æ’åºé †åº</label>
                        <input type="number" id="service-sort-order" class="form-input" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="service-is-active" checked> å•Ÿç”¨æ­¤æœå‹™
                        </label>
                    </div>
                    
                    <div class="flex flex-gap" style="margin-top: 24px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">å„²å­˜</button>
                        <button type="button" id="btn-cancel-modal" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        let editingServiceId = null;
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await Admin.init();
                await loadServices();
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
            }
        });
        
        // è¼‰å…¥æœå‹™åˆ—è¡¨
        async function loadServices() {
            try {
                const services = await BookingAPI.getAllServices();
                
                if (services.length === 0) {
                    document.getElementById('services-list').innerHTML = `
                        <div class="card">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                å°šç„¡æœå‹™é …ç›®
                            </div>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('services-list').innerHTML = services.map(service => `
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="flex-between">
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 8px;">
                                    ${service.name}
                                    ${!service.is_active ? '<span class="status-badge status-gray">å·²åœç”¨</span>' : ''}
                                </h3>
                                ${service.description ? `<p style="color: #86868B; margin-bottom: 12px;">${service.description}</p>` : ''}
                                <div style="display: flex; gap: 16px; color: #666; font-size: 14px;">
                                    <span>â± ${service.duration} åˆ†é˜</span>
                                    <span>ğŸ’° NT$ ${service.price.toLocaleString()}</span>
                                    <span>ğŸ“Š æ’åº: ${service.sort_order}</span>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary" onclick="editService('${service.id}')">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteService('${service.id}', '${service.name}')" style="margin-left: 8px;">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™å¤±æ•—', error);
            }
        }
        
        // æ–°å¢æœå‹™
        document.getElementById('btn-new-service').addEventListener('click', () => {
            editingServiceId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢æœå‹™';
            document.getElementById('form-service').reset();
            document.getElementById('service-is-active').checked = true;
            document.getElementById('service-modal').style.display = 'flex';
        });
        
        // ç·¨è¼¯æœå‹™
        async function editService(serviceId) {
            try {
                const service = await BookingAPI.getServiceById(serviceId);
                editingServiceId = serviceId;
                
                document.getElementById('modal-title').textContent = 'ç·¨è¼¯æœå‹™';
                document.getElementById('service-name').value = service.name;
                document.getElementById('service-description').value = service.description || '';
                document.getElementById('service-duration').value = service.duration;
                document.getElementById('service-price').value = service.price;
                document.getElementById('service-sort-order').value = service.sort_order;
                document.getElementById('service-is-active').checked = service.is_active;
                
                document.getElementById('service-modal').style.display = 'flex';
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™å¤±æ•—', error);
                showMessage('è¼‰å…¥æœå‹™å¤±æ•—', 'error');
            }
        }
        
        // åˆªé™¤æœå‹™
        async function deleteService(serviceId, serviceName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœå‹™ã€Œ${serviceName}ã€å—ï¼Ÿ\nåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼`)) {
                return;
            }
            
            try {
                await BookingAPI.deleteService(serviceId);
                showMessage('æœå‹™å·²åˆªé™¤', 'success');
                await loadServices();
            } catch (error) {
                CONFIG.error('åˆªé™¤æœå‹™å¤±æ•—', error);
                showMessage('åˆªé™¤å¤±æ•—', 'error');
            }
        }
        
        // å„²å­˜æœå‹™
        document.getElementById('form-service').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const serviceData = {
                name: document.getElementById('service-name').value.trim(),
                description: document.getElementById('service-description').value.trim() || null,
                duration: parseInt(document.getElementById('service-duration').value),
                price: parseFloat(document.getElementById('service-price').value),
                sort_order: parseInt(document.getElementById('service-sort-order').value) || 0,
                is_active: document.getElementById('service-is-active').checked,
            };
            
            try {
                if (editingServiceId) {
                    await BookingAPI.updateService(editingServiceId, serviceData);
                    showMessage('æœå‹™æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    await BookingAPI.createService(serviceData);
                    showMessage('æœå‹™æ–°å¢æˆåŠŸ', 'success');
                }
                
                document.getElementById('service-modal').style.display = 'none';
                await loadServices();
            } catch (error) {
                CONFIG.error('å„²å­˜æœå‹™å¤±æ•—', error);
                showMessage('å„²å­˜å¤±æ•—', 'error');
            }
        });
        
        // é—œé–‰ Modal
        document.getElementById('btn-cancel-modal').addEventListener('click', () => {
            document.getElementById('service-modal').style.display = 'none';
        });
    </script>
</body>
</html>

