<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡è©³æƒ… - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/admin-enhancements.css">
</head>
<body class="ds-page">
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE ç®¡ç†å¾Œå°</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">å„€è¡¨æ¿</a>
                <a href="members.html" class="navbar-link active">æœƒå“¡ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link">é ç´„ç®¡ç†</a>
                <a href="checkout.html" class="navbar-link">çµå¸³ç®¡ç†</a>
                <a href="business-hours.html" class="navbar-link">ç‡Ÿæ¥­æ™‚é–“</a>
                <a href="wallet-points.html" class="navbar-link">å„²å€¼/ç©åˆ†</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 40px;">
        <div class="page-actions">
            <div>
                <button onclick="history.back()" class="ds-btn ds-btn-text" style="padding: 8px 16px; margin-bottom: var(--spacing-sm);">â† è¿”å›</button>
                <h1 class="page-title">æœƒå“¡è©³æƒ…</h1>
            </div>
            <div class="admin-actions">
                <a href="#" id="edit-member-link" class="ds-btn ds-btn-primary">ç·¨è¼¯æœƒå“¡</a>
                <button id="delete-member-btn" class="ds-btn ds-btn-secondary">åˆªé™¤æœƒå“¡</button>
            </div>
        </div>
        
        <!-- æœƒå“¡è³‡è¨Š -->
        <div class="ds-grid ds-grid-2 ds-mb-lg" style="gap: var(--spacing-lg);">
            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title">åŸºæœ¬è³‡æ–™</div>
                </div>
                <div class="ds-card-body">
                    <div class="profile-info">
                        <div class="profile-info-row">
                            <span class="profile-info-label">æœƒå“¡å§“å</span>
                            <span class="profile-info-value" id="detail-name">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">è¯çµ¡é›»è©±</span>
                            <span class="profile-info-value" id="detail-phone">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">é›»å­éƒµä»¶</span>
                            <span class="profile-info-value" id="detail-email">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">æ€§åˆ¥</span>
                            <span class="profile-info-value" id="detail-gender">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">ç”Ÿæ—¥</span>
                            <span class="profile-info-value" id="detail-birth-date">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">æœƒå“¡ç·¨è™Ÿ</span>
                            <span class="profile-info-value" id="detail-member-code">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title">LINE è³‡è¨Š</div>
                </div>
                <div class="ds-card-body">
                    <div class="profile-info">
                        <div class="profile-info-row">
                            <span class="profile-info-label">LINE ç¶å®š</span>
                            <span class="profile-info-value" id="detail-line-status">
                                <span class="ds-badge ds-badge-error">æœªç¶å®š</span>
                            </span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">LINE User ID</span>
                            <span class="profile-info-value" id="detail-line-user-id" style="font-family: monospace; font-size: var(--font-size-sm);">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">åŠ å…¥æ™‚é–“</span>
                            <span class="profile-info-value" id="detail-created-at">-</span>
                        </div>
                        <div class="profile-info-row">
                            <span class="profile-info-label">æœ€å¾Œæ›´æ–°</span>
                            <span class="profile-info-value" id="detail-updated-at">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å„²å€¼é‡‘èˆ‡ç©åˆ† -->
        <div class="ds-grid ds-grid-2 ds-mb-lg" style="gap: var(--spacing-lg);">
            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title">ğŸ’° å„²å€¼é‡‘è³‡è¨Š</div>
                </div>
                <div class="ds-card-body">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--primary-color); margin-bottom: var(--spacing-md);" id="wallet-balance">NT$ 0</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--gray-200);">
                            <div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ç´¯ç©å„²å€¼</div>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-top: 4px;" id="wallet-recharged">NT$ 0</div>
                            </div>
                            <div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ç´¯ç©æ¶ˆè²»</div>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-top: 4px;" id="wallet-spent">NT$ 0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ds-card">
                <div class="ds-card-header">
                    <div class="ds-card-title">ğŸ ç©åˆ†è³‡è¨Š</div>
                </div>
                <div class="ds-card-body">
                    <div style="text-align: center; padding: var(--spacing-lg);">
                        <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: #FF9800; margin-bottom: var(--spacing-md);" id="points-balance">0 é»</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--gray-200);">
                            <div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ç´¯ç©ç²å¾—</div>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-top: 4px;" id="points-earned">0 é»</div>
                            </div>
                            <div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">ç´¯ç©ä½¿ç”¨</div>
                                <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-top: 4px;" id="points-spent">0 é»</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é ç´„è¨˜éŒ„ -->
        <div class="ds-card">
            <div class="ds-card-header">
                <div class="ds-card-title">é ç´„è¨˜éŒ„</div>
            </div>
            <div class="ds-card-body">
                <div id="bookings-list">
                    <div class="ds-text-center ds-p-xl"><div class="loading-spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/wallet-points.js"></script>
    <script src="../js/admin.js"></script>
    
    <script>
        let currentMember = null;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) return;
                
                const urlParams = new URLSearchParams(window.location.search);
                const memberId = urlParams.get('id');
                
                if (!memberId) {
                    UI.error('ç¼ºå°‘æœƒå“¡ ID');
                    setTimeout(() => location.href = 'members.html', 1500);
                    return;
                }
                
                UI.showLoading('è¼‰å…¥ä¸­...');
                await loadMemberDetail(memberId);
                UI.hideLoading();
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('è¼‰å…¥å¤±æ•—', error);
                UI.error('è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—');
            }
        });

        async function loadMemberDetail(memberId) {
            try {
                currentMember = await MemberAPI.getById(memberId);
                displayMemberInfo(currentMember);
                
                // è¼‰å…¥å„²å€¼é‡‘å’Œç©åˆ†
                if (currentMember.line_user_id) {
                    const [wallet, points] = await Promise.all([
                        WalletPointsAPI.getMemberWallet(currentMember.line_user_id).catch(() => null),
                        WalletPointsAPI.getMemberPoints(currentMember.line_user_id).catch(() => null)
                    ]);
                    
                    if (wallet) {
                        document.getElementById('wallet-balance').textContent = `NT$ ${Math.floor(wallet.balance || 0).toLocaleString()}`;
                        document.getElementById('wallet-recharged').textContent = `NT$ ${Math.floor(wallet.total_recharged || 0).toLocaleString()}`;
                        document.getElementById('wallet-spent').textContent = `NT$ ${Math.floor(wallet.total_spent || 0).toLocaleString()}`;
                    }
                    
                    if (points) {
                        document.getElementById('points-balance').textContent = `${points.balance || 0} é»`;
                        document.getElementById('points-earned').textContent = `${points.total_earned || 0} é»`;
                        document.getElementById('points-spent').textContent = `${points.total_spent || 0} é»`;
                    }
                }
                
                // è¼‰å…¥é ç´„è¨˜éŒ„
                if (currentMember.line_user_id) {
                    const bookings = await BookingAPI.getMyBookings(currentMember.line_user_id, 50);
                    displayBookings(bookings);
                } else {
                    document.getElementById('bookings-list').innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">æ­¤æœƒå“¡å°šæœªç¶å®š LINEï¼Œç„¡é ç´„è¨˜éŒ„</div></div>';
                }
                
                document.getElementById('edit-member-link').href = `member-edit.html?id=${memberId}`;
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœƒå“¡è©³æƒ…å¤±æ•—', error);
                throw error;
            }
        }

        function displayMemberInfo(member) {
            document.getElementById('detail-name').textContent = member.name || '-';
            document.getElementById('detail-phone').textContent = member.phone || '-';
            document.getElementById('detail-email').textContent = member.email || '-';
            document.getElementById('detail-gender').textContent = member.gender === 'M' ? 'ç”·' : member.gender === 'F' ? 'å¥³' : 'å…¶ä»–';
            document.getElementById('detail-birth-date').textContent = member.birth_date || '-';
            document.getElementById('detail-member-code').textContent = member.member_code || '-';
            
            if (member.line_user_id) {
                document.getElementById('detail-line-status').innerHTML = '<span class="ds-badge ds-badge-success">å·²ç¶å®š</span>';
                document.getElementById('detail-line-user-id').textContent = member.line_user_id;
            }
            
            document.getElementById('detail-created-at').textContent = new Date(member.created_at).toLocaleString('zh-TW');
            document.getElementById('detail-updated-at').textContent = new Date(member.updated_at).toLocaleString('zh-TW');
        }

        function displayBookings(bookings) {
            const container = document.getElementById('bookings-list');
            if (!bookings || bookings.length === 0) {
                container.innerHTML = '<div class="ds-empty-state"><div class="ds-empty-title">å°šç„¡é ç´„è¨˜éŒ„</div></div>';
                return;
            }

            container.innerHTML = bookings.map(b => `
                <div class="ds-list-item ds-mb-sm">
                    <div class="ds-list-item-content">
                        <div class="ds-list-item-title">${b.service_name || 'æœªçŸ¥æœå‹™'}</div>
                        <div class="ds-list-item-subtitle">${b.booking_date} ${b.booking_time?.substring(0, 5)} | ${b.service_option_name || 'ç„¡é¸é …'}</div>
                    </div>
                    ${getStatusBadge(b.status)}
                </div>
            `).join('');
        }

        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'å¾…ç¢ºèª', class: 'ds-badge-warning' },
                'confirmed': { text: 'å·²ç¢ºèª', class: 'ds-badge-success' },
                'completed': { text: 'å·²å®Œæˆ', class: 'ds-badge-info' },
                'cancelled': { text: 'å·²å–æ¶ˆ', class: 'ds-badge-error' }
            };
            const statusInfo = statusMap[status] || { text: status, class: 'ds-badge-primary' };
            return `<span class="ds-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        document.getElementById('delete-member-btn').addEventListener('click', async () => {
            if (!currentMember) return;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœƒå“¡ã€Œ${currentMember.name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
            
            try {
                UI.showLoading('åˆªé™¤ä¸­...');
                await MemberAPI.delete(currentMember.id);
                UI.hideLoading();
                UI.success('åˆªé™¤æˆåŠŸ');
                setTimeout(() => location.href = 'members.html', 1500);
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('åˆªé™¤å¤±æ•—', error);
                UI.error('åˆªé™¤å¤±æ•—');
            }
        });

        document.getElementById('btn-admin-logout').addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                Auth.adminLogout();
            }
        });
    </script>
</body>
</html>
