<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¸³ç®¡ç† - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/admin-enhancements.css">
    <link rel="stylesheet" href="../css/animations.css">
</head>
<body class="ds-page">
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE ç®¡ç†å¾Œå°</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">å„€è¡¨æ¿</a>
                <a href="members.html" class="navbar-link">æœƒå“¡ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link">é ç´„ç®¡ç†</a>
                <a href="checkout.html" class="navbar-link active">çµå¸³ç®¡ç†</a>
                <a href="business-hours.html" class="navbar-link">ç‡Ÿæ¥­æ™‚é–“</a>
                <a href="wallet-points.html" class="navbar-link">å„²å€¼/ç©åˆ†</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container" style="margin-top: 40px;">
        <div class="page-actions">
            <h1 class="page-title">çµå¸³ç®¡ç†</h1>
            <button id="btn-new-transaction" class="ds-btn ds-btn-primary">+ æ–°å¢äº¤æ˜“</button>
        </div>
        
        <!-- çµå¸³è¡¨å–® -->
        <div id="checkout-form" class="ds-card ds-mb-lg" style="display: none;">
            <div class="ds-card-header">
                <div class="ds-card-title" id="form-title">æ–°å¢äº¤æ˜“</div>
            </div>
            <div class="ds-card-body">
            
            <!-- æœƒå“¡é¸æ“‡ -->
            <div class="ds-form-group">
                <label for="member-select" class="ds-form-label">é¸æ“‡æœƒå“¡ <span class="ds-text-error">*</span></label>
                <select id="member-select" class="ds-form-input" required>
                    <option value="">è«‹é¸æ“‡æœƒå“¡</option>
                </select>
            </div>
            
            <!-- é ç´„é¸æ“‡ï¼ˆå¯é¸ï¼‰ -->
            <div class="ds-form-group">
                <label for="booking-select" class="ds-form-label">é—œè¯é ç´„ï¼ˆé¸å¡«ï¼‰</label>
                <select id="booking-select" class="ds-form-input">
                    <option value="">ä¸é—œè¯é ç´„</option>
                </select>
                <div id="booking-preview" class="ds-info-box ds-mt-sm" style="display: none;">
                    <!-- å‹•æ…‹è¼‰å…¥é ç´„è©³æƒ… -->
                </div>
            </div>
            
            <!-- äº¤æ˜“é¡å‹ -->
            <div class="ds-form-group">
                <label for="transaction-type" class="ds-form-label">äº¤æ˜“é¡å‹ <span class="ds-text-error">*</span></label>
                <select id="transaction-type" class="ds-form-input" required>
                    <option value="payment">ä»˜æ¬¾</option>
                    <option value="refund">é€€æ¬¾</option>
                </select>
            </div>
            
            <!-- é‡‘é¡ -->
            <div class="ds-form-group">
                <label for="amount" class="ds-form-label">é‡‘é¡ <span class="ds-text-error">*</span></label>
                <input 
                    type="number" 
                    id="amount" 
                    class="ds-form-input" 
                    step="0.01"
                    min="0.01"
                    required
                    placeholder="è«‹è¼¸å…¥é‡‘é¡"
                >
            </div>
            
            <!-- æŠ˜æ‰£é‡‘é¡ï¼ˆå¯é¸ï¼‰ -->
            <div class="ds-form-group">
                <label for="discount-amount" class="ds-form-label">æŠ˜æ‰£é‡‘é¡ï¼ˆé¸å¡«ï¼‰</label>
                <input 
                    type="number" 
                    id="discount-amount" 
                    class="ds-form-input" 
                    step="0.01"
                    min="0"
                    value="0"
                    placeholder="0"
                >
            </div>
            
            <!-- ä»˜æ¬¾æ–¹å¼ -->
            <div class="ds-form-group">
                <label for="payment-method" class="ds-form-label">ä»˜æ¬¾æ–¹å¼ <span class="ds-text-error">*</span></label>
                <select id="payment-method" class="ds-form-input" required>
                    <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                </select>
                <!-- å„²å€¼é‡‘é¤˜é¡æç¤ºï¼ˆç•¶é¸æ“‡å„²å€¼é‡‘æ™‚é¡¯ç¤ºï¼‰ -->
                <div id="wallet-balance-hint" class="ds-info-box ds-info-box-info ds-mt-sm" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600;">å¯ç”¨å„²å€¼é‡‘é¤˜é¡</span>
                        <span id="wallet-balance-display" style="font-size: 16px; font-weight: 700;">NT$ 0</span>
                    </div>
                    <div class="ds-mt-xs ds-text-secondary">
                        <span id="wallet-payment-info">ç³»çµ±å°‡ä½¿ç”¨å„²å€¼é‡‘æ”¯ä»˜æ­¤ç­†äº¤æ˜“</span>
                    </div>
                </div>
            </div>
            
            <!-- äº¤æ˜“æè¿° -->
            <div class="ds-form-group">
                <label for="description" class="ds-form-label">äº¤æ˜“æè¿°ï¼ˆé¸å¡«ï¼‰</label>
                <input 
                    type="text" 
                    id="description" 
                    class="ds-form-input" 
                    placeholder="ä¾‹å¦‚ï¼šæœå‹™è²»ç”¨ã€é€€æ¬¾èªªæ˜ç­‰"
                >
            </div>
            
            <!-- æ”¶æ“šç·¨è™Ÿï¼ˆå¯é¸ï¼Œç³»çµ±æœƒè‡ªå‹•ç”Ÿæˆï¼‰ -->
            <div class="ds-form-group">
                <label for="receipt-number" class="ds-form-label">æ”¶æ“šç·¨è™Ÿï¼ˆé¸å¡«ï¼Œç•™ç©ºå°‡è‡ªå‹•ç”Ÿæˆï¼‰</label>
                <input 
                    type="text" 
                    id="receipt-number" 
                    class="ds-form-input" 
                    placeholder="ç•™ç©ºå°‡è‡ªå‹•ç”Ÿæˆ"
                >
            </div>
            
            <!-- åƒè€ƒç·¨è™Ÿï¼ˆå¯é¸ï¼‰ -->
            <div class="ds-form-group">
                <label for="reference-number" class="ds-form-label">åƒè€ƒç·¨è™Ÿï¼ˆé¸å¡«ï¼‰</label>
                <input 
                    type="text" 
                    id="reference-number" 
                    class="ds-form-input" 
                    placeholder="ä¾‹å¦‚ï¼šä¿¡ç”¨å¡æˆæ¬Šç¢¼ã€è½‰å¸³å¸³è™Ÿç­‰"
                >
            </div>
            
            <!-- å‚™è¨» -->
            <div class="ds-form-group">
                <label for="notes" class="ds-form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea 
                    id="notes" 
                    class="ds-form-input" 
                    rows="3"
                    placeholder="å®¢æˆ¶å¯è¦‹çš„å‚™è¨»"
                ></textarea>
            </div>
            
            <!-- ç®¡ç†å“¡å‚™è¨» -->
            <div class="ds-form-group">
                <label for="admin-notes" class="ds-form-label">ç®¡ç†å“¡å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea 
                    id="admin-notes" 
                    class="ds-form-input" 
                    rows="3"
                    placeholder="åƒ…ç®¡ç†å“¡å¯è¦‹çš„å‚™è¨»"
                ></textarea>
            </div>
            </div>
            
            <!-- æŒ‰éˆ• -->
            <div class="ds-card-footer">
                <button id="btn-cancel-form" class="ds-btn ds-btn-secondary">å–æ¶ˆ</button>
                <button id="btn-submit-transaction" class="ds-btn ds-btn-primary">ç¢ºèªäº¤æ˜“</button>
            </div>
        </div>
        
        <!-- äº¤æ˜“è¨˜éŒ„åˆ—è¡¨ -->
        <div class="ds-card">
            <div class="ds-card-header">
                <div class="ds-card-title">äº¤æ˜“è¨˜éŒ„</div>
            </div>
            <div id="transactions-list" class="ds-p-md">
                <!-- å‹•æ…‹è¼‰å…¥ -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/wallet-points.js"></script>
    <script src="../js/checkout.js"></script>
    
    <script>
        let allMembers = [];
        let memberBookings = [];
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) {
                    return;
                }
                
                await loadMembers();
                await loadPaymentMethods();
                await loadAllTransactions();
                
                // ç¶å®šäº‹ä»¶
                setupEventListeners();
                
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
            }
        });
        
        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // æ–°å¢äº¤æ˜“æŒ‰éˆ•
            document.getElementById('btn-new-transaction').addEventListener('click', () => {
                resetForm(); // ç¢ºä¿è¡¨å–®æ˜¯ä¹¾æ·¨çš„
                showCheckoutForm();
            });
            
            // å–æ¶ˆè¡¨å–®
            document.getElementById('btn-cancel-form').addEventListener('click', () => {
                hideCheckoutForm();
                resetForm();
            });
            
            // æœƒå“¡é¸æ“‡è®Šæ›´
            document.getElementById('member-select').addEventListener('change', async (e) => {
                const memberSelect = e.target;
                const selectedOption = memberSelect.options[memberSelect.selectedIndex];
                const memberId = selectedOption.getAttribute('data-member-id'); // ä½¿ç”¨ data-member-id ç²å– UUID
                const lineUserId = e.target.value; // value æ˜¯ line_user_id
                
                if (memberId || lineUserId) {
                    await loadMemberBookings(memberId || lineUserId);
                    // è¼‰å…¥æœƒå“¡å„²å€¼é‡‘è³‡è¨Š
                    await loadMemberWalletInfo(lineUserId);
                } else {
                    document.getElementById('booking-select').innerHTML = '<option value="">ä¸é—œè¯é ç´„</option>';
                    document.getElementById('booking-preview').style.display = 'none';
                    const walletHint = document.getElementById('wallet-balance-hint');
                    if (walletHint) {
                        walletHint.style.display = 'none';
                    }
                }
            });
            
            // ä»˜æ¬¾æ–¹å¼è®Šæ›´ï¼ˆæª¢æŸ¥æ˜¯å¦é¸æ“‡å„²å€¼é‡‘ï¼‰
            document.getElementById('payment-method').addEventListener('change', async (e) => {
                const paymentMethod = e.target.value;
                const memberSelect = document.getElementById('member-select');
                
                if (paymentMethod === 'wallet' && memberSelect.value) {
                    // é¸æ“‡å„²å€¼é‡‘ä»˜æ¬¾ï¼Œé¡¯ç¤ºé¤˜é¡è³‡è¨Š
                    await loadMemberWalletInfo(memberSelect.value);
                    const walletHint = document.getElementById('wallet-balance-hint');
                    if (walletHint) {
                        walletHint.style.display = 'block';
                    }
                    updateWalletPaymentInfo();
                } else {
                    // é¸æ“‡å…¶ä»–ä»˜æ¬¾æ–¹å¼ï¼Œéš±è—å„²å€¼é‡‘æç¤º
                    const walletHint = document.getElementById('wallet-balance-hint');
                    if (walletHint) {
                        walletHint.style.display = 'none';
                    }
                }
            });
            
            // é‡‘é¡æˆ–æŠ˜æ‰£è®Šæ›´æ™‚æ›´æ–°å„²å€¼é‡‘æç¤º
            document.getElementById('amount').addEventListener('input', updateWalletPaymentInfo);
            document.getElementById('discount-amount').addEventListener('input', updateWalletPaymentInfo);
            
            // é ç´„é¸æ“‡è®Šæ›´
            document.getElementById('booking-select').addEventListener('change', (e) => {
                const bookingId = e.target.value;
                if (bookingId) {
                    displayBookingPreview(bookingId);
                } else {
                    document.getElementById('booking-preview').style.display = 'none';
                }
            });
            
            // äº¤æ˜“é¡å‹è®Šæ›´
            document.getElementById('transaction-type').addEventListener('change', (e) => {
                const type = e.target.value;
                if (type === 'refund') {
                    document.getElementById('form-title').textContent = 'æ–°å¢é€€æ¬¾';
                } else {
                    document.getElementById('form-title').textContent = 'æ–°å¢äº¤æ˜“';
                }
            });
            
            // æäº¤äº¤æ˜“
            document.getElementById('btn-submit-transaction').addEventListener('click', async () => {
                await submitTransaction();
            });
            
            // ç®¡ç†å“¡ç™»å‡º
            document.getElementById('btn-admin-logout').addEventListener('click', () => {
                Auth.adminLogout();
            });
        }
        
        // è¼‰å…¥æœƒå“¡åˆ—è¡¨
        async function loadMembers() {
            try {
                // ä½¿ç”¨ MemberAPI.getAll ç²å–æ‰€æœ‰æœƒå“¡ï¼ˆè¨­ç½®ä¸€å€‹å¾ˆå¤§çš„ limit ä¾†ç²å–æ‰€æœ‰æœƒå“¡ï¼‰
                const result = await MemberAPI.getAll(1000, 0);
                allMembers = result.members || [];
                
                const memberSelect = document.getElementById('member-select');
                memberSelect.innerHTML = '<option value="">è«‹é¸æ“‡æœƒå“¡</option>' +
                    allMembers.map(member => `
                        <option value="${member.line_user_id}" data-member-id="${member.id}">${member.name} (${member.phone || 'ç„¡é›»è©±'})</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—', error);
                showMessage('è¼‰å…¥æœƒå“¡åˆ—è¡¨å¤±æ•—', 'error');
            }
        }
        
        // è¼‰å…¥ä»˜æ¬¾æ–¹å¼
        async function loadPaymentMethods() {
            try {
                const methods = await CheckoutAPI.getActivePaymentMethods();
                
                const paymentMethodSelect = document.getElementById('payment-method');
                paymentMethodSelect.innerHTML = '<option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>' +
                    methods.map(method => `
                        <option value="${method.code}">${method.name}</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥ä»˜æ¬¾æ–¹å¼å¤±æ•—', error);
                showMessage('è¼‰å…¥ä»˜æ¬¾æ–¹å¼å¤±æ•—', 'error');
            }
        }
        
        // è¼‰å…¥æœƒå“¡çš„é ç´„
        async function loadMemberBookings(memberId) {
            try {
                const member = allMembers.find(m => m.id === memberId || m.line_user_id === memberId);
                if (!member) {
                    CONFIG.error('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™', { memberId, allMembers });
                    return;
                }
                
                // ä½¿ç”¨ç®¡ç†å“¡ API ç²å–è©²æœƒå“¡çš„æ‰€æœ‰é ç´„ï¼ˆå› ç‚ºç®¡ç†å“¡æ‡‰è©²èƒ½çœ‹åˆ°æ‰€æœ‰é ç´„ï¼‰
                const client = getSupabase();
                const { data: bookingsData, error } = await client
                    .from('bookings')
                    .select('*')
                    .eq('member_id', member.id)
                    .order('booking_date', { ascending: false })
                    .order('booking_time', { ascending: false })
                    .limit(100);
                
                if (error) {
                    CONFIG.error('æŸ¥è©¢é ç´„å¤±æ•—', error);
                    // å¦‚æœç®¡ç†å“¡æŸ¥è©¢å¤±æ•—ï¼Œå˜—è©¦ä½¿ç”¨æœƒå“¡ API
                    const bookings = await BookingAPI.getMyBookings(member.line_user_id, 100);
                    memberBookings = bookings || [];
                } else {
                    // ç¢ºä¿æœ‰ payment_status å’Œ paid_amountï¼ˆå¦‚æœè³‡æ–™åº«ä¸­æ²’æœ‰ï¼Œè¨­ç‚ºé è¨­å€¼ï¼‰
                    memberBookings = (bookingsData || []).map(b => ({
                        ...b,
                        payment_status: b.payment_status || 'unpaid',
                        paid_amount: b.paid_amount || 0
                    }));
                }
                
                // éæ¿¾ï¼šåªé¡¯ç¤ºæœªå–æ¶ˆçš„é ç´„
                memberBookings = memberBookings.filter(b => 
                    b.status !== 'cancelled'
                );
                
                // æª¢æŸ¥æ¯å€‹é ç´„æ˜¯å¦å·²æœ‰ä»˜æ¬¾äº¤æ˜“
                for (const booking of memberBookings) {
                    const { data: payments } = await client
                        .from('transactions')
                        .select('id')
                        .eq('booking_id', booking.id)
                        .eq('transaction_type', 'payment')
                        .eq('status', 'completed')
                        .limit(1);
                    
                    booking.hasPayment = (payments && payments.length > 0);
                }
                
                const bookingSelect = document.getElementById('booking-select');
                const editId = document.getElementById('checkout-form').getAttribute('data-edit-id');
                
                if (memberBookings.length === 0) {
                    bookingSelect.innerHTML = '<option value="">è©²æœƒå“¡å°šç„¡å¯é—œè¯çš„é ç´„</option>';
                } else {
                    bookingSelect.innerHTML = '<option value="">ä¸é—œè¯é ç´„</option>' +
                        memberBookings.map(booking => {
                            const paymentStatusText = booking.payment_status === 'unpaid' ? 'æœªä»˜æ¬¾' :
                                                      booking.payment_status === 'partial' ? 'éƒ¨åˆ†ä»˜æ¬¾' :
                                                      booking.payment_status === 'paid' ? 'å·²ä»˜æ¬¾' :
                                                      booking.payment_status === 'refunded' ? 'å·²é€€æ¬¾' : 'æœªçŸ¥';
                            
                            // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œå…è¨±é¸æ“‡å·²çµå¸³çš„é ç´„ï¼›å¦å‰‡ç¦ç”¨å·²çµå¸³çš„é ç´„
                            const hasPayment = booking.hasPayment || booking.payment_status === 'paid';
                            const isDisabled = hasPayment && !editId;
                            
                            return `
                                <option value="${booking.id}" ${isDisabled ? 'disabled' : ''}>${booking.service_name} - ${booking.booking_date} ${booking.booking_time} (NT$ ${booking.service_price.toLocaleString()}) [${paymentStatusText}]${hasPayment && !editId ? ' [å·²çµå¸³]' : ''}</option>
                            `;
                        }).join('');
                }
                
                CONFIG.log('è¼‰å…¥é ç´„æˆåŠŸ', { 
                    memberId: member.id, 
                    memberName: member.name,
                    bookingsCount: memberBookings.length 
                });
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥é ç´„å¤±æ•—', error);
                showMessage('è¼‰å…¥é ç´„å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                document.getElementById('booking-select').innerHTML = '<option value="">è¼‰å…¥é ç´„å¤±æ•—</option>';
            }
        }
        
        // é¡¯ç¤ºé ç´„é è¦½
        function displayBookingPreview(bookingId) {
            const booking = memberBookings.find(b => b.id === bookingId);
            if (!booking) {
                CONFIG.error('æ‰¾ä¸åˆ°é ç´„è³‡æ–™', { bookingId, memberBookings });
                return;
            }
            
            // ç¢ºä¿æœ‰é è¨­å€¼
            const paymentStatus = booking.payment_status || 'unpaid';
            const paidAmount = booking.paid_amount || 0;
            const servicePrice = booking.service_price || 0;
            
            const paymentStatusText = paymentStatus === 'unpaid' ? 'æœªä»˜æ¬¾' :
                                      paymentStatus === 'partial' ? 'éƒ¨åˆ†ä»˜æ¬¾' :
                                      paymentStatus === 'paid' ? 'å·²ä»˜æ¬¾' :
                                      paymentStatus === 'refunded' ? 'å·²é€€æ¬¾' : 'æœªçŸ¥';
            
            const preview = document.getElementById('booking-preview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="color: #86868B; font-size: 12px;">æœå‹™</div>
                        <div style="font-weight: 600;">${booking.service_name || 'æœªçŸ¥'}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">æ—¥æœŸæ™‚é–“</div>
                        <div style="font-weight: 600;">${booking.booking_date || ''} ${booking.booking_time || ''}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">é‡‘é¡</div>
                        <div style="font-weight: 600;">NT$ ${servicePrice.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">ä»˜æ¬¾ç‹€æ…‹</div>
                        <div style="font-weight: 600;">${paymentStatusText}</div>
                    </div>
                </div>
                ${paidAmount > 0 ? `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #D2D2D7;">
                        <div style="color: #86868B; font-size: 12px;">å·²ä»˜é‡‘é¡</div>
                        <div style="font-weight: 600; color: #34C759;">NT$ ${paidAmount.toLocaleString()}</div>
                    </div>
                ` : ''}
            `;
            
            // è‡ªå‹•å¡«å…¥é‡‘é¡ï¼ˆå¦‚æœæ²’æœ‰å¡«å¯«ä¸”ä¸æ˜¯å·²ä»˜æ¬¾ï¼‰
            if (!document.getElementById('amount').value && paymentStatus !== 'paid') {
                const remaining = servicePrice - paidAmount;
                if (remaining > 0) {
                    document.getElementById('amount').value = remaining.toFixed(2);
                }
            }
        }
        
        // è¼‰å…¥æ‰€æœ‰äº¤æ˜“è¨˜éŒ„
        async function loadAllTransactions() {
            try {
                // é¡¯ç¤ºéª¨æ¶å±
                const transactionsList = document.getElementById('transactions-list');
                if (transactionsList && typeof UI !== 'undefined') {
                    UI.showSkeleton(transactionsList, 'list');
                }
                
                const client = getSupabase();
                
                // å…ˆæŸ¥è©¢äº¤æ˜“è¨˜éŒ„
                const { data: transactions, error } = await client
                    .from('transactions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                // åˆ†åˆ¥æŸ¥è©¢æœƒå“¡å’Œé ç´„è³‡æ–™ï¼Œé¿å…é—œè¯é—œä¿‚è¡çª
                const transactionsWithRelations = await Promise.all((transactions || []).map(async (transaction) => {
                    // æŸ¥è©¢æœƒå“¡è³‡æ–™
                    if (transaction.member_id) {
                        const { data: member } = await client
                            .from('members')
                            .select('line_user_id, name, phone')
                            .eq('id', transaction.member_id)
                            .single();
                        
                        transaction.members = member || null;
                    }
                    
                    // æŸ¥è©¢é ç´„è³‡æ–™
                    if (transaction.booking_id) {
                        const { data: booking } = await client
                            .from('bookings')
                            .select('id, service_name, booking_date, booking_time')
                            .eq('id', transaction.booking_id)
                            .single();
                        
                        transaction.bookings = booking || null;
                    }
                    
                    return transaction;
                }));
                
                displayTransactions(transactionsWithRelations);
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥äº¤æ˜“è¨˜éŒ„å¤±æ•—', error);
                showMessage('è¼‰å…¥äº¤æ˜“è¨˜éŒ„å¤±æ•—', 'error');
            }
        }
        
        // é¡¯ç¤ºäº¤æ˜“è¨˜éŒ„
        function displayTransactions(transactions) {
            const transactionsList = document.getElementById('transactions-list');
            
            if (transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="ds-empty">
                        <div class="ds-empty-icon">ğŸ“‹</div>
                        <div class="ds-empty-title">å°šç„¡äº¤æ˜“è¨˜éŒ„</div>
                        <div class="ds-empty-text">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€ç­†äº¤æ˜“</div>
                    </div>
                `;
                return;
            }
            
            transactionsList.innerHTML = transactions.map(transaction => {
                const typeMap = {
                    'payment': { text: 'ä»˜æ¬¾', class: 'ds-badge-success' },
                    'refund': { text: 'é€€æ¬¾', class: 'ds-badge-error' },
                    'deposit': { text: 'å„²å€¼', class: 'ds-badge-info' },
                    'withdrawal': { text: 'æé ˜', class: 'ds-badge-warning' },
                };
                const statusMap = {
                    'pending': { text: 'å¾…è™•ç†', class: 'ds-badge-warning' },
                    'completed': { text: 'å·²å®Œæˆ', class: 'ds-badge-success' },
                    'failed': { text: 'å¤±æ•—', class: 'ds-badge-error' },
                    'cancelled': { text: 'å·²å–æ¶ˆ', class: 'ds-badge-default' },
                    'refunded': { text: 'å·²é€€æ¬¾', class: 'ds-badge-default' },
                };
                
                const type = typeMap[transaction.transaction_type] || { text: transaction.transaction_type, class: 'ds-badge-default' };
                const status = statusMap[transaction.status] || { text: transaction.status, class: 'ds-badge-default' };
                const member = transaction.members || {};
                const amountColor = transaction.amount >= 0 ? 'var(--text-primary)' : 'var(--color-error)';
                
                return `
                    <div class="ds-list-item ds-mb-md">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                                    <span class="ds-badge ${type.class}">${type.text}</span>
                                    <span class="ds-badge ${status.class}">${status.text}</span>
                                    ${transaction.receipt_number ? `<span class="ds-text-secondary" style="font-size: 14px;">æ”¶æ“šï¼š${transaction.receipt_number}</span>` : ''}
                                </div>
                                <div class="ds-text-secondary" style="font-size: 14px; line-height: 1.6;">
                                    <div><strong>æœƒå“¡ï¼š</strong>${member.name || 'æœªçŸ¥'} (${member.phone || 'ç„¡é›»è©±'})</div>
                                    ${transaction.bookings ? `<div><strong>é ç´„ï¼š</strong>${transaction.bookings.service_name || 'æœªçŸ¥'} - ${transaction.bookings.booking_date || ''} ${transaction.bookings.booking_time || ''}</div>` : ''}
                                    <div><strong>é‡‘é¡ï¼š</strong><span style="color: ${amountColor}; font-weight: 600; font-size: 18px;">NT$ ${Math.abs(transaction.amount).toLocaleString()}</span></div>
                                    <div><strong>ä»˜æ¬¾æ–¹å¼ï¼š</strong>${transaction.payment_method_name || 'æœªçŸ¥'}</div>
                                    ${transaction.description ? `<div><strong>èªªæ˜ï¼š</strong>${transaction.description}</div>` : ''}
                                    ${transaction.created_at ? `<div><strong>æ™‚é–“ï¼š</strong>${formatDateTime(transaction.created_at)}</div>` : ''}
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button class="admin-action-btn" onclick="editTransaction('${transaction.id}')" title="ç·¨è¼¯">
                                    ç·¨è¼¯
                                </button>
                                <button class="admin-action-btn danger" onclick="deleteTransaction('${transaction.id}')" title="åˆªé™¤">
                                    åˆªé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // é¡¯ç¤ºçµå¸³è¡¨å–®
        function showCheckoutForm() {
            document.getElementById('checkout-form').style.display = 'block';
            document.getElementById('checkout-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        // éš±è—çµå¸³è¡¨å–®
        function hideCheckoutForm() {
            document.getElementById('checkout-form').style.display = 'none';
        }
        
        // é‡ç½®è¡¨å–®
        function resetForm() {
            // æ‰‹å‹•é‡ç½®æ‰€æœ‰è¡¨å–®æ¬„ä½ï¼ˆå› ç‚º checkout-form æ˜¯ div è€Œä¸æ˜¯ formï¼‰
            document.getElementById('member-select').value = '';
            document.getElementById('booking-select').innerHTML = '<option value="">ä¸é—œè¯é ç´„</option>';
            document.getElementById('booking-preview').style.display = 'none';
            document.getElementById('transaction-type').value = 'payment';
            document.getElementById('form-title').textContent = 'æ–°å¢äº¤æ˜“';
            document.getElementById('amount').value = '';
            document.getElementById('discount-amount').value = '0';
            document.getElementById('payment-method').value = '';
            document.getElementById('description').value = '';
            document.getElementById('receipt-number').value = '';
            document.getElementById('reference-number').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('admin-notes').value = '';
            
            // æ¸…é™¤ç·¨è¼¯ ID
            document.getElementById('checkout-form').removeAttribute('data-edit-id');
            
            // æ¸…ç©ºé ç´„è³‡æ–™
            memberBookings = [];
            
            // é‡ç½®å„²å€¼é‡‘ç›¸é—œ
            const walletHint = document.getElementById('wallet-balance-hint');
            if (walletHint) {
                walletHint.style.display = 'none';
            }
            const balanceDisplay = document.getElementById('wallet-balance-display');
            if (balanceDisplay) {
                balanceDisplay.textContent = 'NT$ 0';
            }
            window.currentMemberWallet = null;
        }
        
        // è¼‰å…¥æœƒå“¡å„²å€¼é‡‘è³‡è¨Š
        async function loadMemberWalletInfo(lineUserId) {
            try {
                const wallet = await WalletPointsAPI.getMemberWallet(lineUserId);
                const balanceDisplay = document.getElementById('wallet-balance-display');
                
                if (wallet && wallet.balance > 0) {
                    if (balanceDisplay) {
                        balanceDisplay.textContent = WalletPointsAPI.formatAmount(wallet.balance);
                    }
                    // å„²å­˜åˆ°å…¨å±€è®Šæ•¸ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
                    window.currentMemberWallet = wallet;
                } else {
                    if (balanceDisplay) {
                        balanceDisplay.textContent = 'NT$ 0';
                    }
                    window.currentMemberWallet = { balance: 0 };
                }
                
                // å¦‚æœç•¶å‰é¸æ“‡çš„æ˜¯å„²å€¼é‡‘ä»˜æ¬¾ï¼Œæ›´æ–°æç¤ºè³‡è¨Š
                const paymentMethod = document.getElementById('payment-method');
                if (paymentMethod && paymentMethod.value === 'wallet') {
                    updateWalletPaymentInfo();
                }
            } catch (error) {
                CONFIG.error('è¼‰å…¥å„²å€¼é‡‘è³‡è¨Šå¤±æ•—', error);
                window.currentMemberWallet = { balance: 0 };
                // ä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œå› ç‚ºé€™ä¸æ˜¯é—œéµåŠŸèƒ½
            }
        }
        
        // æ›´æ–°å„²å€¼é‡‘ä»˜æ¬¾æç¤ºè³‡è¨Š
        function updateWalletPaymentInfo() {
            const paymentMethodSelect = document.getElementById('payment-method');
            if (!paymentMethodSelect) return;
            
            const paymentMethod = paymentMethodSelect.value;
            const walletHint = document.getElementById('wallet-balance-hint');
            const walletInfo = document.getElementById('wallet-payment-info');
            
            if (!walletHint || !walletInfo) {
                return; // å…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            }
            
            if (paymentMethod !== 'wallet') {
                walletHint.style.display = 'none';
                return;
            }
            
            const wallet = window.currentMemberWallet || { balance: 0 };
            const amountInput = document.getElementById('amount');
            const discountInput = document.getElementById('discount-amount');
            
            if (!amountInput || !discountInput) {
                return;
            }
            
            const amount = parseFloat(amountInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const totalAmount = amount + discount;
            const walletBalance = wallet.balance || 0;
            
            if (totalAmount > 0) {
                if (walletBalance >= totalAmount) {
                    walletInfo.textContent = `å°‡ä½¿ç”¨å„²å€¼é‡‘æ”¯ä»˜å…¨é¡ NT$ ${totalAmount.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    walletInfo.style.color = '#0277BD';
                } else {
                    walletInfo.textContent = `å„²å€¼é‡‘é¤˜é¡ä¸è¶³ï¼Œåƒ…èƒ½æ”¯ä»˜ NT$ ${walletBalance.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}ï¼Œå‰©é¤˜éœ€ä½¿ç”¨å…¶ä»–æ–¹å¼ä»˜æ¬¾`;
                    walletInfo.style.color = '#FF3B30';
                }
            } else {
                walletInfo.textContent = 'è«‹å…ˆè¼¸å…¥äº¤æ˜“é‡‘é¡';
                walletInfo.style.color = '#86868B';
            }
        }
        
        // æäº¤äº¤æ˜“
        async function submitTransaction() {
            try {
                const memberSelect = document.getElementById('member-select');
                const bookingSelect = document.getElementById('booking-select');
                const transactionType = document.getElementById('transaction-type').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;
                const paymentMethod = document.getElementById('payment-method').value;
                const description = document.getElementById('description').value.trim();
                const receiptNumber = document.getElementById('receipt-number').value.trim();
                const referenceNumber = document.getElementById('reference-number').value.trim();
                const notes = document.getElementById('notes').value.trim();
                const adminNotes = document.getElementById('admin-notes').value.trim();
                
                // é©—è­‰
                if (!memberSelect.value) {
                    UI.error('è«‹é¸æ“‡æœƒå“¡');
                    return;
                }
                
                if (!amount || amount <= 0) {
                    UI.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
                    return;
                }
                
                if (!paymentMethod) {
                    UI.error('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼');
                    return;
                }
                
                // è¨ˆç®—ç¸½é‡‘é¡
                const totalAmount = amount + discountAmount;
                
                // æª¢æŸ¥å„²å€¼é‡‘ä»˜æ¬¾ï¼ˆå¦‚æœä»˜æ¬¾æ–¹å¼ç‚ºå„²å€¼é‡‘ï¼‰
                if (paymentMethod === 'wallet') {
                    const wallet = window.currentMemberWallet || await WalletPointsAPI.getMemberWallet(memberSelect.value);
                    if (!wallet || wallet.balance <= 0) {
                        UI.error('æœƒå“¡å„²å€¼é‡‘é¤˜é¡ä¸è¶³ï¼Œç„¡æ³•ä½¿ç”¨å„²å€¼é‡‘ä»˜æ¬¾');
                        return;
                    }
                    
                    // å¦‚æœå„²å€¼é‡‘ä¸è¶³ï¼Œæç¤ºä½†ä¸é˜»æ­¢ï¼ˆç³»çµ±æœƒåœ¨å¾Œç«¯è™•ç†éƒ¨åˆ†æ”¯ä»˜ï¼‰
                    if (wallet.balance < totalAmount) {
                        UI.warning(`å„²å€¼é‡‘é¤˜é¡ï¼ˆNT$ ${WalletPointsAPI.formatAmount(wallet.balance)}ï¼‰ä¸è¶³ä»¥æ”¯ä»˜å…¨é¡ï¼ˆNT$ ${totalAmount.toLocaleString('zh-TW', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}ï¼‰ï¼Œå°‡ä½¿ç”¨å„²å€¼é‡‘æ”¯ä»˜éƒ¨åˆ†é‡‘é¡`);
                    }
                }
                
                const form = document.getElementById('checkout-form');
                const editId = form.getAttribute('data-edit-id');
                const isEdit = !!editId;
                
                if (isEdit) {
                    UI.warning('ç·¨è¼¯äº¤æ˜“æ™‚ç„¡æ³•ä½¿ç”¨å„²å€¼é‡‘ä»˜æ¬¾');
                    return;
                }
                
                UI.showLoading('å»ºç«‹äº¤æ˜“ä¸­...');
                
                // å»ºç«‹æ–°äº¤æ˜“
                const transaction = await CheckoutAPI.createTransaction({
                    lineUserId: memberSelect.value,
                    bookingId: bookingSelect.value || null,
                    transactionType: transactionType,
                    amount: amount,
                    totalAmount: totalAmount,
                    discountAmount: discountAmount,
                    paymentMethodCode: paymentMethod,
                    description: description || null,
                    receiptNumber: receiptNumber || null,
                    referenceNumber: referenceNumber || null,
                    notes: notes || null,
                    adminNotes: adminNotes || null,
                });
                
                UI.hideLoading();
                UI.success('äº¤æ˜“å»ºç«‹æˆåŠŸï¼');
                
                // é‡ç½®è¡¨å–®ä¸¦é‡æ–°è¼‰å…¥äº¤æ˜“åˆ—è¡¨
                resetForm();
                hideCheckoutForm();
                await loadAllTransactions();
                
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('å»ºç«‹äº¤æ˜“å¤±æ•—', error);
                UI.error(error.message || 'å»ºç«‹äº¤æ˜“å¤±æ•—');
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
            });
        }
        
        // ç·¨è¼¯äº¤æ˜“
        async function editTransaction(transactionId) {
            try {
                // å–å¾—äº¤æ˜“è¨˜éŒ„
                const transaction = await CheckoutAPI.getTransactionById(transactionId);
                
                // å¡«å…¥è¡¨å–®
                const member = transaction.members || {};
                const memberOption = Array.from(document.getElementById('member-select').options)
                    .find(opt => opt.value === member.line_user_id);
                
                if (memberOption) {
                    document.getElementById('member-select').value = member.line_user_id;
                    // è§¸ç™¼æœƒå“¡é¸æ“‡è®Šæ›´äº‹ä»¶
                    document.getElementById('member-select').dispatchEvent(new Event('change'));
                    
                    // ç­‰å¾…é ç´„è¼‰å…¥å¾Œå†é¸æ“‡é ç´„
                    setTimeout(async () => {
                        if (transaction.booking_id) {
                            document.getElementById('booking-select').value = transaction.booking_id;
                            document.getElementById('booking-select').dispatchEvent(new Event('change'));
                        }
                        
                        document.getElementById('transaction-type').value = transaction.transaction_type || 'payment';
                        document.getElementById('amount').value = Math.abs(transaction.amount || 0);
                        document.getElementById('discount-amount').value = transaction.discount_amount || 0;
                        document.getElementById('payment-method').value = transaction.payment_method_code || '';
                        document.getElementById('description').value = transaction.description || '';
                        document.getElementById('receipt-number').value = transaction.receipt_number || '';
                        document.getElementById('reference-number').value = transaction.reference_number || '';
                        document.getElementById('notes').value = transaction.notes || '';
                        document.getElementById('admin-notes').value = transaction.admin_notes || '';
                        
                        // æ›´æ–°è¡¨å–®æ¨™é¡Œ
                        document.getElementById('form-title').textContent = 'ç·¨è¼¯äº¤æ˜“';
                        
                        // å„²å­˜ç·¨è¼¯çš„äº¤æ˜“ ID
                        document.getElementById('checkout-form').setAttribute('data-edit-id', transactionId);
                        
                        // é¡¯ç¤ºè¡¨å–®
                        showCheckoutForm();
                    }, 500);
                } else {
                    showMessage('æ‰¾ä¸åˆ°å°æ‡‰çš„æœƒå“¡è³‡æ–™', 'error');
                }
            } catch (error) {
                CONFIG.error('è¼‰å…¥äº¤æ˜“è³‡æ–™å¤±æ•—', error);
                showMessage('è¼‰å…¥äº¤æ˜“è³‡æ–™å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            }
        }
        
        // åˆªé™¤äº¤æ˜“
        async function deleteTransaction(transactionId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“è¨˜éŒ„å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆªé™¤äº¤æ˜“å¾Œï¼Œé—œè¯çš„é ç´„ä»˜æ¬¾ç‹€æ…‹ä¹Ÿæœƒè¢«æ›´æ–°ã€‚')) {
                return;
            }
            
            try {
                showLoading('åˆªé™¤ä¸­...');
                
                await CheckoutAPI.deleteTransaction(transactionId);
                
                    hideLoading();
                    showMessage('äº¤æ˜“è¨˜éŒ„å·²åˆªé™¤', 'success');
                
                // é‡æ–°è¼‰å…¥äº¤æ˜“åˆ—è¡¨
                await loadAllTransactions();
                
            } catch (error) {
                hideLoading();
                CONFIG.error('åˆªé™¤äº¤æ˜“å¤±æ•—', error);
                showMessage('åˆªé™¤å¤±æ•—ï¼š' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            }
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            if (type === 'error') {
                alert('âŒ ' + message);
            } else if (type === 'success') {
                alert('âœ… ' + message);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>

