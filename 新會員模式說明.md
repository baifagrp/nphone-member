# 🔐 新會員模式完整說明

## 📋 系統概述

NPHONE 會員系統採用「Email 驗證 + 自動比對」模式，提供靈活且安全的會員管理機制。

---

## 🎯 核心特色

### 1. Email 驗證註冊 ✅
- 用戶透過 LINE Login 登入
- 必須填寫並驗證 Email
- 使用 EmailJS 發送驗證碼
- 10 分鐘有效期

### 2. 後台預先建立 👨‍💼
- 商家可在後台預先建立會員資料
- 可預先添加：
  - 預約記錄
  - 儲值金
  - 消費積分
  - 結帳紀錄

### 3. 自動比對合併 🔄
- 用戶註冊時自動比對 Email
- 找到現有會員自動綁定 LINE
- 所有資料無縫接軌
- 避免重複建立

---

## 🔄 完整流程圖

```
用戶端註冊流程：
┌──────────────────┐
│ 1. 點擊 LINE 登入│
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 2. LINE 授權     │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 3. 輸入 Email    │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 4. 發送驗證碼    │
│ (EmailJS)        │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 5. 輸入驗證碼    │
└────────┬─────────┘
         ↓
┌──────────────────────────┐
│ 6. 系統檢查 Email        │
│                          │
│  Email 已存在？          │
├──────────┬───────────────┤
│   是     │      否       │
↓          ↓               ↓
綁定現有會員  創建新會員
└──────────┴───────────────┘
         ↓
┌──────────────────┐
│ 7. 註冊完成      │
│ 自動登入         │
└──────────────────┘


商家端預建流程：
┌──────────────────┐
│ 1. 後台新增會員  │
│ (只需 Email)     │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 2. 添加資料      │
│ - 預約           │
│ - 儲值金         │
│ - 積分           │
│ - 消費記錄       │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 3. 等待用戶註冊  │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 4. 用戶註冊時    │
│ Email 自動比對   │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 5. LINE 自動綁定 │
│ 資料完整呈現     │
└──────────────────┘
```

---

## 💾 資料庫結構

### members 表（會員主表）

| 欄位 | 類型 | 說明 | 必填 |
|------|------|------|------|
| id | UUID | 主鍵 | ✅ |
| email | TEXT | Email（唯一） | ✅ |
| line_user_id | TEXT | LINE User ID | ❌ |
| line_display_name | TEXT | LINE 顯示名稱 | ❌ |
| name | TEXT | 姓名 | ✅ |
| phone | TEXT | 電話 | ❌ |
| email_verified | BOOLEAN | Email 已驗證 | ✅ |
| registration_status | TEXT | 註冊狀態 | ✅ |
| member_code | TEXT | 會員編號 | ❌ |
| created_at | TIMESTAMP | 建立時間 | ✅ |

**註冊狀態說明：**
- `pending` - 待驗證（商家預建）
- `verified` - 已驗證 Email
- `completed` - 已完成註冊

### email_verification_codes 表（驗證碼）

| 欄位 | 類型 | 說明 |
|------|------|------|
| id | UUID | 主鍵 |
| email | TEXT | Email |
| code | TEXT | 6位數驗證碼 |
| line_user_id | TEXT | LINE User ID |
| expires_at | TIMESTAMP | 過期時間 |
| is_used | BOOLEAN | 是否已使用 |
| created_at | TIMESTAMP | 建立時間 |

---

## 🔧 核心 RPC 函數

### 1. generate_verification_code
```sql
generate_verification_code(
    p_email TEXT,
    p_line_user_id TEXT DEFAULT NULL
) RETURNS TEXT
```
**功能：** 生成 6 位數驗證碼

**使用時機：** 用戶輸入 Email 後

### 2. verify_email_code
```sql
verify_email_code(
    p_email TEXT,
    p_code TEXT
) RETURNS JSONB
```
**功能：** 驗證驗證碼並檢查是否有現有會員

**返回：**
```json
{
  "success": true,
  "email_verified": true,
  "has_existing_member": true/false,
  "member_data": { ... }  // 如果有現有會員
}
```

### 3. complete_registration
```sql
complete_registration(
    p_email TEXT,
    p_line_user_id TEXT,
    p_line_display_name TEXT DEFAULT NULL,
    p_line_picture_url TEXT DEFAULT NULL
) RETURNS JSONB
```
**功能：** 完成註冊（綁定或創建）

**返回：**
```json
{
  "success": true,
  "is_new_member": true/false,
  "message": "...",
  "member": { ... }
}
```

### 4. check_email_exists
```sql
check_email_exists(
    p_email TEXT
) RETURNS JSONB
```
**功能：** 檢查 Email 是否已存在

---

## 📱 前端頁面

### 用戶端

1. **index.html** - LINE Login 入口
2. **auth-callback.html** - LINE 回調處理
3. **member/email-verification.html** ⭐ - Email 驗證頁面
4. **member/profile.html** - 會員首頁

### 管理端

1. **admin/members.html** - 會員列表
2. **admin/member-new.html** ⭐ - 預先建立會員
3. **admin/member-edit.html** - 編輯會員
4. **admin/member-detail.html** - 會員詳情

---

## 🎨 用戶體驗流程

### 情境 A：全新用戶

1. 點擊「LINE 登入」
2. LINE 授權完成
3. 👉 **進入 Email 驗證頁面**
4. 輸入 Email
5. 收到驗證碼郵件
6. 輸入驗證碼
7. ✅ 註冊成功（創建新會員）
8. 自動登入到會員首頁

**時間：** 約 2-3 分鐘

---

### 情境 B：商家預建 + 用戶註冊

#### 商家端操作：
1. 進入「會員管理」
2. 點擊「新增會員」
3. 填寫基本資料（**必填 Email**）
4. （可選）預先添加：
   - 預約記錄
   - 儲值 $1000
   - 贈送 100 點
5. 儲存會員

#### 用戶端操作：
1. 點擊「LINE 登入」
2. LINE 授權完成
3. 進入 Email 驗證頁面
4. 輸入 Email（**與商家預建相同**）
5. 收到驗證碼郵件
6. 輸入驗證碼
7. 🎉 **系統自動檢測到現有會員**
8. ✅ 綁定成功
9. 自動登入，看到：
   - 儲值金：$1000
   - 積分：100 點
   - 歷史預約記錄

**優勢：** 無縫接軌，用戶無需重複填寫

---

## 🔒 安全機制

### 驗證碼安全
- ✅ 10 分鐘自動過期
- ✅ 使用後立即失效
- ✅ 60 秒防重複發送
- ✅ 自動清理過期記錄

### Email 安全
- ✅ 格式驗證
- ✅ 唯一性檢查
- ✅ 防止重複註冊
- ✅ SSL 加密傳輸

### LINE 綁定安全
- ✅ 官方 SDK
- ✅ OAuth 2.0
- ✅ 一對一綁定
- ✅ 防止劫持

---

## 🎯 使用場景

### 場景 1：實體店面會員
**情境：** 客戶在店內消費，想加入會員

**流程：**
1. 商家：後台新增會員（客戶提供 Email）
2. 商家：為會員儲值 $500
3. 客戶：掃描 LINE QR Code 登入
4. 客戶：驗證 Email
5. ✅ 儲值金立即可用

---

### 場景 2：線上預約新客
**情境：** 新客戶想線上預約

**流程：**
1. 客戶：點擊「LINE 登入」
2. 客戶：驗證 Email
3. ✅ 註冊完成
4. 客戶：立即可預約服務

---

### 場景 3：老客戶綁定
**情境：** 老客戶想使用 LINE 功能

**流程：**
1. 商家：確認客戶已在系統中（有 Email）
2. 客戶：LINE 登入
3. 客戶：輸入已登記的 Email
4. 客戶：驗證驗證碼
5. ✅ LINE 綁定成功
6. 歷史記錄全部保留

---

## 📊 優勢總結

### 對用戶
✅ **簡單** - 只需驗證 Email
✅ **快速** - 2-3 分鐘完成
✅ **安全** - 驗證碼保護
✅ **無縫** - 自動綁定現有資料

### 對商家
✅ **靈活** - 可預先建立會員
✅ **高效** - 減少現場登記時間
✅ **完整** - 線上線下資料統一
✅ **可控** - 後台完整管理

---

## 🚀 部署檢查清單

- [ ] 執行 `email-verification-schema.sql`
- [ ] 執行 `email-verification-rpc.sql`
- [ ] 設置 EmailJS 帳號
- [ ] 創建 Email 模板
- [ ] 配置 `config.js`
- [ ] 測試發送驗證碼
- [ ] 測試驗證流程
- [ ] 測試自動比對
- [ ] 測試後台預建
- [ ] 測試綁定流程

---

## 📞 技術支援

如有問題，請檢查：
1. EmailJS 設置是否正確
2. SQL 是否都已執行
3. config.js 配置是否正確
4. 瀏覽器 Console 錯誤訊息
5. Supabase Logs

---

**新會員模式已準備就緒！** 🎉

提供靈活、安全、高效的會員管理體驗！

