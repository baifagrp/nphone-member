<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é ç´„</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="../index.html" class="navbar-brand">æœƒå“¡ç³»çµ±</a>
            <div class="navbar-menu">
                <a href="profile.html" class="navbar-link">å€‹äººè³‡æ–™</a>
                <a href="booking.html" class="navbar-link">ç·šä¸Šé ç´„</a>
                <a href="bookings.html" class="navbar-link">æˆ‘çš„é ç´„</a>
                <button id="btn-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container-sm" style="margin-top: 40px;">
        <div class="flex-between" style="margin-bottom: 24px;">
            <h1 style="font-size: 32px; font-weight: 700;">æˆ‘çš„é ç´„</h1>
            <a href="booking.html" class="btn btn-success">+ æ–°å¢é ç´„</a>
        </div>
        
        <!-- é ç´„åˆ—è¡¨ -->
        <div id="bookings-list">
            <div class="card">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireMemberLogin()) {
                    return;
                }
                
                await loadMyBookings();
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
            }
        });
        
        // è¼‰å…¥æˆ‘çš„é ç´„
        async function loadMyBookings() {
            try {
                const session = Auth.getMemberSession();
                if (!session) {
                    return;
                }
                
                const bookings = await BookingAPI.getMyBookings(session.lineUserId);
                
                if (bookings.length === 0) {
                    document.getElementById('bookings-list').innerHTML = `
                        <div class="card">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <p>å°šç„¡é ç´„è¨˜éŒ„</p>
                                <a href="booking.html" class="btn btn-primary" style="margin-top: 16px;">ç«‹å³é ç´„</a>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // é¡¯ç¤ºé ç´„åˆ—è¡¨
                document.getElementById('bookings-list').innerHTML = bookings.map(booking => {
                    const statusMap = {
                        'pending': { text: 'å¾…ç¢ºèª', class: 'status-warning' },
                        'confirmed': { text: 'å·²ç¢ºèª', class: 'status-success' },
                        'cancelled': { text: 'å·²å–æ¶ˆ', class: 'status-gray' },
                        'completed': { text: 'å·²å®Œæˆ', class: 'status-success' },
                        'no_show': { text: 'æœªåˆ°', class: 'status-error' },
                    };
                    
                    const status = statusMap[booking.status] || { text: booking.status, class: 'status-gray' };
                    const canCancel = booking.status === 'pending' || booking.status === 'confirmed';
                    const bookingDateTime = new Date(`${booking.booking_date}T${booking.booking_time}`);
                    const isPast = bookingDateTime < new Date();
                    
                    return `
                        <div class="card" style="margin-bottom: 16px;">
                            <div class="flex-between">
                                <div>
                                    <h3 style="margin-bottom: 8px;">${booking.service_name}</h3>
                                    <div style="color: #86868B; font-size: 14px;">
                                        <div>ğŸ“… ${formatDateDisplay(booking.booking_date)}</div>
                                        <div>â° ${booking.booking_time}</div>
                                        <div>â± ${booking.service_duration} åˆ†é˜</div>
                                        ${booking.service_option_name ? `<div>ğŸ“± å‹è™Ÿï¼š${booking.service_option_name}</div>` : ''}
                                        <div>ğŸ’° NT$ ${booking.service_price.toLocaleString()}</div>
                                    </div>
                                    ${booking.notes ? `<div style="margin-top: 12px; padding: 12px; background: #F5F5F7; border-radius: 8px; color: #666;">ğŸ“ ${booking.notes}</div>` : ''}
                                </div>
                                <div style="text-align: right;">
                                    <div class="status-badge ${status.class}" style="margin-bottom: 12px;">${status.text}</div>
                                    ${canCancel && !isPast ? `
                                        <button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking.id}', '${booking.service_name}')">
                                            å–æ¶ˆé ç´„
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥é ç´„å¤±æ•—', error);
                document.getElementById('bookings-list').innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px; color: #FF3B30;">
                            <p>è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</p>
                        </div>
                    </div>
                `;
            }
        }
        
        // å–æ¶ˆé ç´„
        async function cancelBooking(bookingId, serviceName) {
            if (!confirm(`ç¢ºå®šè¦å–æ¶ˆé ç´„ã€Œ${serviceName}ã€å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const session = Auth.getMemberSession();
                if (!session) {
                    alert('è«‹å…ˆç™»å…¥');
                    return;
                }
                
                showLoading('å–æ¶ˆä¸­...');
                
                await BookingAPI.cancelBookingByMember(session.lineUserId, bookingId);
                
                hideLoading();
                showMessage('é ç´„å·²å–æ¶ˆ', 'success');
                
                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                await loadMyBookings();
                
            } catch (error) {
                hideLoading();
                CONFIG.error('å–æ¶ˆé ç´„å¤±æ•—', error);
                showMessage(error.message || 'å–æ¶ˆå¤±æ•—', 'error');
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatDateDisplay(dateString) {
            const date = new Date(dateString);
            const weekdays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${date.getFullYear()}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
        }
    </script>
</body>
</html>

