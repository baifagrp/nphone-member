<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é ç´„ - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
</head>
<body class="ds-page">
    <!-- é é¢é ­éƒ¨ -->
    <div class="ds-page-header">
        <h1 class="ds-page-title">æˆ‘çš„é ç´„</h1>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="ds-container">
        <!-- æ¨™ç±¤åˆ‡æ› -->
        <div class="ds-tabs">
            <button class="ds-tab active" data-filter="all">æ‰€æœ‰é ç´„</button>
            <button class="ds-tab" data-filter="upcoming">å³å°‡åˆ°ä¾†</button>
            <button class="ds-tab" data-filter="completed">å·²å®Œæˆ</button>
            <button class="ds-tab" data-filter="cancelled">å·²å–æ¶ˆ</button>
        </div>

        <!-- é ç´„åˆ—è¡¨ -->
        <div id="bookings-list">
            <!-- è¼‰å…¥ä¸­ -->
            <div class="ds-card ds-text-center" style="padding: var(--spacing-2xl);">
                <div class="loading-spinner"></div>
                <div style="margin-top: var(--spacing-md); color: var(--text-secondary);">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- æ–°å¢é ç´„æŒ‰éˆ• -->
        <div style="position: fixed; bottom: var(--spacing-xl); right: var(--spacing-xl); z-index: 50;">
            <button onclick="location.href='booking.html'" class="ds-btn ds-btn-primary" style="border-radius: var(--radius-full); width: 56px; height: 56px; padding: 0; box-shadow: var(--shadow-xl);">
                <span style="font-size: 24px;">+</span>
            </button>
        </div>
    </div>

    <!-- è¼‰å…¥ Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/checkout.js"></script>
    
    <script>
        let allBookings = [];
        let currentFilter = 'all';

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!Auth.requireMemberLogin()) {
                    return;
                }

                await Member.init();
                await loadBookings();

                // è¨­ç½®æ¨™ç±¤åˆ‡æ›
                setupTabs();
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
                UI.error('è¼‰å…¥é ç´„å¤±æ•—');
            }
        });

        // è¨­ç½®æ¨™ç±¤åˆ‡æ›
        function setupTabs() {
            const tabs = document.querySelectorAll('.ds-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // æ›´æ–°æ´»å‹•æ¨™ç±¤
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // éæ¿¾é ç´„
                    currentFilter = tab.dataset.filter;
                    filterBookings(currentFilter);
                });
            });
        }

        // è¼‰å…¥é ç´„
        async function loadBookings() {
            try {
                const memberData = Member.currentMember;
                if (!memberData?.line_user_id) {
                    throw new Error('ç„¡æ³•å–å¾—æœƒå“¡è³‡æ–™');
                }

                UI.showLoading('è¼‰å…¥é ç´„ä¸­...');
                allBookings = await BookingAPI.getMyBookings(memberData.line_user_id, 100);
                UI.hideLoading();

                filterBookings(currentFilter);
            } catch (error) {
                UI.hideLoading();
                CONFIG.error('è¼‰å…¥é ç´„å¤±æ•—', error);
                displayEmptyState('è¼‰å…¥é ç´„å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            }
        }

        // éæ¿¾é ç´„
        function filterBookings(filter) {
            let filteredBookings = allBookings;

            if (filter === 'upcoming') {
                filteredBookings = allBookings.filter(b => 
                    b.status === 'pending' || b.status === 'confirmed'
                );
            } else if (filter === 'completed') {
                filteredBookings = allBookings.filter(b => b.status === 'completed');
            } else if (filter === 'cancelled') {
                filteredBookings = allBookings.filter(b => b.status === 'cancelled');
            }

            displayBookings(filteredBookings);
        }

        // é¡¯ç¤ºé ç´„åˆ—è¡¨
        function displayBookings(bookings) {
            const container = document.getElementById('bookings-list');
            
            if (!bookings || bookings.length === 0) {
                displayEmptyState('å°šç„¡é ç´„è¨˜éŒ„');
                return;
            }

            container.innerHTML = bookings.map(booking => `
                <div class="ds-card ds-mb-md" style="cursor: pointer;" onclick="viewBookingDetail('${booking.id}')">
                    <div class="ds-flex-between ds-mb-md">
                        <div>
                            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: 4px;">
                                ${booking.service_name || 'æœªçŸ¥æœå‹™'}
                            </div>
                            ${booking.service_option_name ? `
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">
                                    ${booking.service_option_name}
                                </div>
                            ` : ''}
                        </div>
                        ${getStatusBadge(booking.status)}
                    </div>
                    
                    <div class="ds-flex" style="gap: var(--spacing-lg); flex-wrap: wrap; color: var(--text-secondary); font-size: var(--font-size-sm);">
                        <div class="ds-flex" style="gap: 4px; align-items: center;">
                            <span>ğŸ“…</span>
                            <span>${formatDate(booking.booking_date)}</span>
                        </div>
                        <div class="ds-flex" style="gap: 4px; align-items: center;">
                            <span>ğŸ•</span>
                            <span>${booking.booking_time?.substring(0, 5) || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="ds-flex" style="gap: 4px; align-items: center;">
                            <span>â±ï¸</span>
                            <span>${booking.service_duration || 0} åˆ†é˜</span>
                        </div>
                        <div class="ds-flex" style="gap: 4px; align-items: center;">
                            <span>ğŸ’°</span>
                            <span>NT$ ${booking.service_price || 0}</span>
                        </div>
                    </div>

                    ${booking.payment_status ? `
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--gray-200);">
                            ${getPaymentStatusBadge(booking.payment_status)}
                            ${booking.paid_amount ? `
                                <span style="margin-left: var(--spacing-sm); font-size: var(--font-size-sm); color: var(--text-secondary);">
                                    å·²ä»˜ NT$ ${booking.paid_amount}
                                </span>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${booking.notes ? `
                        <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background: var(--gray-50); border-radius: var(--radius-sm); font-size: var(--font-size-sm); color: var(--text-secondary);">
                            å‚™è¨»ï¼š${booking.notes}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // é¡¯ç¤ºç©ºç‹€æ…‹
        function displayEmptyState(message) {
            const container = document.getElementById('bookings-list');
            container.innerHTML = `
                <div class="ds-empty-state">
                    <div class="ds-empty-icon">ğŸ“…</div>
                    <div class="ds-empty-title">${message}</div>
                    <button onclick="location.href='booking.html'" class="ds-btn ds-btn-primary ds-mt-lg">
                        ç«‹å³é ç´„
                    </button>
                </div>
            `;
        }

        // å–å¾—ç‹€æ…‹å¾½ç« 
        function getStatusBadge(status) {
            const statusMap = {
                'pending': { text: 'å¾…ç¢ºèª', class: 'ds-badge-warning' },
                'confirmed': { text: 'å·²ç¢ºèª', class: 'ds-badge-success' },
                'completed': { text: 'å·²å®Œæˆ', class: 'ds-badge-info' },
                'cancelled': { text: 'å·²å–æ¶ˆ', class: 'ds-badge-error' }
            };
            
            const statusInfo = statusMap[status] || { text: status, class: 'ds-badge-primary' };
            return `<span class="ds-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        // å–å¾—ä»˜æ¬¾ç‹€æ…‹å¾½ç« 
        function getPaymentStatusBadge(status) {
            const statusMap = {
                'unpaid': { text: 'æœªä»˜æ¬¾', class: 'ds-badge-error' },
                'paid': { text: 'å·²ä»˜æ¬¾', class: 'ds-badge-success' },
                'partial': { text: 'éƒ¨åˆ†ä»˜æ¬¾', class: 'ds-badge-warning' },
                'refunded': { text: 'å·²é€€æ¬¾', class: 'ds-badge-info' }
            };
            
            const statusInfo = statusMap[status] || { text: status, class: 'ds-badge-primary' };
            return `<span class="ds-badge ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return 'æœªçŸ¥';
            const date = new Date(dateStr);
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = weekdays[date.getDay()];
            return `${month}æœˆ${day}æ—¥ (é€±${weekday})`;
        }

        // æŸ¥çœ‹é ç´„è©³æƒ…
        function viewBookingDetail(bookingId) {
            // å°å‘è©³æƒ…é é¢
            window.location.href = `booking-detail.html?id=${bookingId}`;
        }
    </script>
</body>
</html>
