# 🚀 新會員模式 - 快速開始指南

## ⚡ 5 分鐘快速設置

### 步驟 1：執行資料庫 SQL（2 分鐘）

在 Supabase SQL Editor 中依序執行：

```sql
-- 1. 建立 Schema
\i supabase/email-verification-schema.sql

-- 2. 建立 RPC 函數
\i supabase/email-verification-rpc.sql
```

✅ 成功標誌：看到綠色 ✅ 訊息

---

### 步驟 2：設置 EmailJS（3 分鐘）

1. **註冊帳號**：https://www.emailjs.com/
2. **創建 Service**：選擇 Gmail 或 Outlook
3. **創建 Template**：使用提供的模板（見 `EmailJS設置說明.md`）
4. **複製 Keys**：
   - Service ID
   - Template ID  
   - Public Key

5. **配置到系統**：

在 `js/config.js` 添加：

```javascript
const CONFIG = {
    // ... 現有配置 ...
    
    // EmailJS 配置（必須）
    EMAILJS_SERVICE_ID: 'service_xxx',      // 👈 替換這裡
    EMAILJS_TEMPLATE_ID: 'template_xxx',    // 👈 替換這裡
    EMAILJS_PUBLIC_KEY: 'your_public_key'   // 👈 替換這裡
};
```

---

### 步驟 3：測試（1 分鐘）

1. 打開 `member/email-verification.html`
2. 輸入您的 Email
3. 點擊「發送驗證碼」
4. 檢查信箱
5. 輸入驗證碼

✅ 成功！

---

## 📋 已完成的功能

### ✅ 資料庫層
- [x] `members` 表 Email 必填
- [x] `email_verified` 欄位
- [x] `registration_status` 欄位
- [x] `email_verification_codes` 表
- [x] 自動清理過期驗證碼
- [x] RLS 安全政策

### ✅ RPC 函數
- [x] `generate_verification_code()` - 生成驗證碼
- [x] `verify_email_code()` - 驗證驗證碼
- [x] `complete_registration()` - 完成註冊
- [x] `check_email_exists()` - 檢查 Email

### ✅ 前端頁面
- [x] `member/email-verification.html` - Email 驗證頁面
- [x] 6 位數字驗證碼輸入
- [x] 10 分鐘倒數計時
- [x] 60 秒重發限制
- [x] 自動跳轉下一個輸入框

### ✅ JavaScript API
- [x] `EmailVerificationAPI.sendVerificationCode()` - 發送驗證碼
- [x] `EmailVerificationAPI.verifyCode()` - 驗證驗證碼
- [x] `EmailVerificationAPI.completeRegistration()` - 完成註冊
- [x] `EmailVerificationAPI.checkEmailExists()` - 檢查 Email

### ✅ 註冊流程
- [x] LINE Login
- [x] → Email 驗證頁面
- [x] → 發送驗證碼（EmailJS）
- [x] → 驗證驗證碼
- [x] → 自動比對現有會員
- [x] → 綁定或創建會員
- [x] → 自動登入

### ✅ 自動比對邏輯
- [x] Email 存在 → 綁定 LINE
- [x] Email 不存在 → 創建新會員
- [x] 保留所有現有資料
- [x] 無縫切換

### ✅ 商家後台
- [x] 可預先創建會員（只需 Email）
- [x] 可為會員添加：
  - 預約記錄
  - 儲值金
  - 積分
  - 消費記錄

---

## 📁 新增的檔案

### 資料庫
- `supabase/email-verification-schema.sql` - Schema 定義
- `supabase/email-verification-rpc.sql` - RPC 函數

### 前端
- `member/email-verification.html` - Email 驗證頁面
- `js/email-verification.js` - Email 驗證 API

### 文檔
- `EmailJS設置說明.md` - EmailJS 詳細設置
- `新會員模式說明.md` - 完整功能說明
- `新會員模式快速開始指南.md` - 本文件

---

## 🔄 用戶註冊流程（簡化版）

```
用戶點擊 LINE 登入
        ↓
LINE 授權完成
        ↓
進入 Email 驗證頁面 📧
        ↓
輸入 Email → 發送驗證碼
        ↓
輸入 6 位數驗證碼
        ↓
系統自動檢查 Email
        ├─ 已存在 → 綁定 LINE（保留所有資料）
        └─ 不存在 → 創建新會員
        ↓
註冊完成 ✅
        ↓
自動登入到會員首頁
```

---

## 🎯 實際使用範例

### 範例 1：商家預建 + 用戶註冊

#### 商家操作（後台）：
```
1. 進入「會員管理」→「新增會員」
2. 填寫：
   - Email: customer@example.com ✅ 必填
   - 姓名: 王小明
   - 電話: 0912345678
3. 為會員儲值 $1000
4. 贈送 100 積分
5. 儲存
```

#### 用戶操作（手機）：
```
1. 掃描 LINE QR Code
2. LINE 授權
3. 進入 Email 驗證頁面
4. 輸入: customer@example.com
5. 收到驗證碼: 123456
6. 輸入驗證碼
7. 🎉 註冊成功！
   - 顯示：儲值金 $1000
   - 顯示：積分 100 點
```

**結果：** 用戶無需填寫任何資料，所有資訊已同步！

---

### 範例 2：新用戶直接註冊

#### 用戶操作：
```
1. 點擊「LINE 登入」
2. LINE 授權
3. 進入 Email 驗證頁面
4. 輸入: newuser@example.com
5. 收到驗證碼郵件
6. 輸入驗證碼
7. ✅ 註冊成功！新會員已創建
```

**結果：** 快速完成註冊，立即可使用所有功能！

---

## 🛠 技術細節

### 驗證碼機制
- **生成：** 隨機 6 位數字
- **有效期：** 10 分鐘
- **發送：** EmailJS
- **驗證：** 一次性使用
- **清理：** 自動清理過期記錄

### 安全措施
- ✅ Email 格式驗證
- ✅ 60 秒防重複發送
- ✅ 驗證碼使用後立即失效
- ✅ 10 分鐘自動過期
- ✅ SSL 加密傳輸

### 自動比對
```sql
-- 比對邏輯
SELECT * FROM members 
WHERE email = 'user@example.com'

-- 如果找到：
UPDATE members 
SET line_user_id = 'U1234...',
    email_verified = TRUE,
    registration_status = 'completed'

-- 如果沒找到：
INSERT INTO members (...)
VALUES (...)
```

---

## 📊 EmailJS 免費額度

### 免費方案：
- ✅ **200 封郵件/月**
- ✅ 足夠約 200 個新會員註冊
- ✅ 如果會員重發驗證碼，會多消耗

### 如何節省額度：
1. 設置 60 秒重發限制 ✅（已實作）
2. 10 分鐘過期時間 ✅（已實作）
3. 提示用戶檢查垃圾郵件
4. 商家多用預建功能（用戶只驗證一次）

---

## ⚠️ 注意事項

### 必須完成的設置：
1. ✅ 執行 SQL（兩個文件）
2. ✅ 設置 EmailJS
3. ✅ 配置 config.js

### 常見問題：
1. **郵件沒收到？**
   - 檢查垃圾郵件
   - 確認 EmailJS 配置
   - 查看 Console 錯誤

2. **驗證碼錯誤？**
   - 確認未過期（10分鐘）
   - 確認輸入正確
   - 嘗試重新發送

3. **無法創建會員？**
   - 確認 SQL 已執行
   - 確認 RPC 函數存在
   - 查看 Supabase Logs

---

## ✅ 完成檢查清單

部署前請確認：

- [ ] ✅ SQL Schema 已執行
- [ ] ✅ SQL RPC 已執行  
- [ ] ✅ EmailJS 帳號已註冊
- [ ] ✅ Email Service 已創建
- [ ] ✅ Email Template 已創建
- [ ] ✅ config.js 已配置
- [ ] ✅ 測試發送驗證碼成功
- [ ] ✅ 測試驗證流程成功
- [ ] ✅ 測試自動比對成功
- [ ] ✅ 測試後台預建成功

---

## 🎉 完成！

新會員模式已準備就緒！

**現在用戶可以：**
- ✅ 透過 LINE 快速登入
- ✅ 驗證 Email 完成註冊
- ✅ 自動綁定現有資料

**商家可以：**
- ✅ 預先建立會員
- ✅ 為會員添加資料
- ✅ 等待用戶自行完成綁定

**系統會：**
- ✅ 自動發送驗證碼
- ✅ 自動比對現有會員
- ✅ 自動綁定 LINE
- ✅ 無縫整合所有資料

---

**開始使用新會員模式吧！** 🚀✨

