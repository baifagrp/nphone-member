<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>儲值金與積分管理 - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .tab-container {
            border-bottom: 2px solid var(--color-gray-200);
            margin-bottom: 24px;
        }
        .tabs {
            display: flex;
            gap: 0;
        }
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: all 0.2s;
        }
        .tab:hover {
            color: var(--color-text-primary);
        }
        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--color-bg);
            border: 1px solid var(--color-gray-200);
            border-radius: var(--radius);
            padding: 20px;
        }
        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--color-text-primary);
        }
    </style>
</head>
<body>
    <!-- 導航列 -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">首頁</a>
                <a href="members.html" class="navbar-link">會員管理</a>
                <a href="bookings.html" class="navbar-link">預約管理</a>
                <a href="services.html" class="navbar-link">服務項目</a>
                <a href="checkout.html" class="navbar-link">結帳管理</a>
                <a href="wallet-points.html" class="navbar-link active">儲值金與積分</a>
                <a href="business-hours.html" class="navbar-link">營業時間</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">登出</button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container" style="margin-top: 40px;">
        <h1 style="font-size: 32px; font-weight: 700; margin-bottom: 32px;">儲值金與積分管理</h1>

        <!-- Tab 切換 -->
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('wallet')">儲值金</button>
                <button class="tab" onclick="switchTab('points')">積分</button>
            </div>
        </div>

        <!-- 儲值金 Tab -->
        <div id="wallet-tab" class="tab-content active">
            <!-- 統計卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">總儲值金額</div>
                    <div class="stat-value" id="wallet-total-recharged">NT$ 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">總消費金額</div>
                    <div class="stat-value" id="wallet-total-spent">NT$ 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">總餘額</div>
                    <div class="stat-value" id="wallet-total-balance">NT$ 0</div>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div style="margin-bottom: 24px;">
                <button class="btn btn-success" onclick="showRechargeForm()">+ 為會員儲值</button>
            </div>

            <!-- 儲值表單 -->
            <div id="recharge-form" class="card" style="margin-bottom: 24px; display: none;">
                <h2 style="font-size: 24px; margin-bottom: 24px;">為會員儲值</h2>
                <div class="form-group">
                    <label for="recharge-member" class="form-label required">選擇會員</label>
                    <select id="recharge-member" class="form-input" required>
                        <option value="">請選擇會員</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recharge-amount" class="form-label required">儲值金額</label>
                    <input type="number" id="recharge-amount" class="form-input" step="0.01" min="0.01" required placeholder="請輸入金額">
                </div>
                <div class="form-group">
                    <label for="recharge-description" class="form-label">備註</label>
                    <input type="text" id="recharge-description" class="form-input" placeholder="選填">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="submitRecharge()">確認儲值</button>
                    <button class="btn btn-secondary" onclick="hideRechargeForm()">取消</button>
                </div>
            </div>

            <!-- 會員列表 -->
            <div class="card">
                <div class="card-header">會員儲值金列表</div>
                <div class="card-body">
                    <div id="wallet-list">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 積分 Tab -->
        <div id="points-tab" class="tab-content">
            <!-- 統計卡片 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">總獲得積分</div>
                    <div class="stat-value" id="points-total-earned">0 點</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">總使用積分</div>
                    <div class="stat-value" id="points-total-spent">0 點</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">總餘額</div>
                    <div class="stat-value" id="points-total-balance">0 點</div>
                </div>
            </div>

            <!-- 操作按鈕 -->
            <div style="margin-bottom: 24px; display: flex; gap: 12px;">
                <button class="btn btn-success" onclick="showEarnPointsForm()">+ 添加積分</button>
                <button class="btn btn-warning" onclick="showSpendPointsForm()">- 扣除積分</button>
            </div>

            <!-- 添加積分表單 -->
            <div id="earn-points-form" class="card" style="margin-bottom: 24px; display: none;">
                <h2 style="font-size: 24px; margin-bottom: 24px;">添加積分</h2>
                <div class="form-group">
                    <label for="earn-member" class="form-label required">選擇會員</label>
                    <select id="earn-member" class="form-input" required>
                        <option value="">請選擇會員</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="earn-points" class="form-label required">積分數</label>
                    <input type="number" id="earn-points" class="form-input" min="1" required placeholder="請輸入積分">
                </div>
                <div class="form-group">
                    <label for="earn-description" class="form-label">備註</label>
                    <input type="text" id="earn-description" class="form-input" placeholder="選填">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="submitEarnPoints()">確認添加</button>
                    <button class="btn btn-secondary" onclick="hideEarnPointsForm()">取消</button>
                </div>
            </div>

            <!-- 扣除積分表單 -->
            <div id="spend-points-form" class="card" style="margin-bottom: 24px; display: none;">
                <h2 style="font-size: 24px; margin-bottom: 24px;">扣除積分</h2>
                <div class="form-group">
                    <label for="spend-member" class="form-label required">選擇會員</label>
                    <select id="spend-member" class="form-input" required>
                        <option value="">請選擇會員</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="spend-points" class="form-label required">積分數</label>
                    <input type="number" id="spend-points" class="form-input" min="1" required placeholder="請輸入積分">
                </div>
                <div class="form-group">
                    <label for="spend-description" class="form-label">備註</label>
                    <input type="text" id="spend-description" class="form-input" placeholder="選填">
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="submitSpendPoints()">確認扣除</button>
                    <button class="btn btn-secondary" onclick="hideSpendPointsForm()">取消</button>
                </div>
            </div>

            <!-- 會員列表 -->
            <div class="card">
                <div class="card-header">會員積分列表</div>
                <div class="card-body">
                    <div id="points-list">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/wallet-points.js"></script>
    
    <script>
        // 檢查管理員登入
        if (!Auth.requireAdminLogin()) {
            // requireAdminLogin 會自動導向
        }

        let allMembers = [];

        // Tab 切換
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            if (tab === 'wallet') {
                loadWallets();
            } else {
                loadPoints();
            }
        }

        // 載入會員列表
        async function loadMembers() {
            try {
                const result = await MemberAPI.getAll(1000, 0);
                allMembers = result.members || [];
                
                // 填充所有會員選擇器
                const memberSelects = ['recharge-member', 'earn-member', 'spend-member'];
                memberSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">請選擇會員</option>' + 
                            allMembers.map(m => 
                                `<option value="${m.id}">${m.name} (${m.phone || '無電話'})</option>`
                            ).join('');
                    }
                });
            } catch (error) {
                CONFIG.error('載入會員列表失敗', error);
                if (typeof UI !== 'undefined') {
                    UI.error('載入會員列表失敗');
                }
            }
        }

        // 載入儲值金列表
        async function loadWallets() {
            try {
                const wallets = await WalletPointsAPI.getAllWallets();
                
                // 計算統計
                let totalRecharged = 0;
                let totalSpent = 0;
                let totalBalance = 0;
                
                wallets.forEach(w => {
                    totalRecharged += parseFloat(w.total_recharged || 0);
                    totalSpent += parseFloat(w.total_spent || 0);
                    totalBalance += parseFloat(w.balance || 0);
                });
                
                document.getElementById('wallet-total-recharged').textContent = WalletPointsAPI.formatAmount(totalRecharged);
                document.getElementById('wallet-total-spent').textContent = WalletPointsAPI.formatAmount(totalSpent);
                document.getElementById('wallet-total-balance').textContent = WalletPointsAPI.formatAmount(totalBalance);
                
                // 顯示列表
                displayWallets(wallets);
            } catch (error) {
                CONFIG.error('載入儲值金列表失敗', error);
                document.getElementById('wallet-list').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #999;">載入失敗，請重新整理頁面</div>';
            }
        }

        // 顯示儲值金列表
        function displayWallets(wallets) {
            const container = document.getElementById('wallet-list');
            
            if (!wallets || wallets.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">尚無儲值金記錄</div>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>會員</th>
                            <th>電話</th>
                            <th>餘額</th>
                            <th>總儲值</th>
                            <th>總消費</th>
                            <th>最後更新</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${wallets.map(w => {
                            const member = w.members || {};
                            const updatedAt = new Date(w.updated_at).toLocaleDateString('zh-TW');
                            return `
                                <tr>
                                    <td>${member.name || '-'}</td>
                                    <td>${member.phone || '-'}</td>
                                    <td style="font-weight: 600; color: var(--color-primary);">${WalletPointsAPI.formatAmount(w.balance)}</td>
                                    <td>${WalletPointsAPI.formatAmount(w.total_recharged)}</td>
                                    <td>${WalletPointsAPI.formatAmount(w.total_spent)}</td>
                                    <td>${updatedAt}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // 載入積分列表
        async function loadPoints() {
            try {
                const points = await WalletPointsAPI.getAllPoints();
                
                // 計算統計
                let totalEarned = 0;
                let totalSpent = 0;
                let totalBalance = 0;
                
                points.forEach(p => {
                    totalEarned += parseInt(p.total_earned || 0);
                    totalSpent += parseInt(p.total_spent || 0);
                    totalBalance += parseInt(p.balance || 0);
                });
                
                document.getElementById('points-total-earned').textContent = WalletPointsAPI.formatPoints(totalEarned);
                document.getElementById('points-total-spent').textContent = WalletPointsAPI.formatPoints(totalSpent);
                document.getElementById('points-total-balance').textContent = WalletPointsAPI.formatPoints(totalBalance);
                
                // 顯示列表
                displayPoints(points);
            } catch (error) {
                CONFIG.error('載入積分列表失敗', error);
                document.getElementById('points-list').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: #999;">載入失敗，請重新整理頁面</div>';
            }
        }

        // 顯示積分列表
        function displayPoints(points) {
            const container = document.getElementById('points-list');
            
            if (!points || points.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">尚無積分記錄</div>';
                return;
            }

            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>會員</th>
                            <th>電話</th>
                            <th>餘額</th>
                            <th>總獲得</th>
                            <th>總使用</th>
                            <th>最後更新</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${points.map(p => {
                            const member = p.members || {};
                            const updatedAt = new Date(p.updated_at).toLocaleDateString('zh-TW');
                            return `
                                <tr>
                                    <td>${member.name || '-'}</td>
                                    <td>${member.phone || '-'}</td>
                                    <td style="font-weight: 600; color: var(--color-warning);">${WalletPointsAPI.formatPoints(p.balance)}</td>
                                    <td>${WalletPointsAPI.formatPoints(p.total_earned)}</td>
                                    <td>${WalletPointsAPI.formatPoints(p.total_spent)}</td>
                                    <td>${updatedAt}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // 儲值表單
        function showRechargeForm() {
            document.getElementById('recharge-form').style.display = 'block';
        }

        function hideRechargeForm() {
            document.getElementById('recharge-form').style.display = 'none';
            document.getElementById('recharge-member').value = '';
            document.getElementById('recharge-amount').value = '';
            document.getElementById('recharge-description').value = '';
        }

        async function submitRecharge() {
            try {
                const memberId = document.getElementById('recharge-member').value;
                const amount = parseFloat(document.getElementById('recharge-amount').value);
                const description = document.getElementById('recharge-description').value.trim() || null;

                if (!memberId || !amount || amount <= 0) {
                    if (typeof UI !== 'undefined') {
                        UI.warning('請填寫完整資訊');
                    }
                    return;
                }

                if (typeof UI !== 'undefined') {
                    UI.showLoading('儲值中...');
                }

                await WalletPointsAPI.rechargeWallet(memberId, amount, description);

                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.success('儲值成功！');
                }

                hideRechargeForm();
                await loadWallets();
            } catch (error) {
                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.error(error.message || '儲值失敗');
                }
            }
        }

        // 添加積分表單
        function showEarnPointsForm() {
            document.getElementById('earn-points-form').style.display = 'block';
        }

        function hideEarnPointsForm() {
            document.getElementById('earn-points-form').style.display = 'none';
            document.getElementById('earn-member').value = '';
            document.getElementById('earn-points').value = '';
            document.getElementById('earn-description').value = '';
        }

        async function submitEarnPoints() {
            try {
                const memberId = document.getElementById('earn-member').value;
                const points = parseInt(document.getElementById('earn-points').value);
                const description = document.getElementById('earn-description').value.trim() || null;

                if (!memberId || !points || points <= 0) {
                    if (typeof UI !== 'undefined') {
                        UI.warning('請填寫完整資訊');
                    }
                    return;
                }

                if (typeof UI !== 'undefined') {
                    UI.showLoading('添加積分中...');
                }

                await WalletPointsAPI.earnPoints(memberId, points, description);

                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.success('積分添加成功！');
                }

                hideEarnPointsForm();
                await loadPoints();
            } catch (error) {
                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.error(error.message || '添加積分失敗');
                }
            }
        }

        // 扣除積分表單
        function showSpendPointsForm() {
            document.getElementById('spend-points-form').style.display = 'block';
        }

        function hideSpendPointsForm() {
            document.getElementById('spend-points-form').style.display = 'none';
            document.getElementById('spend-member').value = '';
            document.getElementById('spend-points').value = '';
            document.getElementById('spend-description').value = '';
        }

        async function submitSpendPoints() {
            try {
                const memberId = document.getElementById('spend-member').value;
                const points = parseInt(document.getElementById('spend-points').value);
                const description = document.getElementById('spend-description').value.trim() || null;

                if (!memberId || !points || points <= 0) {
                    if (typeof UI !== 'undefined') {
                        UI.warning('請填寫完整資訊');
                    }
                    return;
                }

                if (typeof UI !== 'undefined') {
                    UI.showLoading('扣除積分中...');
                }

                await WalletPointsAPI.spendPoints(memberId, points, description);

                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.success('積分扣除成功！');
                }

                hideSpendPointsForm();
                await loadPoints();
            } catch (error) {
                if (typeof UI !== 'undefined') {
                    UI.hideLoading();
                    UI.error(error.message || '扣除積分失敗');
                }
            }
        }

        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await Admin.init();
                await loadMembers();
                await loadWallets();
            } catch (error) {
                CONFIG.error('初始化失敗', error);
            }
        });
    </script>
</body>
</html>

