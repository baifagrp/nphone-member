<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå‹™é …ç›®ç®¡ç†</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">é¦–é </a>
                <a href="members.html" class="navbar-link">æœƒå“¡ç®¡ç†</a>
                <a href="bookings.html" class="navbar-link">é ç´„ç®¡ç†</a>
                <a href="services.html" class="navbar-link">æœå‹™é …ç›®</a>
                <a href="checkout.html" class="navbar-link">çµå¸³ç®¡ç†</a>
                <a href="business-hours.html" class="navbar-link">ç‡Ÿæ¥­æ™‚é–“</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container" style="margin-top: 40px;">
        <div class="flex-between" style="margin-bottom: 24px;">
            <h1 style="font-size: 32px; font-weight: 700;">æœå‹™é …ç›®ç®¡ç†</h1>
            <button id="btn-new-service" class="btn btn-success">+ æ–°å¢æœå‹™</button>
        </div>
        
        <!-- æœå‹™åˆ—è¡¨ -->
        <div id="services-list">
            <div class="card">
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯æœå‹™ Modal -->
    <div id="service-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" id="modal-title">æ–°å¢æœå‹™</div>
            <div class="card-body">
                <form id="form-service">
                    <div class="form-group">
                        <label for="service-name" class="form-label required">æœå‹™åç¨±</label>
                        <input type="text" id="service-name" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-description" class="form-label">æœå‹™æè¿°</label>
                        <textarea id="service-description" class="form-textarea" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-duration" class="form-label required">æœå‹™æ™‚é•·ï¼ˆåˆ†é˜ï¼‰</label>
                        <input type="number" id="service-duration" class="form-input" required min="1" value="60">
                    </div>
                    
                    <div class="form-group">
                        <label for="service-price" class="form-label required">åŸºç¤åƒ¹æ ¼</label>
                        <input type="number" id="service-price" class="form-input" required min="0" step="0.01" value="0">
                        <div class="form-help">åŸºç¤åƒ¹æ ¼ï¼ˆå¦‚æœæœå‹™æœ‰é¸é …ï¼Œé¸é …åƒ¹æ ¼æœƒåŠ åœ¨æ­¤åŸºç¤ä¸Šï¼‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="service-has-options" onchange="toggleServiceOptions()"> æ­¤æœå‹™éœ€è¦é¸æ“‡å­é …ï¼ˆä¾‹å¦‚ï¼šæ‰‹æ©Ÿå‹è™Ÿï¼‰
                        </label>
                    </div>
                    
                    <div id="service-options-section" style="display: none; margin-top: 24px; padding: 16px; background: #F5F5F7; border-radius: 8px;">
                        <div class="form-group">
                            <label for="service-option-label" class="form-label">é¸é …æ¨™ç±¤</label>
                            <input type="text" id="service-option-label" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ‰‹æ©Ÿå‹è™Ÿ">
                            <div class="form-help">é¡¯ç¤ºåœ¨é¸é …é¸æ“‡é é¢çš„æ¨™ç±¤</div>
                        </div>
                        
                        <div style="margin-top: 16px;">
                            <label class="form-label">æœå‹™é¸é …åˆ—è¡¨</label>
                            <div id="service-options-list" style="margin-top: 8px;"></div>
                            <button type="button" id="btn-add-option" class="btn btn-sm btn-primary" style="margin-top: 12px;">+ æ–°å¢é¸é …</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="service-sort-order" class="form-label">æ’åºé †åº</label>
                        <input type="number" id="service-sort-order" class="form-input" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="service-is-active" checked> å•Ÿç”¨æ­¤æœå‹™
                        </label>
                    </div>
                    
                    <div class="flex flex-gap" style="margin-top: 24px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">å„²å­˜</button>
                        <button type="button" id="btn-cancel-modal" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    
    <script>
        let editingServiceId = null;
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await Admin.init();
                await loadServices();
            } catch (error) {
                CONFIG.error('åˆå§‹åŒ–å¤±æ•—', error);
            }
        });
        
        // è¼‰å…¥æœå‹™åˆ—è¡¨
        async function loadServices() {
            try {
                const services = await BookingAPI.getAllServices();
                
                if (services.length === 0) {
                    document.getElementById('services-list').innerHTML = `
                        <div class="card">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                å°šç„¡æœå‹™é …ç›®
                            </div>
                        </div>
                    `;
                    return;
                }
                
                document.getElementById('services-list').innerHTML = services.map(service => `
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="flex-between">
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 8px;">
                                    ${service.name}
                                    ${!service.is_active ? '<span class="status-badge status-gray">å·²åœç”¨</span>' : ''}
                                </h3>
                                ${service.description ? `<p style="color: #86868B; margin-bottom: 12px;">${service.description}</p>` : ''}
                                <div style="display: flex; gap: 16px; color: #666; font-size: 14px;">
                                    <span>â± ${service.duration} åˆ†é˜</span>
                                    <span>ğŸ’° NT$ ${(service.base_price || service.price || 0).toLocaleString()}</span>
                                    ${service.has_options ? `<span>ğŸ“± æœ‰é¸é … (${service.option_label || 'é¸é …'})</span>` : ''}
                                    <span>ğŸ“Š æ’åº: ${service.sort_order}</span>
                                </div>
                                ${service.service_options && service.service_options.length > 0 ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #F5F5F7; border-radius: 8px; font-size: 13px;">
                                        <strong>é¸é …ï¼š</strong>
                                        ${service.service_options.filter(opt => opt.is_active !== false).map(opt => opt.name).join('ã€')}
                                    </div>
                                ` : ''}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-primary" onclick="editService('${service.id}')">ç·¨è¼¯</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteService('${service.id}', '${service.name}')" style="margin-left: 8px;">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™å¤±æ•—', error);
            }
        }
        
        // æ–°å¢æœå‹™
        document.getElementById('btn-new-service').addEventListener('click', () => {
            editingServiceId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢æœå‹™';
            document.getElementById('form-service').reset();
            document.getElementById('service-is-active').checked = true;
            document.getElementById('service-has-options').checked = false;
            serviceOptions = [];
            toggleServiceOptions();
            renderServiceOptionsList();
            document.getElementById('service-modal').style.display = 'flex';
        });
        
        // ç·¨è¼¯æœå‹™
        async function editService(serviceId) {
            try {
                const service = await BookingAPI.getServiceById(serviceId);
                editingServiceId = serviceId;
                
                document.getElementById('modal-title').textContent = 'ç·¨è¼¯æœå‹™';
                document.getElementById('service-name').value = service.name;
                document.getElementById('service-description').value = service.description || '';
                document.getElementById('service-duration').value = service.duration;
                document.getElementById('service-price').value = service.base_price || service.price || 0;
                document.getElementById('service-sort-order').value = service.sort_order;
                document.getElementById('service-is-active').checked = service.is_active;
                document.getElementById('service-has-options').checked = service.has_options || false;
                document.getElementById('service-option-label').value = service.option_label || '';
                
                // é¡¯ç¤º/éš±è—é¸é …å€åŸŸ
                toggleServiceOptions();
                
                // è¼‰å…¥æœå‹™é¸é …
                if (service.has_options && service.service_options) {
                    loadServiceOptionsInModal(service.service_options);
                }
                
                document.getElementById('service-modal').style.display = 'flex';
            } catch (error) {
                CONFIG.error('è¼‰å…¥æœå‹™å¤±æ•—', error);
                showMessage('è¼‰å…¥æœå‹™å¤±æ•—', 'error');
            }
        }
        
        // åˆªé™¤æœå‹™
        async function deleteService(serviceId, serviceName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æœå‹™ã€Œ${serviceName}ã€å—ï¼Ÿ\nåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼`)) {
                return;
            }
            
            try {
                await BookingAPI.deleteService(serviceId);
                showMessage('æœå‹™å·²åˆªé™¤', 'success');
                await loadServices();
            } catch (error) {
                CONFIG.error('åˆªé™¤æœå‹™å¤±æ•—', error);
                showMessage('åˆªé™¤å¤±æ•—', 'error');
            }
        }
        
        // å„²å­˜æœå‹™
        document.getElementById('form-service').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const serviceData = {
                name: document.getElementById('service-name').value.trim(),
                description: document.getElementById('service-description').value.trim() || null,
                duration: parseInt(document.getElementById('service-duration').value),
                base_price: parseFloat(document.getElementById('service-price').value),
                has_options: document.getElementById('service-has-options').checked,
                option_label: document.getElementById('service-option-label').value.trim() || null,
                sort_order: parseInt(document.getElementById('service-sort-order').value) || 0,
                is_active: document.getElementById('service-is-active').checked,
            };
            
            try {
                showLoading('å„²å­˜ä¸­...');
                
                let savedService;
                if (editingServiceId) {
                    savedService = await BookingAPI.updateService(editingServiceId, serviceData);
                    showMessage('æœå‹™æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    savedService = await BookingAPI.createService(serviceData);
                    showMessage('æœå‹™æ–°å¢æˆåŠŸ', 'success');
                }
                
                // å¦‚æœæœå‹™æœ‰é¸é …ï¼Œå„²å­˜é¸é …
                if (serviceData.has_options && serviceOptions.length > 0) {
                    const serviceId = savedService.id;
                    
                    // åˆªé™¤èˆŠçš„é¸é …ï¼ˆå¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼‰
                    if (editingServiceId) {
                        // é€™è£¡å¯ä»¥é¸æ“‡åˆªé™¤æ‰€æœ‰èˆŠé¸é …å¾Œé‡æ–°å»ºç«‹ï¼Œæˆ–é€²è¡Œå·®ç•°æ›´æ–°
                        // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆä¸è™•ç†åˆªé™¤ï¼Œåªæ–°å¢æ–°é¸é …
                    }
                    
                    // æ–°å¢æ‰€æœ‰é¸é …
                    for (const option of serviceOptions) {
                        if (option.id) {
                            // æ›´æ–°ç¾æœ‰é¸é …
                            await BookingAPI.updateServiceOption(option.id, {
                                name: option.name,
                                price_modifier: option.price_modifier,
                                is_active: option.is_active,
                                sort_order: option.sort_order,
                            });
                        } else {
                            // æ–°å¢æ–°é¸é …
                            await BookingAPI.createServiceOption(serviceId, {
                                name: option.name,
                                price_modifier: option.price_modifier,
                                is_active: option.is_active,
                                sort_order: option.sort_order,
                            });
                        }
                    }
                }
                
                hideLoading();
                document.getElementById('service-modal').style.display = 'none';
                serviceOptions = [];
                await loadServices();
            } catch (error) {
                hideLoading();
                CONFIG.error('å„²å­˜æœå‹™å¤±æ•—', error);
                showMessage('å„²å­˜å¤±æ•—', 'error');
            }
        });
        
        // åˆ‡æ›æœå‹™é¸é …å€åŸŸé¡¯ç¤º
        function toggleServiceOptions() {
            const hasOptions = document.getElementById('service-has-options').checked;
            document.getElementById('service-options-section').style.display = hasOptions ? 'block' : 'none';
        }
        
        // æœå‹™é¸é …åˆ—è¡¨
        let serviceOptions = [];
        
        // è¼‰å…¥æœå‹™é¸é …åˆ° Modal
        function loadServiceOptionsInModal(options) {
            serviceOptions = options || [];
            renderServiceOptionsList();
        }
        
        // é¡¯ç¤ºæœå‹™é¸é …åˆ—è¡¨
        function renderServiceOptionsList() {
            const container = document.getElementById('service-options-list');
            if (serviceOptions.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 14px;">å°šç„¡é¸é …ï¼Œè«‹é»æ“Šã€Œæ–°å¢é¸é …ã€</p>';
                return;
            }
            
            container.innerHTML = serviceOptions.map((opt, index) => `
                <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${opt.name}</strong>
                        ${opt.price_modifier ? `<span style="color: #007AFF; margin-left: 8px;">${opt.price_modifier > 0 ? '+' : ''}NT$ ${opt.price_modifier}</span>` : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeServiceOption(${index})">åˆªé™¤</button>
                </div>
            `).join('');
        }
        
        // æ–°å¢æœå‹™é¸é …
        document.getElementById('btn-add-option').addEventListener('click', () => {
            const name = prompt('è«‹è¼¸å…¥é¸é …åç¨±ï¼ˆä¾‹å¦‚ï¼šiPhone 15 Proï¼‰ï¼š');
            if (!name) return;
            
            const priceText = prompt('åƒ¹æ ¼èª¿æ•´ï¼ˆå¯é¸ï¼Œä¾‹å¦‚ï¼š+200 æˆ– -100ï¼Œç›´æ¥æŒ‰ç¢ºå®šå‰‡ç‚º 0ï¼‰ï¼š', '0');
            const priceModifier = parseFloat(priceText) || 0;
            
            serviceOptions.push({
                id: null, // æ–°é¸é …æ²’æœ‰ ID
                name: name.trim(),
                price_modifier: priceModifier,
                is_active: true,
                sort_order: serviceOptions.length,
            });
            
            renderServiceOptionsList();
        });
        
        // ç§»é™¤æœå‹™é¸é …
        function removeServiceOption(index) {
            serviceOptions.splice(index, 1);
            renderServiceOptionsList();
        }
        
        // é—œé–‰ Modal
        document.getElementById('btn-cancel-modal').addEventListener('click', () => {
            document.getElementById('service-modal').style.display = 'none';
            serviceOptions = [];
        });
        
        // åˆå§‹åŒ–é¸é …å€åŸŸ
        document.getElementById('btn-new-service').addEventListener('click', () => {
            serviceOptions = [];
            renderServiceOptionsList();
        });
    </script>
</body>
</html>

