<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新增預約 - NPHONE</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <link rel="stylesheet" href="../css/admin-enhancements.css">
    <link rel="stylesheet" href="../css/animations.css">
</head>
<body class="ds-page">
    <!-- 導航列 -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="dashboard.html" class="navbar-brand">NPHONE 管理後台</a>
            <div class="navbar-menu">
                <a href="dashboard.html" class="navbar-link">儀表板</a>
                <a href="members.html" class="navbar-link">會員管理</a>
                <a href="services.html" class="navbar-link">服務管理</a>
                <a href="bookings.html" class="navbar-link active">預約管理</a>
                <a href="checkout.html" class="navbar-link">結帳管理</a>
                <a href="business-hours.html" class="navbar-link">營業時間</a>
                <a href="wallet-points.html" class="navbar-link">儲值/積分</a>
                <button id="btn-admin-logout" class="btn btn-sm btn-secondary">登出</button>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="container" style="margin-top: 40px;">
        <h1 class="page-title ds-mb-lg">新增預約</h1>
        
        <!-- 新增預約表單 -->
        <div class="ds-card">
            <div class="ds-card-body">
            <!-- 會員選擇 -->
            <div class="ds-form-group">
                <label for="member-select" class="ds-form-label">選擇會員 <span class="ds-text-error">*</span></label>
                <select id="member-select" class="ds-form-input" required>
                    <option value="">請選擇會員</option>
                </select>
            </div>
            
            <!-- 服務選擇 -->
            <div class="ds-form-group">
                <label for="service-select" class="ds-form-label">選擇服務 <span class="ds-text-error">*</span></label>
                <select id="service-select" class="ds-form-input" required>
                    <option value="">請選擇服務</option>
                </select>
                <div id="service-options-container" class="ds-mt-sm" style="display: none;">
                    <label class="ds-form-label">服務選項</label>
                    <select id="service-option-select" class="ds-form-input">
                        <option value="">不需要選項</option>
                    </select>
                </div>
                <div id="service-preview" class="ds-info-box ds-mt-sm" style="display: none;">
                    <!-- 動態載入服務詳情 -->
                </div>
            </div>
            
            <!-- 日期選擇 -->
            <div class="ds-form-group">
                <label for="booking-date" class="ds-form-label">預約日期 <span class="ds-text-error">*</span></label>
                <input 
                    type="date" 
                    id="booking-date" 
                    class="ds-form-input" 
                    required
                    min=""
                >
            </div>
            
            <!-- 時間選擇 -->
            <div class="ds-form-group">
                <label for="booking-time" class="ds-form-label">預約時間 <span class="ds-text-error">*</span></label>
                <select id="booking-time" class="ds-form-input" required>
                    <option value="">請選擇時間</option>
                </select>
            </div>
            
            <!-- 備註 -->
            <div class="ds-form-group">
                <label for="booking-notes" class="ds-form-label">備註（選填）</label>
                <textarea 
                    id="booking-notes" 
                    class="ds-form-input" 
                    rows="3"
                    placeholder="如有特殊需求或備註，請在此填寫"
                ></textarea>
            </div>
            
            <!-- 管理員備註 -->
            <div class="ds-form-group">
                <label for="admin-notes" class="ds-form-label">管理員備註（選填）</label>
                <textarea 
                    id="admin-notes" 
                    class="ds-form-input" 
                    rows="3"
                    placeholder="僅管理員可見的備註"
                ></textarea>
            </div>
            </div>
            
            <!-- 按鈕 -->
            <div class="ds-card-footer">
                <a href="bookings.html" class="ds-btn ds-btn-secondary">取消</a>
                <button id="btn-submit-booking" class="ds-btn ds-btn-primary">建立預約</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/supabase-client.js"></script>
    <script src="../js/ui-utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/member.js"></script>
    <script src="../js/admin.js"></script>
    <script src="../js/booking.js"></script>
    <script src="../js/animation-utils.js"></script>
    
    <script>
        let allMembers = [];
        let allServices = [];
        let selectedService = null;
        let selectedServiceOption = null;
        let availableTimeSlots = [];
        
        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if (!Auth.requireAdminLogin()) {
                    return;
                }
                
                // 設定日期最小值為今天
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('booking-date').min = today;
                
                await loadMembers();
                await loadServices();
                
                // 綁定事件
                setupEventListeners();
                
            } catch (error) {
                CONFIG.error('初始化失敗', error);
            }
        });
        
        // 設定事件監聽器
        function setupEventListeners() {
            // 服務選擇變更
            document.getElementById('service-select').addEventListener('change', async (e) => {
                const serviceId = e.target.value;
                if (serviceId) {
                    await handleServiceChange(serviceId);
                    // 如果已經選擇了日期，重新載入時間段
                    const selectedDate = document.getElementById('booking-date').value;
                    if (selectedDate) {
                        await loadAvailableTimeSlots(selectedDate);
                    }
                } else {
                    document.getElementById('service-options-container').style.display = 'none';
                    document.getElementById('service-preview').style.display = 'none';
                    document.getElementById('booking-time').innerHTML = '<option value="">請先選擇服務</option>';
                    selectedService = null;
                }
            });
            
            // 服務選項變更
            document.getElementById('service-option-select').addEventListener('change', (e) => {
                const optionId = e.target.value;
                if (optionId && selectedService) {
                    selectedServiceOption = selectedService.service_options.find(opt => opt.id === optionId);
                    updateServicePreview();
                } else {
                    selectedServiceOption = null;
                    updateServicePreview();
                }
            });
            
            // 日期選擇變更
            document.getElementById('booking-date').addEventListener('change', async (e) => {
                const date = e.target.value;
                if (date) {
                    await loadAvailableTimeSlots(date);
                }
            });
            
            // 提交預約
            document.getElementById('btn-submit-booking').addEventListener('click', async () => {
                await submitBooking();
            });
        }
        
        // 載入會員列表
        async function loadMembers() {
            try {
                const result = await MemberAPI.getAll(1000, 0);
                allMembers = result.members || [];
                
                const memberSelect = document.getElementById('member-select');
                memberSelect.innerHTML = '<option value="">請選擇會員</option>' +
                    allMembers.map(member => `
                        <option value="${member.line_user_id}">${member.name} (${member.phone || '無電話'})</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('載入會員列表失敗', error);
                showMessage('載入會員列表失敗', 'error');
            }
        }
        
        // 載入服務列表
        async function loadServices() {
            try {
                allServices = await BookingAPI.getActiveServices();
                
                const serviceSelect = document.getElementById('service-select');
                serviceSelect.innerHTML = '<option value="">請選擇服務</option>' +
                    allServices.map(service => `
                        <option value="${service.id}">${service.name} - NT$ ${(service.base_price || service.price || 0).toLocaleString()}</option>
                    `).join('');
                
            } catch (error) {
                CONFIG.error('載入服務列表失敗', error);
                showMessage('載入服務列表失敗', 'error');
            }
        }
        
        // 處理服務選擇變更
        async function handleServiceChange(serviceId) {
            selectedService = allServices.find(s => s.id === serviceId);
            if (!selectedService) return;
            
            // 顯示服務選項
            if (selectedService.has_options && selectedService.service_options && selectedService.service_options.length > 0) {
                const optionSelect = document.getElementById('service-option-select');
                optionSelect.innerHTML = '<option value="">不需要選項</option>' +
                    selectedService.service_options.map(option => `
                        <option value="${option.id}">${option.name} (+NT$ ${option.price_modifier || 0})</option>
                    `).join('');
                document.getElementById('service-options-container').style.display = 'block';
            } else {
                document.getElementById('service-options-container').style.display = 'none';
            }
            
            updateServicePreview();
        }
        
        // 更新服務預覽
        function updateServicePreview() {
            if (!selectedService) return;
            
            const preview = document.getElementById('service-preview');
            const basePrice = selectedService.base_price || selectedService.price || 0;
            const optionModifier = selectedServiceOption ? (selectedServiceOption.price_modifier || 0) : 0;
            const finalPrice = basePrice + optionModifier;
            
            preview.style.display = 'block';
            preview.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                    <div>
                        <div style="color: #86868B; font-size: 12px;">服務</div>
                        <div style="font-weight: 600;">${selectedService.name}</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">時長</div>
                        <div style="font-weight: 600;">${selectedService.duration} 分鐘</div>
                    </div>
                    <div>
                        <div style="color: #86868B; font-size: 12px;">價格</div>
                        <div style="font-weight: 600; font-size: 18px; color: #007AFF;">NT$ ${finalPrice.toLocaleString()}</div>
                    </div>
                </div>
            `;
        }
        
        // 載入可用時間段
        async function loadAvailableTimeSlots(date) {
            try {
                // 需要先選擇服務才能載入時間段（因為需要服務時長）
                if (!selectedService) {
                    document.getElementById('booking-time').innerHTML = '<option value="">請先選擇服務</option>';
                    return;
                }
                
                const serviceDuration = selectedService.duration || 60;
                const timeSlots = await BookingAPI.getAvailableTimeSlots(date, serviceDuration);
                availableTimeSlots = timeSlots;
                
                const timeSelect = document.getElementById('booking-time');
                if (!timeSlots || timeSlots.length === 0) {
                    timeSelect.innerHTML = '<option value="">當日無可用時間</option>';
                } else {
                    timeSelect.innerHTML = '<option value="">請選擇時間</option>' +
                        timeSlots.map(slot => `
                            <option value="${slot.time_slot || slot}">${slot.time_slot || slot}</option>
                        `).join('');
                }
                
            } catch (error) {
                CONFIG.error('載入可用時間失敗', error);
                showMessage('載入可用時間失敗：' + (error.message || '未知錯誤'), 'error');
                document.getElementById('booking-time').innerHTML = '<option value="">載入失敗</option>';
            }
        }
        
        // 提交預約
        async function submitBooking() {
            try {
                const memberLineUserId = document.getElementById('member-select').value;
                const serviceId = document.getElementById('service-select').value;
                const serviceOptionId = document.getElementById('service-option-select').value || null;
                const bookingDate = document.getElementById('booking-date').value;
                const bookingTime = document.getElementById('booking-time').value;
                const notes = document.getElementById('booking-notes').value.trim() || null;
                const adminNotes = document.getElementById('admin-notes').value.trim() || null;
                
                // 驗證
                if (!memberLineUserId) {
                    showMessage('請選擇會員', 'error');
                    return;
                }
                
                if (!serviceId) {
                    showMessage('請選擇服務', 'error');
                    return;
                }
                
                if (!bookingDate) {
                    showMessage('請選擇預約日期', 'error');
                    return;
                }
                
                if (!bookingTime) {
                    showMessage('請選擇預約時間', 'error');
                    return;
                }
                
                showLoading('建立預約中...');
                
                const booking = await BookingAPI.createBooking(
                    memberLineUserId,
                    serviceId,
                    bookingDate,
                    bookingTime,
                    serviceOptionId,
                    notes
                );
                
                // 如果有管理員備註，更新預約
                if (adminNotes) {
                    await BookingAPI.updateBookingStatus(booking.id, booking.status, adminNotes);
                }
                
                showMessage('預約建立成功！', 'success');
                
                // 延遲後返回預約列表
                setTimeout(() => {
                    window.location.href = 'bookings.html';
                }, 1500);
                
            } catch (error) {
                CONFIG.error('建立預約失敗', error);
                showMessage(error.message || '建立預約失敗', 'error');
            }
        }
        
        // 顯示訊息（使用新的 UI 工具）
        function showMessage(message, type = 'info') {
            if (typeof UI !== 'undefined') {
                UI.showToast(message, type);
            } else {
                // 後備方案
                if (type === 'error') {
                    alert('❌ ' + message);
                } else if (type === 'success') {
                    alert('✅ ' + message);
                } else {
                    alert(message);
                }
            }
        }
        
        // 顯示載入狀態
        function showLoading(message) {
            if (typeof UI !== 'undefined') {
                UI.showLoading(message);
            }
        }
        
        // 隱藏載入狀態
        function hideLoading() {
            if (typeof UI !== 'undefined') {
                UI.hideLoading();
            }
        }
    </script>
</body>
</html>

